{
  "fromdjango.core.mailimportsend_mass_mail\r\nfromdjango.db.modelsimportQ\r\nfromdjango.httpimportHttpResponseBadRequest,HttpResponseNotAllowed\r\nfromdjango.shortcutsimportrender,redirect,get_object_or_404\r\nfromdjango.templateimportContext,Template\r\nfromdjango.views.decorators.httpimportrequire_POST\r\n\r\nfromaccount.decoratorsimportlogin_required\r\n\r\n#@@@switchtopinax-teams\r\nfromsymposion.teams.modelsimportTeam\r\n\r\nfromsymposion.confimportsettings\r\nfromsymposion.proposals.modelsimportProposalBase,ProposalSection\r\nfromsymposion.utils.mailimportsend_email\r\n\r\nfromsymposion.reviews.formsimportReviewForm,SpeakerCommentForm\r\nfromsymposion.reviews.formsimportBulkPresentationForm\r\nfromsymposion.reviews.formsimportStaffCommentForm\r\nfromsymposion.reviews.modelsimport(\r\nReviewAssignment,Review,LatestVote,ProposalResult,NotificationTemplate,\r\nResultNotification\r\n)\r\n\r\n\r\ndefproposals_generator(request,queryset,user_pk=None,check_speaker=True):\r\n\r\nforobjinqueryset:\r\n#@@@thissucks;wecandobetter\r\nifcheck_speaker:\r\nifrequest.userin[s.userforsinobj.speakers()]:\r\ncontinue\r\n\r\ntry:\r\nobj.result\r\nexceptProposalResult.DoesNotExist:\r\nProposalResult.objects.get_or_create(proposal=obj)\r\n\r\nobj.comment_count=obj.result.comment_count\r\nobj.total_votes=obj.result.vote_count\r\nobj.plus_one=obj.result.plus_one\r\nobj.plus_zero=obj.result.plus_zero\r\nobj.minus_zero=obj.result.minus_zero\r\nobj.minus_one=obj.result.minus_one\r\nlookup_params=dict(proposal=obj)\r\n\r\nifuser_pk:\r\nlookup_params[\"\"]=user_pk\r\nelse:\r\nlookup_params[\"\"]=request.user\r\n\r\ntry:\r\nobj.user_vote=LatestVote.objects.get(**lookup_params).vote\r\nobj.user_vote_css=LatestVote.objects.get(**lookup_params).css_class()\r\nexceptLatestVote.DoesNotExist:\r\nobj.user_vote=None\r\nobj.user_vote_css=\"\"\r\n\r\nyieldobj\r\n\r\ndefaccess_not_permitted(request,error_message):\r\nreturnrender(request,\"\",error_message)\r\n\r\n\r\n#Returnsalistofallproposals,proposalsreviewedbytheuser,ortheproposalstheuserhas\r\n#yettoreviewdependingonthelinkuserclicksindashboard\r\n@login_required\r\ndefreview_section(request_review,section_slug,assigned=False,reviewed=\"\"):\r\n\r\nifnotrequest_review.user.has_perm(\"\"%section_slug):\r\nreturnaccess_not_permitted(": [
    [
      -0.00280199404722671,
      [
        "<STR_LIT>",
        ",",
        "request",
        "_",
        "review",
        ",",
        "section",
        "_",
        "slug",
        ")",
        "<endofline>"
      ]
    ],
    [
      -0.002913046029027678,
      [
        "user",
        "_",
        "pk",
        "=",
        "request",
        "_",
        "review",
        ".",
        "user",
        ".",
        "pk",
        ")",
        "<endofline>"
      ]
    ],
    [
      -0.003157541852377126,
      [
        "request",
        ",",
        "request",
        "_",
        "review",
        ",",
        "section",
        "_",
        "slug",
        ")",
        "<endofline>"
      ]
    ],
    [
      -0.0033853644567835455,
      [
        "request",
        "_",
        "review",
        ",",
        "request",
        "_",
        "review",
        ",",
        "section",
        "_",
        "slug",
        ")",
        "<endofline>"
      ]
    ],
    [
      -0.00338797734969664,
      [
        "None",
        ",",
        "request",
        "_",
        "review",
        ",",
        "section",
        "_",
        "slug",
        ")",
        "<endofline>"
      ]
    ],
    [
      -0.003595337504640589,
      [
        "request",
        ",",
        "request",
        "_",
        "review",
        ",",
        "section",
        "_",
        "slug",
        ",",
        "assigned",
        ",",
        "reviewed",
        ")",
        "<endofline>"
      ]
    ],
    [
      -0.0036768700148364143,
      [
        "request",
        "_",
        "review",
        ",",
        "section",
        "_",
        "slug",
        ")",
        "<endofline>"
      ]
    ],
    [
      -0.0037321108032048788,
      [
        "request",
        ",",
        "request",
        "_",
        "review",
        ",",
        "section",
        "_",
        "slug",
        ",",
        "assigned",
        ")",
        "<endofline>"
      ]
    ],
    [
      -0.0038290901926745498,
      [
        "None",
        ",",
        "request",
        "_",
        "review",
        ",",
        "section",
        "_",
        "slug",
        ",",
        "assigned",
        ")",
        "<endofline>"
      ]
    ],
    [
      -0.003861693044720483,
      [
        "<STR_LIT>",
        ",",
        "request",
        "_",
        "review",
        ",",
        "section",
        "_",
        "slug",
        ",",
        "assigned",
        ")",
        "<endofline>"
      ]
    ],
    [
      -0.0038784897740212045,
      [
        "None",
        ",",
        "request",
        "_",
        "review",
        ",",
        "section",
        "_",
        "slug",
        ",",
        "assigned",
        ",",
        "reviewed",
        ")",
        "<endofline>"
      ]
    ],
    [
      -0.004672663018513443,
      [
        "<STR_LIT>",
        ",",
        "request",
        "_",
        "review",
        ",",
        "section",
        "_",
        "slug",
        ",",
        "assigned",
        ",",
        "reviewed",
        ",",
        "<STR_LIT>",
        ")",
        "<endofline>"
      ]
    ],
    [
      -0.00469746123638881,
      [
        "request",
        ",",
        "request",
        "_",
        "review",
        ",",
        "section",
        "_",
        "slug",
        ",",
        "assigned",
        ",",
        "reviewed",
        ",",
        "<STR_LIT>",
        ")",
        "<endofline>"
      ]
    ],
    [
      -0.004756280012921326,
      [
        "None",
        ",",
        "request",
        "_",
        "review",
        ",",
        "section",
        "_",
        "slug",
        ",",
        "assigned",
        ",",
        "reviewed",
        ",",
        "<STR_LIT>",
        ")",
        "<endofline>"
      ]
    ],
    [
      -0.004996745896058887,
      [
        "request",
        "_",
        "review",
        ",",
        "<STR_LIT>",
        ")",
        "<endofline>"
      ]
    ]
  ],
  "fromdjango.core.mailimportsend_mass_mail\r\nfromdjango.db.modelsimportQ\r\nfromdjango.httpimportHttpResponseBadRequest,HttpResponseNotAllowed\r\nfromdjango.shortcutsimportrender,redirect,get_object_or_404\r\nfromdjango.templateimportContext,Template\r\nfromdjango.views.decorators.httpimportrequire_POST\r\n\r\nfromaccount.decoratorsimportlogin_required\r\n\r\n#@@@switchtopinax-teams\r\nfromsymposion.teams.modelsimportTeam\r\n\r\nfromsymposion.confimportsettings\r\nfromsymposion.proposals.modelsimportProposalBase,ProposalSection\r\nfromsymposion.utils.mailimportsend_email\r\n\r\nfromsymposion.reviews.formsimportReviewForm,SpeakerCommentForm\r\nfromsymposion.reviews.formsimportBulkPresentationForm\r\nfromsymposion.reviews.formsimportStaffCommentForm\r\nfromsymposion.reviews.modelsimport(\r\nReviewAssignment,Review,LatestVote,ProposalResult,NotificationTemplate,\r\nResultNotification\r\n)\r\n\r\n\r\ndefproposals_generator(request,queryset,user_pk=None,check_speaker=True):\r\n\r\nforobjinqueryset:\r\n#@@@thissucks;wecandobetter\r\nifcheck_speaker:\r\nifrequest.userin[s.userforsinobj.speakers()]:\r\ncontinue\r\n\r\ntry:\r\nobj.result\r\nexceptProposalResult.DoesNotExist:\r\nProposalResult.objects.get_or_create(proposal=obj)\r\n\r\nobj.comment_count=obj.result.comment_count\r\nobj.total_votes=obj.result.vote_count\r\nobj.plus_one=obj.result.plus_one\r\nobj.plus_zero=obj.result.plus_zero\r\nobj.minus_zero=obj.result.minus_zero\r\nobj.minus_one=obj.result.minus_one\r\nlookup_params=dict(proposal=obj)\r\n\r\nifuser_pk:\r\nlookup_params[\"\"]=user_pk\r\nelse:\r\nlookup_params[\"\"]=request.user\r\n\r\ntry:\r\nobj.user_vote=LatestVote.objects.get(**lookup_params).vote\r\nobj.user_vote_css=LatestVote.objects.get(**lookup_params).css_class()\r\nexceptLatestVote.DoesNotExist:\r\nobj.user_vote=None\r\nobj.user_vote_css=\"\"\r\n\r\nyieldobj\r\n\r\ndefaccess_not_permitted(request,error_message):\r\nreturnrender(request,\"\",error_message)\r\n\r\n\r\n#Returnsalistofallproposals,proposalsreviewedbytheuser,ortheproposalstheuserhas\r\n#yettoreviewdependingonthelinkuserclicksindashboard\r\n@login_required\r\ndefreview_section(request_review,section_slug,assigned=False,reviewed=\"\"):\r\n\r\nifnotrequest_review.user.has_perm(\"\"%section_slug):\r\nreturnaccess_not_permitted(request_review,\"\")\r\n\r\nsection=get_object_or_404(ProposalSection,section__slug=section_slug)\r\nqueryset=ProposalBase.objects.filter(kind__section=section.section)\r\n\r\nifassigned:\r\nassignments=ReviewAssignment.objects.filter(user=request_review.user)\\\r\n.values_list(\"\")\r\nqueryset=queryset.filter(id__in=assignments)\r\n\r\n#passingreviewedinfromreviews.urlsandouttoreview_listfor\r\n#appropriatetemplateheaderrendering\r\nifreviewed==\"\":\r\nqueryset=queryset.select_related(\"\").select_subclasses()\r\nreviewed=\"\"\r\nelifreviewed==\"\":\r\nqueryset=queryset.filter(reviews__user=request_review.user)\r\nreviewed=\"\"\r\nelse:\r\nqueryset=queryset.exclude(reviews__user=request_review.user).exclude(\r\nspeaker__user=request_review.user)\r\nreviewed=\"\"\r\n\r\nproposals=proposals_generator(request_review,queryset)\r\n\r\nctx={\r\n\"\":proposals,\r\n\"\":section,\r\n\"\":reviewed,\r\n}\r\n\r\nreturnrender(request_review,\"\",ctx)\r\n\r\n\r\n@login_required\r\ndefreview_list(request_review_list,section_slug,user_pk):\r\n\r\n#ifthey''tthepersonwhose\r\n#reviewlistisbeingaskedfor,don'tletthemin\r\nifnotrequest_review_list.user.has_perm(\"\"%section_slug):\r\nifnotrequest_review_list.user.pk==user_pk:\r\nreturnaccess_not_permitted(": [
    [
      -0.0023971621950551352,
      [
        "request",
        "_",
        "review",
        "_",
        "list",
        ",",
        "section",
        "_",
        "slug",
        ",",
        "user",
        "_",
        "pk",
        ")",
        "<endofline>"
      ]
    ],
    [
      -0.0025575159583967016,
      [
        "user",
        "_",
        "pk",
        ",",
        "request",
        "_",
        "review",
        "_",
        "list",
        ",",
        "section",
        "_",
        "slug",
        ")",
        "<endofline>"
      ]
    ],
    [
      -0.0026027131283665366,
      [
        "False",
        ",",
        "request",
        "_",
        "review",
        "_",
        "list",
        ",",
        "section",
        "_",
        "slug",
        ")",
        "<endofline>"
      ]
    ],
    [
      -0.0026123299085053335,
      [
        "request",
        "_",
        "review",
        "_",
        "list",
        ",",
        "section",
        "_",
        "slug",
        ")",
        "<endofline>"
      ]
    ],
    [
      -0.0027203472910017237,
      [
        "None",
        ",",
        "request",
        "_",
        "review",
        "_",
        "list",
        ",",
        "section",
        "_",
        "slug",
        ",",
        "user",
        "_",
        "pk",
        ")",
        "<endofline>"
      ]
    ],
    [
      -0.00279296535538552,
      [
        "None",
        ",",
        "request",
        "_",
        "review",
        "_",
        "list",
        ",",
        "section",
        "_",
        "slug",
        ")",
        "<endofline>"
      ]
    ],
    [
      -0.0028394567463006022,
      [
        "User",
        ",",
        "request",
        "_",
        "review",
        "_",
        "list",
        ",",
        "section",
        "_",
        "slug",
        ")",
        "<endofline>"
      ]
    ],
    [
      -0.003041945210754327,
      [
        "<STR_LIT>",
        ",",
        "request",
        "_",
        "review",
        "_",
        "list",
        ",",
        "section",
        "_",
        "slug",
        ")",
        "<endofline>"
      ]
    ],
    [
      -0.0037854319877993416,
      [
        "user",
        "_",
        "pk",
        ",",
        "request",
        "_",
        "review",
        "_",
        "list",
        ")",
        "<endofline>"
      ]
    ],
    [
      -0.004148128600876708,
      [
        "user",
        "_",
        "pk",
        ",",
        "request",
        "_",
        "review",
        "_",
        "list",
        ".",
        "user",
        ")",
        "<endofline>"
      ]
    ],
    [
      -0.004460543878398658,
      [
        "<STR_LIT>",
        ",",
        "request",
        "_",
        "review",
        "_",
        "list",
        ")",
        "<endofline>"
      ]
    ],
    [
      -0.004707712587030602,
      [
        "<STR_LIT>",
        ",",
        "request",
        "_",
        "review",
        "_",
        "list",
        ".",
        "user",
        ")",
        "<endofline>"
      ]
    ],
    [
      -0.0047862211295947405,
      [
        "User",
        ".",
        "objects",
        ".",
        "get",
        "(",
        "pk",
        "=",
        "user",
        "_",
        "pk",
        "),",
        "<STR_LIT>",
        ")",
        "<endofline>"
      ]
    ],
    [
      -0.00498967268082224,
      [
        "<STR_LIT>",
        ",",
        "user",
        "_",
        "pk",
        ")",
        "<endofline>"
      ]
    ],
    [
      -0.0054839011805716655,
      [
        "user",
        "_",
        "pk",
        ")",
        "<endofline>"
      ]
    ]
  ],
  "fromdjango.core.mailimportsend_mass_mail\r\nfromdjango.db.modelsimportQ\r\nfromdjango.httpimportHttpResponseBadRequest,HttpResponseNotAllowed\r\nfromdjango.shortcutsimportrender,redirect,get_object_or_404\r\nfromdjango.templateimportContext,Template\r\nfromdjango.views.decorators.httpimportrequire_POST\r\n\r\nfromaccount.decoratorsimportlogin_required\r\n\r\n#@@@switchtopinax-teams\r\nfromsymposion.teams.modelsimportTeam\r\n\r\nfromsymposion.confimportsettings\r\nfromsymposion.proposals.modelsimportProposalBase,ProposalSection\r\nfromsymposion.utils.mailimportsend_email\r\n\r\nfromsymposion.reviews.formsimportReviewForm,SpeakerCommentForm\r\nfromsymposion.reviews.formsimportBulkPresentationForm\r\nfromsymposion.reviews.formsimportStaffCommentForm\r\nfromsymposion.reviews.modelsimport(\r\nReviewAssignment,Review,LatestVote,ProposalResult,NotificationTemplate,\r\nResultNotification\r\n)\r\n\r\n\r\ndefproposals_generator(request,queryset,user_pk=None,check_speaker=True):\r\n\r\nforobjinqueryset:\r\n#@@@thissucks;wecandobetter\r\nifcheck_speaker:\r\nifrequest.userin[s.userforsinobj.speakers()]:\r\ncontinue\r\n\r\ntry:\r\nobj.result\r\nexceptProposalResult.DoesNotExist:\r\nProposalResult.objects.get_or_create(proposal=obj)\r\n\r\nobj.comment_count=obj.result.comment_count\r\nobj.total_votes=obj.result.vote_count\r\nobj.plus_one=obj.result.plus_one\r\nobj.plus_zero=obj.result.plus_zero\r\nobj.minus_zero=obj.result.minus_zero\r\nobj.minus_one=obj.result.minus_one\r\nlookup_params=dict(proposal=obj)\r\n\r\nifuser_pk:\r\nlookup_params[\"\"]=user_pk\r\nelse:\r\nlookup_params[\"\"]=request.user\r\n\r\ntry:\r\nobj.user_vote=LatestVote.objects.get(**lookup_params).vote\r\nobj.user_vote_css=LatestVote.objects.get(**lookup_params).css_class()\r\nexceptLatestVote.DoesNotExist:\r\nobj.user_vote=None\r\nobj.user_vote_css=\"\"\r\n\r\nyieldobj\r\n\r\ndefaccess_not_permitted(request,error_message):\r\nreturnrender(request,\"\",error_message)\r\n\r\n\r\n#Returnsalistofallproposals,proposalsreviewedbytheuser,ortheproposalstheuserhas\r\n#yettoreviewdependingonthelinkuserclicksindashboard\r\n@login_required\r\ndefreview_section(request_review,section_slug,assigned=False,reviewed=\"\"):\r\n\r\nifnotrequest_review.user.has_perm(\"\"%section_slug):\r\nreturnaccess_not_permitted(request_review,\"\")\r\n\r\nsection=get_object_or_404(ProposalSection,section__slug=section_slug)\r\nqueryset=ProposalBase.objects.filter(kind__section=section.section)\r\n\r\nifassigned:\r\nassignments=ReviewAssignment.objects.filter(user=request_review.user)\\\r\n.values_list(\"\")\r\nqueryset=queryset.filter(id__in=assignments)\r\n\r\n#passingreviewedinfromreviews.urlsandouttoreview_listfor\r\n#appropriatetemplateheaderrendering\r\nifreviewed==\"\":\r\nqueryset=queryset.select_related(\"\").select_subclasses()\r\nreviewed=\"\"\r\nelifreviewed==\"\":\r\nqueryset=queryset.filter(reviews__user=request_review.user)\r\nreviewed=\"\"\r\nelse:\r\nqueryset=queryset.exclude(reviews__user=request_review.user).exclude(\r\nspeaker__user=request_review.user)\r\nreviewed=\"\"\r\n\r\nproposals=proposals_generator(request_review,queryset)\r\n\r\nctx={\r\n\"\":proposals,\r\n\"\":section,\r\n\"\":reviewed,\r\n}\r\n\r\nreturnrender(request_review,\"\",ctx)\r\n\r\n\r\n@login_required\r\ndefreview_list(request_review_list,section_slug,user_pk):\r\n\r\n#ifthey''tthepersonwhose\r\n#reviewlistisbeingaskedfor,don'tletthemin\r\nifnotrequest_review_list.user.has_perm(\"\"%section_slug):\r\nifnotrequest_review_list.user.pk==user_pk:\r\nreturnaccess_not_permitted(request_review_list,\"\")\r\n\r\nqueryset=ProposalBase.objects.select_related(\"\",\"\")\r\nreviewed=LatestVote.objects.filter(user__pk=user_pk).values_list(\"\",flat=True)\r\nqueryset=queryset.filter(pk__in=reviewed)\r\nproposals=queryset.order_by(\"\")\r\n\r\nadmin=request_review_list.user.has_perm(\"\"%section_slug)\r\n\r\nproposals=proposals_generator(request_review_list,proposals,user_pk=user_pk,check_speaker=notadmin)\r\n\r\nctx={\r\n\"\":proposals,\r\n}\r\nreturnrender(request_review_list,\"\",ctx)\r\n\r\n\r\n@login_required\r\ndefreview_admin(request_review_admin,section_slug):\r\n\r\nifnotrequest_review_admin.user.has_perm(\"\"%section_slug):\r\nreturnaccess_not_permitted(request_review_admin,\"\")": [
    [
      -0.001822144169235925,
      [
        " if",
        " not",
        " ",
        "request",
        "_",
        "review",
        "_",
        "admin",
        ".",
        "user",
        ".",
        "has",
        "_",
        "perm",
        "(",
        "<unk>",
        "<STR_LIT>",
        "<unk>",
        "%",
        "section",
        "_",
        "slug",
        ")",
        " else"
      ]
    ],
    [
      -0.001991538880674642,
      [
        "|",
        "Admin",
        ".",
        "objects",
        ".",
        "filter",
        "(",
        "pk",
        "_",
        "_",
        "in",
        "=",
        "request",
        "_",
        "review",
        "_",
        "admin",
        ")",
        ".",
        "order",
        "_",
        "by",
        "("
      ]
    ],
    [
      -0.0020717034063187727,
      [
        "|",
        "Admin",
        ".",
        "objects",
        ".",
        "select",
        "_",
        "related",
        "(",
        "<unk>",
        "<STR_LIT>",
        "<unk>",
        "%",
        "section",
        "_",
        "slug",
        ")",
        ".",
        "filter",
        "(",
        "pk",
        "_",
        "_"
      ]
    ],
    [
      -0.0027399718935013626,
      [
        " queryset",
        ".",
        "filter",
        "(",
        "pk",
        "_",
        "_",
        "in",
        "=",
        "request",
        "_",
        "review",
        "_",
        "admin",
        ".",
        "user",
        ".",
        "pk",
        ")",
        ".",
        "exists",
        "()",
        "<endofline>"
      ]
    ],
    [
      -0.0028447973186329373,
      [
        " if",
        " not",
        "request",
        "_",
        "review",
        "_",
        "admin",
        ".",
        "user",
        ".",
        "has",
        "_",
        "perm",
        "(",
        "<unk>",
        "<STR_LIT>",
        "<unk>",
        "%",
        "section",
        "_",
        "slug",
        "):",
        " return",
        "access"
      ]
    ],
    [
      -0.002856741293847629,
      [
        " queryset",
        ".",
        "filter",
        "(",
        "pk",
        "_",
        "_",
        "in",
        "=",
        "request",
        "_",
        "review",
        "_",
        "admin",
        ".",
        "user",
        ".",
        "pk",
        ")",
        ".",
        "exists",
        "()",
        "<endofline>"
      ]
    ],
    [
      -0.0029843933748230386,
      [
        " queryset",
        ".",
        "filter",
        "(",
        "pk",
        "=",
        "section",
        "_",
        "slug",
        ")",
        ".",
        "exists",
        "()",
        "<endofline>"
      ]
    ],
    [
      -0.003124853213506292,
      [
        " queryset",
        ".",
        "select",
        "_",
        "related",
        "(",
        "<unk>",
        "<STR_LIT>",
        "<unk>",
        "%",
        "section",
        "_",
        "slug",
        ")",
        ".",
        "exists",
        "()",
        "<endofline>"
      ]
    ],
    [
      -0.0031360035277365607,
      [
        "(",
        "request",
        "_",
        "review",
        "_",
        "admin",
        ",",
        "section",
        "_",
        "slug",
        ")",
        "<endofline>"
      ]
    ],
    [
      -0.003201477354696564,
      [
        " if",
        " not",
        "request",
        "_",
        "review",
        "_",
        "admin",
        ".",
        "user",
        ".",
        "has",
        "_",
        "perm",
        "(",
        "<unk>",
        "<STR_LIT>",
        "<unk>",
        "%",
        "section",
        "_",
        "slug",
        ")",
        " else",
        " "
      ]
    ],
    [
      -0.0033545252347137733,
      [
        " queryset",
        ".",
        "filter",
        "(",
        "pk",
        "_",
        "_",
        "in",
        "=",
        "review",
        "_",
        "admin",
        ".",
        "pk",
        ")",
        ".",
        "exists",
        "()",
        "<endofline>"
      ]
    ],
    [
      -0.0033780402756458006,
      [
        " if",
        " not",
        " ",
        "request",
        "_",
        "review",
        "_",
        "admin",
        ".",
        "user",
        ".",
        "has",
        "_",
        "perm",
        "(",
        "<unk>",
        "<STR_LIT>",
        "<unk>",
        "%",
        "section",
        "_",
        "slug",
        "):",
        " return"
      ]
    ],
    [
      -0.0037561059997268803,
      [
        "<unk>",
        "<endofline>"
      ]
    ],
    [
      -0.0039666535724772085,
      [
        "(",
        "request",
        "_",
        "review",
        "_",
        "admin",
        ")",
        "<endofline>"
      ]
    ]
  ],
  "fromdjango.core.mailimportsend_mass_mail\r\nfromdjango.db.modelsimportQ\r\nfromdjango.httpimportHttpResponseBadRequest,HttpResponseNotAllowed\r\nfromdjango.shortcutsimportrender,redirect,get_object_or_404\r\nfromdjango.templateimportContext,Template\r\nfromdjango.views.decorators.httpimportrequire_POST\r\n\r\nfromaccount.decoratorsimportlogin_required\r\n\r\n#@@@switchtopinax-teams\r\nfromsymposion.teams.modelsimportTeam\r\n\r\nfromsymposion.confimportsettings\r\nfromsymposion.proposals.modelsimportProposalBase,ProposalSection\r\nfromsymposion.utils.mailimportsend_email\r\n\r\nfromsymposion.reviews.formsimportReviewForm,SpeakerCommentForm\r\nfromsymposion.reviews.formsimportBulkPresentationForm\r\nfromsymposion.reviews.formsimportStaffCommentForm\r\nfromsymposion.reviews.modelsimport(\r\nReviewAssignment,Review,LatestVote,ProposalResult,NotificationTemplate,\r\nResultNotification\r\n)\r\n\r\n\r\ndefproposals_generator(request,queryset,user_pk=None,check_speaker=True):\r\n\r\nforobjinqueryset:\r\n#@@@thissucks;wecandobetter\r\nifcheck_speaker:\r\nifrequest.userin[s.userforsinobj.speakers()]:\r\ncontinue\r\n\r\ntry:\r\nobj.result\r\nexceptProposalResult.DoesNotExist:\r\nProposalResult.objects.get_or_create(proposal=obj)\r\n\r\nobj.comment_count=obj.result.comment_count\r\nobj.total_votes=obj.result.vote_count\r\nobj.plus_one=obj.result.plus_one\r\nobj.plus_zero=obj.result.plus_zero\r\nobj.minus_zero=obj.result.minus_zero\r\nobj.minus_one=obj.result.minus_one\r\nlookup_params=dict(proposal=obj)\r\n\r\nifuser_pk:\r\nlookup_params[\"\"]=user_pk\r\nelse:\r\nlookup_params[\"\"]=request.user\r\n\r\ntry:\r\nobj.user_vote=LatestVote.objects.get(**lookup_params).vote\r\nobj.user_vote_css=LatestVote.objects.get(**lookup_params).css_class()\r\nexceptLatestVote.DoesNotExist:\r\nobj.user_vote=None\r\nobj.user_vote_css=\"\"\r\n\r\nyieldobj\r\n\r\ndefaccess_not_permitted(request,error_message):\r\nreturnrender(request,\"\",error_message)\r\n\r\n\r\n#Returnsalistofallproposals,proposalsreviewedbytheuser,ortheproposalstheuserhas\r\n#yettoreviewdependingonthelinkuserclicksindashboard\r\n@login_required\r\ndefreview_section(request_review,section_slug,assigned=False,reviewed=\"\"):\r\n\r\nifnotrequest_review.user.has_perm(\"\"%section_slug):\r\nreturnrender(request_review,\"\",\"\")\r\n\r\nsection=get_object_or_404(ProposalSection,section__slug=section_slug)\r\nqueryset=ProposalBase.objects.filter(kind__section=section.section)\r\n\r\nifassigned:\r\nassignments=ReviewAssignment.objects.filter(user=request_review.user)\\\r\n.values_list(\"\")\r\nqueryset=queryset.filter(id__in=assignments)\r\n\r\n#passingreviewedinfromreviews.urlsandouttoreview_listfor\r\n#appropriatetemplateheaderrendering\r\nifreviewed==\"\":\r\nqueryset=queryset.select_related(\"\").select_subclasses()\r\nreviewed=\"\"\r\nelifreviewed==\"\":\r\nqueryset=queryset.filter(reviews__user=request_review.user)\r\nreviewed=\"\"\r\nelse:\r\nqueryset=queryset.exclude(reviews__user=request_review.user).exclude(\r\nspeaker__user=request_review.user)\r\nreviewed=\"\"\r\n\r\nproposals=proposals_generator(request_review,queryset)\r\n\r\nctx={\r\n\"\":proposals,\r\n\"\":section,\r\n\"\":reviewed,\r\n}\r\n\r\nreturnrender(request_review,\"\",ctx)\r\n\r\n\r\n@login_required\r\ndefreview_list(request_review_list,section_slug,user_pk):\r\n\r\n#ifthey''tthepersonwhose\r\n#reviewlistisbeingaskedfor,don'tletthemin\r\nifnotrequest_review_list.user.has_perm(\"\"%section_slug):\r\nifnotrequest_review_list.user.pk==user_pk:\r\nreturnrender(request_review_list,\"\",\"\")\r\n\r\nqueryset=ProposalBase.objects.select_related(\"\",\"\")\r\nreviewed=LatestVote.objects.filter(user__pk=user_pk).values_list(\"\",flat=True)\r\nqueryset=queryset.filter(pk__in=reviewed)\r\nproposals=queryset.order_by(\"\")\r\n\r\nadmin=request_review_list.user.has_perm(\"\"%section_slug)\r\n\r\nproposals=proposals_generator(request_review_list,proposals,user_pk=user_pk,check_speaker=notadmin)\r\n\r\nctx={\r\n\"\":proposals,\r\n}\r\nreturnrender(request_review_list,\"\",ctx)\r\n\r\n\r\n@login_required\r\ndefreview_admin(request_review_admin,section_slug):\r\n\r\nifnotrequest_review_admin.user.has_perm(\"\"%section_slug):\r\nreturnrender(request_review_admin,\"\",\"\")\r\n\r\ndefreviewers():\r\nalready_seen=set()\r\n\r\nforteaminTeam.objects.filter(permissions__codename=\"\"%section_slug):\r\nformembershipinteam.memberships.filter(Q(state=\"\")|Q(state=\"\")):\r\nuser=membership.user\r\nifuser.pkinalready_seen:\r\ncontinue\r\nalready_seen.add(user.pk)\r\n\r\nuser.comment_count=Review.objects.filter(user=user).count()\r\nuser.total_votes=LatestVote.objects.filter(user=user).count()\r\nuser.plus_one=LatestVote.objects.filter(\r\nuser=user,\r\nvote=LatestVote.VOTES.PLUS_ONE\r\n).count()\r\nuser.plus_zero=LatestVote.objects.filter(\r\nuser=user,\r\nvote=LatestVote.VOTES.PLUS_ZERO\r\n).count()\r\nuser.minus_zero=LatestVote.objects.filter(\r\nuser=user,\r\nvote=LatestVote.VOTES.MINUS_ZERO\r\n).count()\r\nuser.minus_one=LatestVote.objects.filter(\r\nuser=user,\r\nvote=LatestVote.VOTES.MINUS_ONE\r\n).count()\r\n\r\nyielduser\r\n\r\nctx={\r\n\"\":section_slug,\r\n\"\":reviewers(),\r\n}\r\nreturnrender(request_review_admin,\"\",ctx)\r\n\r\n@login_required\r\ndefreview_detail(request_review_detail,pk):\r\n\r\nproposals=ProposalBase.objects.select_related(\"\").select_subclasses()\r\nproposal=get_object_or_404(proposals,pk=pk)\r\n\r\nifnotrequest_review_detail.user.has_perm(\"\"%proposal.kind.section.slug):\r\nreturnrender(request_review_detail,\"\",\"\")\r\n\r\nspeakers=[s.userforsinproposal.speakers()]\r\n\r\nifnotrequest_review_detail.user.is_superuserandrequest_review_detail.userinspeakers:\r\nreturnrender(request_review_detail,\"\",\"\")\r\n\r\nadmin=request_review_detail.user.is_staff\r\n\r\ntry:\r\nlatest_vote=LatestVote.objects.get(proposal=proposal,user=request_review_detail.user)\r\nexceptLatestVote.DoesNotExist:\r\nlatest_vote=None\r\n\r\nifrequest_review_detail.method==\"\":\r\nifrequest_review_detail.userinspeakers:\r\nreturnrender(request_review_detail,\"\",\"\")\r\n\r\nif\"\"inrequest_review_detail.POST:\r\nreview_form=ReviewForm(request_review_detail.POST)\r\nifreview_form.is_valid():\r\n\r\nreview=review_form.save(commit=False)\r\nreview.user=request_review_detail.user\r\nreview.proposal=proposal\r\nreview.save()\r\n\r\nreturnredirect(request_review_detail.path)\r\nelse:\r\nmessage_form=SpeakerCommentForm()\r\nelif\"\"inrequest_review_detail.POST:\r\nmessage_form=SpeakerCommentForm(request_review_detail.POST)\r\nifmessage_form.is_valid():\r\n\r\nmessage=message_form.save(commit=False)\r\nmessage.user=request_review_detail.user\r\nmessage.proposal=proposal\r\nmessage.save()\r\n\r\nforspeakerinspeakers:\r\nifspeakerandspeaker.email:\r\nctx={\r\n\"\":proposal,\r\n\"\":message,\r\n\"\":False,\r\n}\r\nsend_email(\r\n[speaker.email],\"\",\r\ncontext=ctx\r\n)\r\n\r\nreturnredirect(request_review_detail.path)\r\nelse:\r\ninitial={}\r\niflatest_vote:\r\ninitial[\"\"]=latest_vote.vote\r\nifrequest_review_detail.userinspeakers:\r\nreview_form=None\r\nelse:\r\nreview_form=ReviewForm(initial=initial)\r\nelif\"\"inrequest_review_detail.POST:\r\nifadmin:\r\nresult=request_review_detail.POST[\"\"]\r\n\r\nifresult==\"\":\r\nproposal.result.status=\"\"\r\nproposal.result.save()\r\nelifresult==\"\":\r\nproposal.result.status=\"\"\r\nproposal.result.save()\r\nelifresult==\"\":\r\nproposal.result.status=\"\"\r\nproposal.result.save()\r\nelifresult==\"\":\r\nproposal.result.status=\"\"\r\nproposal.result.save()\r\n\r\nreturnredirect(request_review_detail.path)\r\nelse:\r\ninitial={}\r\niflatest_vote:\r\ninitial[\"\"]=latest_vote.vote\r\nifrequest_review_detail.userinspeakers:\r\nreview_form=None\r\nelse:\r\nreview_form=ReviewForm(initial=initial)\r\nmessage_form=SpeakerCommentForm()\r\n\r\nproposal.comment_count=proposal.result.comment_count\r\nproposal.total_votes=proposal.result.vote_count\r\nproposal.plus_one=proposal.result.plus_one\r\nproposal.plus_zero=proposal.result.plus_zero\r\nproposal.minus_zero=proposal.result.minus_zero\r\nproposal.minus_one=proposal.result.minus_one\r\n\r\nreviews=Review.objects.filter(proposal=proposal).order_by(\"\")\r\nmessages=proposal.messages.order_by(\"\")\r\n\r\nreturnrender(request_review_detail,\"\",{\r\n\"\":proposal,\r\n\"\":latest_vote,\r\n\"\":reviews,\r\n\"\":messages,\r\n\"\":review_form,\r\n\"\":message_form\r\n})\r\n\r\n\r\n@login_required\r\n@require_POST\r\ndefreview_delete(request_delete,pk):\r\nreview=get_object_or_404(Review,pk=pk)\r\nsection_slug=review.section.slug\r\n\r\nifnotrequest_delete.user.has_perm(\"\"%section_slug):\r\nreturnrender(request_delete,\"\",\"\")\r\n\r\nreview=get_object_or_404(Review,pk=pk)\r\nreview.delete()\r\n\r\nreturnredirect(\"\",pk=review.proposal.pk)\r\n\r\n\r\n@login_required\r\ndefreview_status(request_review_status,section_slug=None,key=None):\r\n\r\nifnotrequest_review_status.user.has_perm(\"\"%section_slug):\r\nreturnrender(request_review_status,\"\",\"\")\r\n\r\nVOTE_THRESHOLD=settings.SYMPOSION_VOTE_THRESHOLD\r\n\r\nctx={\r\n\"\":section_slug,\r\n\"\":VOTE_THRESHOLD,\r\n}\r\n\r\nqueryset=ProposalBase.objects.select_related(\"\",\"\").select_subclasses()\r\nifsection_slug:\r\nqueryset=queryset.filter(kind__section__slug=section_slug)\r\n\r\nproposals={\r\n#proposalswithatleastVOTE_THRESHOLDreviewsandatleastone+1andno-1s,sortedby\r\n#the''\r\n\"\":queryset.filter(result__vote_count__gte=VOTE_THRESHOLD,result__plus_one__gt=0,\r\nresult__minus_one=0).order_by(\"\"),\r\n#proposalswithatleastVOTE_THRESHOLDreviewsandatleastone-1andno+1s,reverse\r\n#sortedbythe''\r\n\"\":queryset.filter(result__vote_count__gte=VOTE_THRESHOLD,result__minus_one__gt=0,\r\nresult__plus_one=0).order_by(\"\"),\r\n#proposalswithatleastVOTE_THRESHOLDreviewsandneithera+1ora-1,sortedbytotal\r\n#votes(lowestfirst)\r\n\"\":queryset.filter(result__vote_count__gte=VOTE_THRESHOLD,result__minus_one=0,\r\nresult__plus_one=0).order_by(\"\"),\r\n#proposalswithatleastVOTE_THRESHOLDreviewsandbotha+1and-1,sortedbytotal\r\n#votes(highestfirst)\r\n\"\":queryset.filter(result__vote_count__gte=VOTE_THRESHOLD,\r\nresult__plus_one__gt=0,result__minus_one__gt=0)\r\n.order_by(\"\"),\r\n#proposalswithfewerthanVOTE_THRESHOLDreviews\r\n\"\":queryset.filter(result__vote_count__lt=VOTE_THRESHOLD)\r\n.order_by(\"\"),\r\n}\r\n\r\nadmin=request_review_status.user.has_perm(\"\"%section_slug)\r\n\r\nforstatusinproposals:\r\nifkeyandkey!=status:\r\ncontinue\r\nproposals[status]=list(proposals_generator(request_review_status,proposals[status],check_speaker=notadmin))\r\n\r\nifkey:\r\nctx.update({\r\n\"\":key,\r\n\"\":proposals[key],\r\n})\r\nelse:\r\nctx[\"\"]=proposals\r\n\r\nreturnrender(request_review_status,\"\",ctx)\r\n\r\n\r\n@login_required\r\ndefreview_assignments(request_review_assignments):\r\nifnotrequest_review_assignments.user.groups.filter(name=\"\").exists():\r\nreturnrender(request_review_assignments,\"\",\"\")\r\nassignments=ReviewAssignment.objects.filter(\r\nuser=request_review_assignments.user,\r\nopted_out=False\r\n)\r\nreturnrender(request_review_assignments,\"\",{\r\n\"\":assignments,\r\n})\r\n\r\n\r\n@login_required\r\n@require_POST\r\ndefreview_assignment_opt_out(request_review_assignment_opt_out,pk):\r\nreview_assignment=get_object_or_404(\r\nReviewAssignment,pk=pk,user=request_review_assignment_opt_out.user)\r\nifnotreview_assignment.opted_out:\r\nreview_assignment.opted_out=True\r\nreview_assignment.save()\r\nReviewAssignment.create_assignments(\r\nreview_assignment.proposal,origin=ReviewAssignment.AUTO_ASSIGNED_LATER)\r\nreturnredirect(\"\")\r\n\r\n\r\n@login_required\r\ndefreview_bulk_accept(request_review_bulk_accept,section_slug):\r\nifnotrequest_review_bulk_accept.user.has_perm(\"\"%section_slug):\r\nreturnrender(request_review_bulk_accept,\"\",\"\")\r\nifrequest_review_bulk_accept.method==\"\":\r\nform=BulkPresentationForm(request_review_bulk_accept.POST)\r\nifform.is_valid():\r\ntalk_ids=form.cleaned_data[\"\"].split(\"\")\r\ntalks=ProposalBase.objects.filter(id__in=talk_ids).select_related(\"\")\r\nfortalkintalks:\r\ntalk.result.status=\"\"\r\ntalk.result.save()\r\nreturnredirect(\"\",section_slug=section_slug)\r\nelse:\r\nform=BulkPresentationForm()\r\n\r\nreturnrender(request_review_bulk_accept,\"\",{\r\n\"\":form,\r\n})\r\n\r\n\r\n@login_required\r\ndefresult_notification(request_result_notification,section_slug,status):\r\nifnotrequest_result_notification.user.has_perm(\"\"%section_slug):\r\nreturnrender(request_result_notification,\"\",\"\")\r\n\r\nproposals=ProposalBase.objects.filter(kind__section__slug=section_slug,result__status=status).select_related(\"\",\"\").select_subclasses()\r\nnotification_templates=NotificationTemplate.objects.all()\r\n\r\nctx={\r\n\"\":section_slug,\r\n\"\":status,\r\n\"\":proposals,\r\n\"\":notification_templates,\r\n}\r\nreturnrender(request_result_notification,\"\",ctx)\r\n\r\n\r\n@login_required\r\ndefresult_notification_prepare(request_result_notification_prepare,section_slug,status):\r\nifrequest_result_notification_prepare.method!=\"\":\r\nreturnHttpResponseNotAllowed([\"\"])\r\n\r\nifnotrequest_result_notification_prepare.user.has_perm(\"\"%section_slug):\r\nreturnrender(request_result_notification_prepare,\"\",\"\")\r\n\r\nproposal_pks=[]\r\ntry:\r\nforpkinrequest_result_notification_prepare.POST.getlist(\"\"):\r\nproposal_pks.append(int(pk))\r\nexceptValueError:\r\nreturnHttpResponseBadRequest()\r\nproposals=ProposalBase.objects.filter(\r\nkind__section__slug=section_slug,\r\nresult__status=status,\r\n)\r\nproposals=proposals.filter(pk__in=proposal_pks)\r\nproposals=proposals.select_related(\"\",\"\")\r\nproposals=proposals.select_subclasses()\r\n\r\nnotification_template_pk=request_result_notification_prepare.POST.get(\"\",\"\")\r\nifnotification_template_pk:\r\nnotification_template=NotificationTemplate.objects.get(pk=notification_template_pk)\r\nelse:\r\nnotification_template=None\r\n\r\nctx={\r\n\"\":section_slug,\r\n\"\":status,\r\n\"\":notification_template,\r\n\"\":proposals,\r\n\"\":\"\".join([str(pk)forpkinproposal_pks]),\r\n}\r\nreturnrender(request_result_notification_prepare,\"\",ctx)\r\n\r\ndefaccept_staff_suggestion(staffId):\r\nreturn\r\n\r\n@login_required\r\ndefresult_notification_send(request_result_notification_send,section_slug,status):\r\nifrequest_result_notification_send.method!=\"\":\r\nreturnHttpResponseNotAllowed([\"\"])\r\n\r\nifnotrequest_result_notification_send.user.has_perm(\"\"%section_slug):\r\nreturnrender(request_result_notification_send,\"\",\"\")\r\n\r\nifnotall([kinrequest_result_notification_send.POSTforkin[\"\",\"\",\"\",\"\"]]):\r\nreturnHttpResponseBadRequest()\r\n\r\ntry:\r\nproposal_pks=[int(pk)forpkinrequest_result_notification_send.POST[\"\"].split(\"\")]\r\nexceptValueError:\r\nreturnHttpResponseBadRequest()\r\n\r\nproposals=ProposalBase.objects.filter(\r\nkind__section__slug=section_slug,\r\nresult__status=status,\r\n)\r\nproposals=proposals.filter(pk__in=proposal_pks)\r\nproposals=proposals.select_related(\"\",\"\")\r\nproposals=proposals.select_subclasses()\r\n\r\nnotification_template_pk=request_result_notification_send.POST.get(\"\",\"\")\r\nifnotification_template_pk:\r\nnotification_template=NotificationTemplate.objects.get(pk=notification_template_pk)\r\nelse:\r\nnotification_template=None\r\n\r\nemails=[]\r\n\r\nforproposalinproposals:\r\nrn=ResultNotification()\r\nrn.proposal=proposal\r\nrn.template=notification_template\r\nrn.to_address=proposal.speaker_email\r\nrn.from_address=request_result_notification_send.POST[\"\"]\r\nrn.subject=request_result_notification_send.POST[\"\"]\r\nrn.body=Template(request_result_notification_send.POST[\"\"]).render(\r\nContext({\r\n\"\":proposal.notification_email_context()\r\n})\r\n)\r\nrn.save()\r\nemails.append(rn.email_args)\r\n\r\nsend_mass_mail(emails)\r\n\r\nreturnredirect(\"\",section_slug=section_slug,status=status)\r\n\r\n\r\n\r\n@login_required\r\ndefreview_staff_comment(request_review_staff_comment,section_slug):\r\nifnotrequest_review_staff_comment.user.has_perm(\"\"%section_slug):\r\nreturnrender(request_review_staff_comment,\"\",\"\")\r\nifrequest_review_staff_comment.method==\"\":\r\nform=StaffCommentForm(request_review_staff_comment.POST)\r\n#TODO:completeimplementationofstaffcommentform-splitandmarkaccepted\r\nif": [
    [
      -0.000016142623938438343,
      [
        "form",
        ".",
        "is",
        "_",
        "valid",
        "()",
        ":"
      ]
    ]
  ],
  "fromdjango.core.mailimportsend_mass_mail\r\nfromdjango.db.modelsimportQ\r\nfromdjango.httpimportHttpResponseBadRequest,HttpResponseNotAllowed\r\nfromdjango.shortcutsimportrender,redirect,get_object_or_404\r\nfromdjango.templateimportContext,Template\r\nfromdjango.views.decorators.httpimportrequire_POST\r\n\r\nfromaccount.decoratorsimportlogin_required\r\n\r\n#@@@switchtopinax-teams\r\nfromsymposion.teams.modelsimportTeam\r\n\r\nfromsymposion.confimportsettings\r\nfromsymposion.proposals.modelsimportProposalBase,ProposalSection\r\nfromsymposion.utils.mailimportsend_email\r\n\r\nfromsymposion.reviews.formsimportReviewForm,SpeakerCommentForm\r\nfromsymposion.reviews.formsimportBulkPresentationForm\r\nfromsymposion.reviews.formsimportStaffCommentForm\r\nfromsymposion.reviews.modelsimport(\r\nReviewAssignment,Review,LatestVote,ProposalResult,NotificationTemplate,\r\nResultNotification\r\n)\r\n\r\n\r\ndefproposals_generator(request,queryset,user_pk=None,check_speaker=True):\r\n\r\nforobjinqueryset:\r\n#@@@thissucks;wecandobetter\r\nifcheck_speaker:\r\nifrequest.userin[s.userforsinobj.speakers()]:\r\ncontinue\r\n\r\ntry:\r\nobj.result\r\nexceptProposalResult.DoesNotExist:\r\nProposalResult.objects.get_or_create(proposal=obj)\r\n\r\nobj.comment_count=obj.result.comment_count\r\nobj.total_votes=obj.result.vote_count\r\nobj.plus_one=obj.result.plus_one\r\nobj.plus_zero=obj.result.plus_zero\r\nobj.minus_zero=obj.result.minus_zero\r\nobj.minus_one=obj.result.minus_one\r\nlookup_params=dict(proposal=obj)\r\n\r\nifuser_pk:\r\nlookup_params[\"\"]=user_pk\r\nelse:\r\nlookup_params[\"\"]=request.user\r\n\r\ntry:\r\nobj.user_vote=LatestVote.objects.get(**lookup_params).vote\r\nobj.user_vote_css=LatestVote.objects.get(**lookup_params).css_class()\r\nexceptLatestVote.DoesNotExist:\r\nobj.user_vote=None\r\nobj.user_vote_css=\"\"\r\n\r\nyieldobj\r\n\r\ndefaccess_not_permitted(request,error_message):\r\nreturnrender(request,\"\",error_message)\r\n\r\n\r\n#Returnsalistofallproposals,proposalsreviewedbytheuser,ortheproposalstheuserhas\r\n#yettoreviewdependingonthelinkuserclicksindashboard\r\n@login_required\r\ndefreview_section(request_review,section_slug,assigned=False,reviewed=\"\"):\r\n\r\nifnotrequest_review.user.has_perm(\"\"%section_slug):\r\nreturnrender(request_review,\"\",\"\")\r\n\r\nsection=get_object_or_404(ProposalSection,section__slug=section_slug)\r\nqueryset=ProposalBase.objects.filter(kind__section=section.section)\r\n\r\nifassigned:\r\nassignments=ReviewAssignment.objects.filter(user=request_review.user)\\\r\n.values_list(\"\")\r\nqueryset=queryset.filter(id__in=assignments)\r\n\r\n#passingreviewedinfromreviews.urlsandouttoreview_listfor\r\n#appropriatetemplateheaderrendering\r\nifreviewed==\"\":\r\nqueryset=queryset.select_related(\"\").select_subclasses()\r\nreviewed=\"\"\r\nelifreviewed==\"\":\r\nqueryset=queryset.filter(reviews__user=request_review.user)\r\nreviewed=\"\"\r\nelse:\r\nqueryset=queryset.exclude(reviews__user=request_review.user).exclude(\r\nspeaker__user=request_review.user)\r\nreviewed=\"\"\r\n\r\nproposals=proposals_generator(request_review,queryset)\r\n\r\nctx={\r\n\"\":proposals,\r\n\"\":section,\r\n\"\":reviewed,\r\n}\r\n\r\nreturnrender(request_review,\"\",ctx)\r\n\r\n\r\n@login_required\r\ndefreview_list(request_review_list,section_slug,user_pk):\r\n\r\n#ifthey''tthepersonwhose\r\n#reviewlistisbeingaskedfor,don'tletthemin\r\nifnotrequest_review_list.user.has_perm(\"\"%section_slug):\r\nifnotrequest_review_list.user.pk==user_pk:\r\nreturnrender(request_review_list,\"\",\"\")\r\n\r\nqueryset=ProposalBase.objects.select_related(\"\",\"\")\r\nreviewed=LatestVote.objects.filter(user__pk=user_pk).values_list(\"\",flat=True)\r\nqueryset=queryset.filter(pk__in=reviewed)\r\nproposals=queryset.order_by(\"\")\r\n\r\nadmin=request_review_list.user.has_perm(\"\"%section_slug)\r\n\r\nproposals=proposals_generator(request_review_list,proposals,user_pk=user_pk,check_speaker=notadmin)\r\n\r\nctx={\r\n\"\":proposals,\r\n}\r\nreturnrender(request_review_list,\"\",ctx)\r\n\r\n\r\n@login_required\r\ndefreview_admin(request_review_admin,section_slug):\r\n\r\nifnotrequest_review_admin.user.has_perm(\"\"%section_slug):\r\nreturnrender(request_review_admin,\"\",\"\")\r\n\r\ndefreviewers():\r\nalready_seen=set()\r\n\r\nforteaminTeam.objects.filter(permissions__codename=\"\"%section_slug):\r\nformembershipinteam.memberships.filter(Q(state=\"\")|Q(state=\"\")):\r\nuser=membership.user\r\nifuser.pkinalready_seen:\r\ncontinue\r\nalready_seen.add(user.pk)\r\n\r\nuser.comment_count=Review.objects.filter(user=user).count()\r\nuser.total_votes=LatestVote.objects.filter(user=user).count()\r\nuser.plus_one=LatestVote.objects.filter(\r\nuser=user,\r\nvote=LatestVote.VOTES.PLUS_ONE\r\n).count()\r\nuser.plus_zero=LatestVote.objects.filter(\r\nuser=user,\r\nvote=LatestVote.VOTES.PLUS_ZERO\r\n).count()\r\nuser.minus_zero=LatestVote.objects.filter(\r\nuser=user,\r\nvote=LatestVote.VOTES.MINUS_ZERO\r\n).count()\r\nuser.minus_one=LatestVote.objects.filter(\r\nuser=user,\r\nvote=LatestVote.VOTES.MINUS_ONE\r\n).count()\r\n\r\nyielduser\r\n\r\nctx={\r\n\"\":section_slug,\r\n\"\":reviewers(),\r\n}\r\nreturnrender(request_review_admin,\"\",ctx)\r\n\r\n@login_required\r\ndefreview_detail(request_review_detail,pk):\r\n\r\nproposals=ProposalBase.objects.select_related(\"\").select_subclasses()\r\nproposal=get_object_or_404(proposals,pk=pk)\r\n\r\nifnotrequest_review_detail.user.has_perm(\"\"%proposal.kind.section.slug):\r\nreturnrender(request_review_detail,\"\",\"\")\r\n\r\nspeakers=[s.userforsinproposal.speakers()]\r\n\r\nifnotrequest_review_detail.user.is_superuserandrequest_review_detail.userinspeakers:\r\nreturnrender(request_review_detail,\"\",\"\")\r\n\r\nadmin=request_review_detail.user.is_staff\r\n\r\ntry:\r\nlatest_vote=LatestVote.objects.get(proposal=proposal,user=request_review_detail.user)\r\nexceptLatestVote.DoesNotExist:\r\nlatest_vote=None\r\n\r\nifrequest_review_detail.method==\"\":\r\nifrequest_review_detail.userinspeakers:\r\nreturnrender(request_review_detail,\"\",\"\")\r\n\r\nif\"\"inrequest_review_detail.POST:\r\nreview_form=ReviewForm(request_review_detail.POST)\r\nifreview_form.is_valid():\r\n\r\nreview=review_form.save(commit=False)\r\nreview.user=request_review_detail.user\r\nreview.proposal=proposal\r\nreview.save()\r\n\r\nreturnredirect(request_review_detail.path)\r\nelse:\r\nmessage_form=SpeakerCommentForm()\r\nelif\"\"inrequest_review_detail.POST:\r\nmessage_form=SpeakerCommentForm(request_review_detail.POST)\r\nifmessage_form.is_valid():\r\n\r\nmessage=message_form.save(commit=False)\r\nmessage.user=request_review_detail.user\r\nmessage.proposal=proposal\r\nmessage.save()\r\n\r\nforspeakerinspeakers:\r\nifspeakerandspeaker.email:\r\nctx={\r\n\"\":proposal,\r\n\"\":message,\r\n\"\":False,\r\n}\r\nsend_email(\r\n[speaker.email],\"\",\r\ncontext=ctx\r\n)\r\n\r\nreturnredirect(request_review_detail.path)\r\nelse:\r\ninitial={}\r\niflatest_vote:\r\ninitial[\"\"]=latest_vote.vote\r\nifrequest_review_detail.userinspeakers:\r\nreview_form=None\r\nelse:\r\nreview_form=ReviewForm(initial=initial)\r\nelif\"\"inrequest_review_detail.POST:\r\nifadmin:\r\nresult=request_review_detail.POST[\"\"]\r\n\r\nifresult==\"\":\r\nproposal.result.status=\"\"\r\nproposal.result.save()\r\nelifresult==\"\":\r\nproposal.result.status=\"\"\r\nproposal.result.save()\r\nelifresult==\"\":\r\nproposal.result.status=\"\"\r\nproposal.result.save()\r\nelifresult==\"\":\r\nproposal.result.status=\"\"\r\nproposal.result.save()\r\n\r\nreturnredirect(request_review_detail.path)\r\nelse:\r\ninitial={}\r\niflatest_vote:\r\ninitial[\"\"]=latest_vote.vote\r\nifrequest_review_detail.userinspeakers:\r\nreview_form=None\r\nelse:\r\nreview_form=ReviewForm(initial=initial)\r\nmessage_form=SpeakerCommentForm()\r\n\r\nproposal.comment_count=proposal.result.comment_count\r\nproposal.total_votes=proposal.result.vote_count\r\nproposal.plus_one=proposal.result.plus_one\r\nproposal.plus_zero=proposal.result.plus_zero\r\nproposal.minus_zero=proposal.result.minus_zero\r\nproposal.minus_one=proposal.result.minus_one\r\n\r\nreviews=Review.objects.filter(proposal=proposal).order_by(\"\")\r\nmessages=proposal.messages.order_by(\"\")\r\n\r\nreturnrender(request_review_detail,\"\",{\r\n\"\":proposal,\r\n\"\":latest_vote,\r\n\"\":reviews,\r\n\"\":messages,\r\n\"\":review_form,\r\n\"\":message_form\r\n})\r\n\r\n\r\n@login_required\r\n@require_POST\r\ndefreview_delete(request_delete,pk):\r\nreview=get_object_or_404(Review,pk=pk)\r\nsection_slug=review.section.slug\r\n\r\nifnotrequest_delete.user.has_perm(\"\"%section_slug):\r\nreturnrender(request_delete,\"\",\"\")\r\n\r\nreview=get_object_or_404(Review,pk=pk)\r\nreview.delete()\r\n\r\nreturnredirect(\"\",pk=review.proposal.pk)\r\n\r\n\r\n@login_required\r\ndefreview_status(request_review_status,section_slug=None,key=None):\r\n\r\nifnotrequest_review_status.user.has_perm(\"\"%section_slug):\r\nreturnrender(request_review_status,\"\",\"\")\r\n\r\nVOTE_THRESHOLD=settings.SYMPOSION_VOTE_THRESHOLD\r\n\r\nctx={\r\n\"\":section_slug,\r\n\"\":VOTE_THRESHOLD,\r\n}\r\n\r\nqueryset=ProposalBase.objects.select_related(\"\",\"\").select_subclasses()\r\nifsection_slug:\r\nqueryset=queryset.filter(kind__section__slug=section_slug)\r\n\r\nproposals={\r\n#proposalswithatleastVOTE_THRESHOLDreviewsandatleastone+1andno-1s,sortedby\r\n#the''\r\n\"\":queryset.filter(result__vote_count__gte=VOTE_THRESHOLD,result__plus_one__gt=0,\r\nresult__minus_one=0).order_by(\"\"),\r\n#proposalswithatleastVOTE_THRESHOLDreviewsandatleastone-1andno+1s,reverse\r\n#sortedbythe''\r\n\"\":queryset.filter(result__vote_count__gte=VOTE_THRESHOLD,result__minus_one__gt=0,\r\nresult__plus_one=0).order_by(\"\"),\r\n#proposalswithatleastVOTE_THRESHOLDreviewsandneithera+1ora-1,sortedbytotal\r\n#votes(lowestfirst)\r\n\"\":queryset.filter(result__vote_count__gte=VOTE_THRESHOLD,result__minus_one=0,\r\nresult__plus_one=0).order_by(\"\"),\r\n#proposalswithatleastVOTE_THRESHOLDreviewsandbotha+1and-1,sortedbytotal\r\n#votes(highestfirst)\r\n\"\":queryset.filter(result__vote_count__gte=VOTE_THRESHOLD,\r\nresult__plus_one__gt=0,result__minus_one__gt=0)\r\n.order_by(\"\"),\r\n#proposalswithfewerthanVOTE_THRESHOLDreviews\r\n\"\":queryset.filter(result__vote_count__lt=VOTE_THRESHOLD)\r\n.order_by(\"\"),\r\n}\r\n\r\nadmin=request_review_status.user.has_perm(\"\"%section_slug)\r\n\r\nforstatusinproposals:\r\nifkeyandkey!=status:\r\ncontinue\r\nproposals[status]=list(proposals_generator(request_review_status,proposals[status],check_speaker=notadmin))\r\n\r\nifkey:\r\nctx.update({\r\n\"\":key,\r\n\"\":proposals[key],\r\n})\r\nelse:\r\nctx[\"\"]=proposals\r\n\r\nreturnrender(request_review_status,\"\",ctx)\r\n\r\n\r\n@login_required\r\ndefreview_assignments(request_review_assignments):\r\nifnotrequest_review_assignments.user.groups.filter(name=\"\").exists():\r\nreturnrender(request_review_assignments,\"\",\"\")\r\nassignments=ReviewAssignment.objects.filter(\r\nuser=request_review_assignments.user,\r\nopted_out=False\r\n)\r\nreturnrender(request_review_assignments,\"\",{\r\n\"\":assignments,\r\n})\r\n\r\n\r\n@login_required\r\n@require_POST\r\ndefreview_assignment_opt_out(request_review_assignment_opt_out,pk):\r\nreview_assignment=get_object_or_404(\r\nReviewAssignment,pk=pk,user=request_review_assignment_opt_out.user)\r\nifnotreview_assignment.opted_out:\r\nreview_assignment.opted_out=True\r\nreview_assignment.save()\r\nReviewAssignment.create_assignments(\r\nreview_assignment.proposal,origin=ReviewAssignment.AUTO_ASSIGNED_LATER)\r\nreturnredirect(\"\")\r\n\r\n\r\n@login_required\r\ndefreview_bulk_accept(request_review_bulk_accept,section_slug):\r\nifnotrequest_review_bulk_accept.user.has_perm(\"\"%section_slug):\r\nreturnrender(request_review_bulk_accept,\"\",\"\")\r\nifrequest_review_bulk_accept.method==\"\":\r\nform=BulkPresentationForm(request_review_bulk_accept.POST)\r\nifform.is_valid():\r\ntalk_ids=form.cleaned_data[\"\"].split(\"\")\r\ntalks=ProposalBase.objects.filter(id__in=talk_ids).select_related(\"\")\r\nfortalkintalks:\r\ntalk.result.status=\"\"\r\ntalk.result.save()\r\nreturnredirect(\"\",section_slug=section_slug)\r\nelse:\r\nform=BulkPresentationForm()\r\n\r\nreturnrender(request_review_bulk_accept,\"\",{\r\n\"\":form,\r\n})\r\n\r\n\r\n@login_required\r\ndefresult_notification(request_result_notification,section_slug,status):\r\nifnotrequest_result_notification.user.has_perm(\"\"%section_slug):\r\nreturnrender(request_result_notification,\"\",\"\")\r\n\r\nproposals=ProposalBase.objects.filter(kind__section__slug=section_slug,result__status=status).select_related(\"\",\"\").select_subclasses()\r\nnotification_templates=NotificationTemplate.objects.all()\r\n\r\nctx={\r\n\"\":section_slug,\r\n\"\":status,\r\n\"\":proposals,\r\n\"\":notification_templates,\r\n}\r\nreturnrender(request_result_notification,\"\",ctx)\r\n\r\n\r\n@login_required\r\ndefresult_notification_prepare(request_result_notification_prepare,section_slug,status):\r\nifrequest_result_notification_prepare.method!=\"\":\r\nreturnHttpResponseNotAllowed([\"\"])\r\n\r\nifnotrequest_result_notification_prepare.user.has_perm(\"\"%section_slug):\r\nreturnrender(request_result_notification_prepare,\"\",\"\")\r\n\r\nproposal_pks=[]\r\ntry:\r\nforpkinrequest_result_notification_prepare.POST.getlist(\"\"):\r\nproposal_pks.append(int(pk))\r\nexceptValueError:\r\nreturnHttpResponseBadRequest()\r\nproposals=ProposalBase.objects.filter(\r\nkind__section__slug=section_slug,\r\nresult__status=status,\r\n)\r\nproposals=proposals.filter(pk__in=proposal_pks)\r\nproposals=proposals.select_related(\"\",\"\")\r\nproposals=proposals.select_subclasses()\r\n\r\nnotification_template_pk=request_result_notification_prepare.POST.get(\"\",\"\")\r\nifnotification_template_pk:\r\nnotification_template=NotificationTemplate.objects.get(pk=notification_template_pk)\r\nelse:\r\nnotification_template=None\r\n\r\nctx={\r\n\"\":section_slug,\r\n\"\":status,\r\n\"\":notification_template,\r\n\"\":proposals,\r\n\"\":\"\".join([str(pk)forpkinproposal_pks]),\r\n}\r\nreturnrender(request_result_notification_prepare,\"\",ctx)\r\n\r\ndefaccept_staff_suggestion(staffId):\r\nreturn\r\n\r\n@login_required\r\ndefresult_notification_send(request_result_notification_send,section_slug,status):\r\nifrequest_result_notification_send.method!=\"\":\r\nreturnHttpResponseNotAllowed([\"\"])\r\n\r\nifnotrequest_result_notification_send.user.has_perm(\"\"%section_slug):\r\nreturnrender(request_result_notification_send,\"\",\"\")\r\n\r\nifnotall([kinrequest_result_notification_send.POSTforkin[\"\",\"\",\"\",\"\"]]):\r\nreturnHttpResponseBadRequest()\r\n\r\ntry:\r\nproposal_pks=[int(pk)forpkinrequest_result_notification_send.POST[\"\"].split(\"\")]\r\nexceptValueError:\r\nreturnHttpResponseBadRequest()\r\n\r\nproposals=ProposalBase.objects.filter(\r\nkind__section__slug=section_slug,\r\nresult__status=status,\r\n)\r\nproposals=proposals.filter(pk__in=proposal_pks)\r\nproposals=proposals.select_related(\"\",\"\")\r\nproposals=proposals.select_subclasses()\r\n\r\nnotification_template_pk=request_result_notification_send.POST.get(\"\",\"\")\r\nifnotification_template_pk:\r\nnotification_template=NotificationTemplate.objects.get(pk=notification_template_pk)\r\nelse:\r\nnotification_template=None\r\n\r\nemails=[]\r\n\r\nforproposalinproposals:\r\nrn=ResultNotification()\r\nrn.proposal=proposal\r\nrn.template=notification_template\r\nrn.to_address=proposal.speaker_email\r\nrn.from_address=request_result_notification_send.POST[\"\"]\r\nrn.subject=request_result_notification_send.POST[\"\"]\r\nrn.body=Template(request_result_notification_send.POST[\"\"]).render(\r\nContext({\r\n\"\":proposal.notification_email_context()\r\n})\r\n)\r\nrn.save()\r\nemails.append(rn.email_args)\r\n\r\nsend_mass_mail(emails)\r\n\r\nreturnredirect(\"\",section_slug=section_slug,status=status)\r\n\r\n\r\n\r\n@login_required\r\ndefreview_staff_comment(request_review_staff_comment,section_slug):\r\nifnotrequest_review_staff_comment.user.has_perm(\"\"%section_slug):\r\nreturnrender(request_review_staff_comment,\"\",\"\")\r\nifrequest_review_staff_comment.method==\"\":\r\nform=StaffCommentForm(request_review_staff_comment.POST)\r\n#TODO:completeimplementationofstaffcommentform-splitandmarkaccepted\r\nifform.": [
    [
      -0.001617225492196763,
      [
        "is",
        "_",
        "valid",
        " else",
        " ",
        "Staff",
        "Comment",
        "Form",
        "(",
        "request",
        "_",
        "review",
        "_",
        "staff",
        "_",
        "comment",
        ".",
        "POST",
        ")",
        " if",
        " form",
        ".",
        "is",
        "_"
      ]
    ],
    [
      -0.0022325897021068996,
      [
        "fields",
        "[",
        "<STR_LIT>",
        "]==",
        "<STR_LIT>",
        " else",
        " ",
        "Staff",
        "Comment",
        "Form",
        "(",
        "request",
        "_",
        "review",
        "_",
        "staff",
        "_",
        "comment",
        ".",
        "POST",
        ")",
        " if",
        " form",
        "."
      ]
    ],
    [
      -0.0024932413555278947,
      [
        "has",
        "_",
        "changed",
        "()",
        " else",
        " ",
        "Staff",
        "Comment",
        "Form",
        "(",
        "request",
        "_",
        "review",
        "_",
        "staff",
        "_",
        "comment",
        ".",
        "POST",
        ")",
        " if",
        " form",
        ".",
        "has"
      ]
    ],
    [
      -0.0025410043934974602,
      [
        "is",
        "_",
        "valid",
        "()",
        " else",
        " ",
        "Staff",
        "Comment",
        "Form",
        "(",
        "request",
        "_",
        "review",
        "_",
        "staff",
        "_",
        "comment",
        ".",
        "POST",
        ")",
        " if",
        " form",
        ".",
        "is"
      ]
    ],
    [
      -0.004338091442269325,
      [
        "fields",
        ".",
        "has",
        "_",
        "key",
        "(",
        "<STR_LIT>",
        ")",
        " else",
        " ",
        "Staff",
        "Comment",
        "Form",
        "(",
        "request",
        "_",
        "review",
        "_",
        "staff",
        "_",
        "comment",
        ".",
        "POST",
        ")"
      ]
    ],
    [
      -0.004395812598590886,
      [
        "is",
        "_",
        "valid",
        " else",
        " ",
        "Staff",
        "Comment",
        "Form",
        "()",
        "<endofline>"
      ]
    ],
    [
      -0.004404704634758059,
      [
        "is",
        "_",
        "valid",
        "()",
        " else",
        " ",
        "Staff",
        "Comment",
        "Form",
        "()",
        "<endofline>"
      ]
    ],
    [
      -0.0045113967074124055,
      [
        "cleaned",
        "_",
        "data",
        " else",
        " ",
        "Staff",
        "Comment",
        "Form",
        "()",
        "<endofline>"
      ]
    ],
    [
      -0.004564532872015598,
      [
        "cleaned",
        "_",
        "data",
        " else",
        " None",
        "<endofline>"
      ]
    ],
    [
      -0.004897036310333878,
      [
        "has",
        "_",
        "changed",
        "_",
        "data",
        "()",
        " else",
        " ",
        "Staff",
        "Comment",
        "Form",
        "(",
        "request",
        "_",
        "review",
        "_",
        "staff",
        "_",
        "comment",
        ".",
        "POST",
        ")",
        " if",
        " form"
      ]
    ],
    [
      -0.005056708034161213,
      [
        "is",
        "_",
        "valid",
        " else",
        " None",
        "<unk>",
        "<endofline>"
      ]
    ],
    [
      -0.005282312911312568,
      [
        "fields",
        " else",
        " ",
        "Staff",
        "Comment",
        "Form",
        "()",
        "<endofline>"
      ]
    ],
    [
      -0.005431060088776504,
      [
        "fields",
        "[",
        "<STR_LIT>",
        "]==",
        "<STR_LIT>",
        " else",
        " ",
        "Staff",
        "Comment",
        "Form",
        "(",
        "request",
        "_",
        "review",
        "_",
        "staff",
        "_",
        "comment",
        ".",
        "POST",
        ")",
        "<endofline>"
      ]
    ],
    [
      -0.005872237266551422,
      [
        "is",
        "_",
        "valid",
        " else",
        " None",
        "<endofline>"
      ]
    ],
    [
      -0.005886031220399841,
      [
        "cleaned",
        "_",
        "data",
        " else",
        " None",
        "<unk>",
        "<endofline>"
      ]
    ]
  ],
  "fromdjango.core.mailimportsend_mass_mail\r\nfromdjango.db.modelsimportQ\r\nfromdjango.httpimportHttpResponseBadRequest,HttpResponseNotAllowed\r\nfromdjango.shortcutsimportrender,redirect,get_object_or_404\r\nfromdjango.templateimportContext,Template\r\nfromdjango.views.decorators.httpimportrequire_POST\r\n\r\nfromaccount.decoratorsimportlogin_required\r\n\r\n#@@@switchtopinax-teams\r\nfromsymposion.teams.modelsimportTeam\r\n\r\nfromsymposion.confimportsettings\r\nfromsymposion.proposals.modelsimportProposalBase,ProposalSection\r\nfromsymposion.utils.mailimportsend_email\r\n\r\nfromsymposion.reviews.formsimportReviewForm,SpeakerCommentForm\r\nfromsymposion.reviews.formsimportBulkPresentationForm\r\nfromsymposion.reviews.formsimportStaffCommentForm\r\nfromsymposion.reviews.modelsimport(\r\nReviewAssignment,Review,LatestVote,ProposalResult,NotificationTemplate,\r\nResultNotification\r\n)\r\n\r\n\r\ndefproposals_generator(request,queryset,user_pk=None,check_speaker=True):\r\n\r\nforobjinqueryset:\r\n#@@@thissucks;wecandobetter\r\nifcheck_speaker:\r\nifrequest.userin[s.userforsinobj.speakers()]:\r\ncontinue\r\n\r\ntry:\r\nobj.result\r\nexceptProposalResult.DoesNotExist:\r\nProposalResult.objects.get_or_create(proposal=obj)\r\n\r\nobj.comment_count=obj.result.comment_count\r\nobj.total_votes=obj.result.vote_count\r\nobj.plus_one=obj.result.plus_one\r\nobj.plus_zero=obj.result.plus_zero\r\nobj.minus_zero=obj.result.minus_zero\r\nobj.minus_one=obj.result.minus_one\r\nlookup_params=dict(proposal=obj)\r\n\r\nifuser_pk:\r\nlookup_params[\"\"]=user_pk\r\nelse:\r\nlookup_params[\"\"]=request.user\r\n\r\ntry:\r\nobj.user_vote=LatestVote.objects.get(**lookup_params).vote\r\nobj.user_vote_css=LatestVote.objects.get(**lookup_params).css_class()\r\nexceptLatestVote.DoesNotExist:\r\nobj.user_vote=None\r\nobj.user_vote_css=\"\"\r\n\r\nyieldobj\r\n\r\ndefaccess_not_permitted(request,error_message):\r\nreturnrender(request,\"\",error_message)\r\n\r\n\r\n#Returnsalistofallproposals,proposalsreviewedbytheuser,ortheproposalstheuserhas\r\n#yettoreviewdependingonthelinkuserclicksindashboard\r\n@login_required\r\ndefreview_section(request_review,section_slug,assigned=False,reviewed=\"\"):\r\n\r\nifnotrequest_review.user.has_perm(\"\"%section_slug):\r\nreturnrender(request_review,\"\",\"\")\r\n\r\nsection=get_object_or_404(ProposalSection,section__slug=section_slug)\r\nqueryset=ProposalBase.objects.filter(kind__section=section.section)\r\n\r\nifassigned:\r\nassignments=ReviewAssignment.objects.filter(user=request_review.user)\\\r\n.values_list(\"\")\r\nqueryset=queryset.filter(id__in=assignments)\r\n\r\n#passingreviewedinfromreviews.urlsandouttoreview_listfor\r\n#appropriatetemplateheaderrendering\r\nifreviewed==\"\":\r\nqueryset=queryset.select_related(\"\").select_subclasses()\r\nreviewed=\"\"\r\nelifreviewed==\"\":\r\nqueryset=queryset.filter(reviews__user=request_review.user)\r\nreviewed=\"\"\r\nelse:\r\nqueryset=queryset.exclude(reviews__user=request_review.user).exclude(\r\nspeaker__user=request_review.user)\r\nreviewed=\"\"\r\n\r\nproposals=proposals_generator(request_review,queryset)\r\n\r\nctx={\r\n\"\":proposals,\r\n\"\":section,\r\n\"\":reviewed,\r\n}\r\n\r\nreturnrender(request_review,\"\",ctx)\r\n\r\n\r\n@login_required\r\ndefreview_list(request_review_list,section_slug,user_pk):\r\n\r\n#ifthey''tthepersonwhose\r\n#reviewlistisbeingaskedfor,don'tletthemin\r\nifnotrequest_review_list.user.has_perm(\"\"%section_slug):\r\nifnotrequest_review_list.user.pk==user_pk:\r\nreturnrender(request_review_list,\"\",\"\")\r\n\r\nqueryset=ProposalBase.objects.select_related(\"\",\"\")\r\nreviewed=LatestVote.objects.filter(user__pk=user_pk).values_list(\"\",flat=True)\r\nqueryset=queryset.filter(pk__in=reviewed)\r\nproposals=queryset.order_by(\"\")\r\n\r\nadmin=request_review_list.user.has_perm(\"\"%section_slug)\r\n\r\nproposals=proposals_generator(request_review_list,proposals,user_pk=user_pk,check_speaker=notadmin)\r\n\r\nctx={\r\n\"\":proposals,\r\n}\r\nreturnrender(request_review_list,\"\",ctx)\r\n\r\n\r\n@login_required\r\ndefreview_admin(request_review_admin,section_slug):\r\n\r\nifnotrequest_review_admin.user.has_perm(\"\"%section_slug):\r\nreturnrender(request_review_admin,\"\",\"\")\r\n\r\ndefreviewers():\r\nalready_seen=set()\r\n\r\nforteaminTeam.objects.filter(permissions__codename=\"\"%section_slug):\r\nformembershipinteam.memberships.filter(Q(state=\"\")|Q(state=\"\")):\r\nuser=membership.user\r\nifuser.pkinalready_seen:\r\ncontinue\r\nalready_seen.add(user.pk)\r\n\r\nuser.comment_count=Review.objects.filter(user=user).count()\r\nuser.total_votes=LatestVote.objects.filter(user=user).count()\r\nuser.plus_one=LatestVote.objects.filter(\r\nuser=user,\r\nvote=LatestVote.VOTES.PLUS_ONE\r\n).count()\r\nuser.plus_zero=LatestVote.objects.filter(\r\nuser=user,\r\nvote=LatestVote.VOTES.PLUS_ZERO\r\n).count()\r\nuser.minus_zero=LatestVote.objects.filter(\r\nuser=user,\r\nvote=LatestVote.VOTES.MINUS_ZERO\r\n).count()\r\nuser.minus_one=LatestVote.objects.filter(\r\nuser=user,\r\nvote=LatestVote.VOTES.MINUS_ONE\r\n).count()\r\n\r\nyielduser\r\n\r\nctx={\r\n\"\":section_slug,\r\n\"\":reviewers(),\r\n}\r\nreturnrender(request_review_admin,\"\",ctx)\r\n\r\n@login_required\r\ndefreview_detail(request_review_detail,pk):\r\n\r\nproposals=ProposalBase.objects.select_related(\"\").select_subclasses()\r\nproposal=get_object_or_404(proposals,pk=pk)\r\n\r\nifnotrequest_review_detail.user.has_perm(\"\"%proposal.kind.section.slug):\r\nreturnrender(request_review_detail,\"\",\"\")\r\n\r\nspeakers=[s.userforsinproposal.speakers()]\r\n\r\nifnotrequest_review_detail.user.is_superuserandrequest_review_detail.userinspeakers:\r\nreturnrender(request_review_detail,\"\",\"\")\r\n\r\nadmin=request_review_detail.user.is_staff\r\n\r\ntry:\r\nlatest_vote=LatestVote.objects.get(proposal=proposal,user=request_review_detail.user)\r\nexceptLatestVote.DoesNotExist:\r\nlatest_vote=None\r\n\r\nifrequest_review_detail.method==\"\":\r\nifrequest_review_detail.userinspeakers:\r\nreturnrender(request_review_detail,\"\",\"\")\r\n\r\nif\"\"inrequest_review_detail.POST:\r\nreview_form=ReviewForm(request_review_detail.POST)\r\nifreview_form.is_valid():\r\n\r\nreview=review_form.save(commit=False)\r\nreview.user=request_review_detail.user\r\nreview.proposal=proposal\r\nreview.save()\r\n\r\nreturnredirect(request_review_detail.path)\r\nelse:\r\nmessage_form=SpeakerCommentForm()\r\nelif\"\"inrequest_review_detail.POST:\r\nmessage_form=SpeakerCommentForm(request_review_detail.POST)\r\nifmessage_form.is_valid():\r\n\r\nmessage=message_form.save(commit=False)\r\nmessage.user=request_review_detail.user\r\nmessage.proposal=proposal\r\nmessage.save()\r\n\r\nforspeakerinspeakers:\r\nifspeakerandspeaker.email:\r\nctx={\r\n\"\":proposal,\r\n\"\":message,\r\n\"\":False,\r\n}\r\nsend_email(\r\n[speaker.email],\"\",\r\ncontext=ctx\r\n)\r\n\r\nreturnredirect(request_review_detail.path)\r\nelse:\r\ninitial={}\r\niflatest_vote:\r\ninitial[\"\"]=latest_vote.vote\r\nifrequest_review_detail.userinspeakers:\r\nreview_form=None\r\nelse:\r\nreview_form=ReviewForm(initial=initial)\r\nelif\"\"inrequest_review_detail.POST:\r\nifadmin:\r\nresult=request_review_detail.POST[\"\"]\r\n\r\nifresult==\"\":\r\nproposal.result.status=\"\"\r\nproposal.result.save()\r\nelifresult==\"\":\r\nproposal.result.status=\"\"\r\nproposal.result.save()\r\nelifresult==\"\":\r\nproposal.result.status=\"\"\r\nproposal.result.save()\r\nelifresult==\"\":\r\nproposal.result.status=\"\"\r\nproposal.result.save()\r\n\r\nreturnredirect(request_review_detail.path)\r\nelse:\r\ninitial={}\r\niflatest_vote:\r\ninitial[\"\"]=latest_vote.vote\r\nifrequest_review_detail.userinspeakers:\r\nreview_form=None\r\nelse:\r\nreview_form=ReviewForm(initial=initial)\r\nmessage_form=SpeakerCommentForm()\r\n\r\nproposal.comment_count=proposal.result.comment_count\r\nproposal.total_votes=proposal.result.vote_count\r\nproposal.plus_one=proposal.result.plus_one\r\nproposal.plus_zero=proposal.result.plus_zero\r\nproposal.minus_zero=proposal.result.minus_zero\r\nproposal.minus_one=proposal.result.minus_one\r\n\r\nreviews=Review.objects.filter(proposal=proposal).order_by(\"\")\r\nmessages=proposal.messages.order_by(\"\")\r\n\r\nreturnrender(request_review_detail,\"\",{\r\n\"\":proposal,\r\n\"\":latest_vote,\r\n\"\":reviews,\r\n\"\":messages,\r\n\"\":review_form,\r\n\"\":message_form\r\n})\r\n\r\n\r\n@login_required\r\n@require_POST\r\ndefreview_delete(request_delete,pk):\r\nreview=get_object_or_404(Review,pk=pk)\r\nsection_slug=review.section.slug\r\n\r\nifnotrequest_delete.user.has_perm(\"\"%section_slug):\r\nreturnrender(request_delete,\"\",\"\")\r\n\r\nreview=get_object_or_404(Review,pk=pk)\r\nreview.delete()\r\n\r\nreturnredirect(\"\",pk=review.proposal.pk)\r\n\r\n\r\n@login_required\r\ndefreview_status(request_review_status,section_slug=None,key=None):\r\n\r\nifnotrequest_review_status.user.has_perm(\"\"%section_slug):\r\nreturnrender(request_review_status,\"\",\"\")\r\n\r\nVOTE_THRESHOLD=settings.SYMPOSION_VOTE_THRESHOLD\r\n\r\nctx={\r\n\"\":section_slug,\r\n\"\":VOTE_THRESHOLD,\r\n}\r\n\r\nqueryset=ProposalBase.objects.select_related(\"\",\"\").select_subclasses()\r\nifsection_slug:\r\nqueryset=queryset.filter(kind__section__slug=section_slug)\r\n\r\nproposals={\r\n#proposalswithatleastVOTE_THRESHOLDreviewsandatleastone+1andno-1s,sortedby\r\n#the''\r\n\"\":queryset.filter(result__vote_count__gte=VOTE_THRESHOLD,result__plus_one__gt=0,\r\nresult__minus_one=0).order_by(\"\"),\r\n#proposalswithatleastVOTE_THRESHOLDreviewsandatleastone-1andno+1s,reverse\r\n#sortedbythe''\r\n\"\":queryset.filter(result__vote_count__gte=VOTE_THRESHOLD,result__minus_one__gt=0,\r\nresult__plus_one=0).order_by(\"\"),\r\n#proposalswithatleastVOTE_THRESHOLDreviewsandneithera+1ora-1,sortedbytotal\r\n#votes(lowestfirst)\r\n\"\":queryset.filter(result__vote_count__gte=VOTE_THRESHOLD,result__minus_one=0,\r\nresult__plus_one=0).order_by(\"\"),\r\n#proposalswithatleastVOTE_THRESHOLDreviewsandbotha+1and-1,sortedbytotal\r\n#votes(highestfirst)\r\n\"\":queryset.filter(result__vote_count__gte=VOTE_THRESHOLD,\r\nresult__plus_one__gt=0,result__minus_one__gt=0)\r\n.order_by(\"\"),\r\n#proposalswithfewerthanVOTE_THRESHOLDreviews\r\n\"\":queryset.filter(result__vote_count__lt=VOTE_THRESHOLD)\r\n.order_by(\"\"),\r\n}\r\n\r\nadmin=request_review_status.user.has_perm(\"\"%section_slug)\r\n\r\nforstatusinproposals:\r\nifkeyandkey!=status:\r\ncontinue\r\nproposals[status]=list(proposals_generator(request_review_status,proposals[status],check_speaker=notadmin))\r\n\r\nifkey:\r\nctx.update({\r\n\"\":key,\r\n\"\":proposals[key],\r\n})\r\nelse:\r\nctx[\"\"]=proposals\r\n\r\nreturnrender(request_review_status,\"\",ctx)\r\n\r\n\r\n@login_required\r\ndefreview_assignments(request_review_assignments):\r\nifnotrequest_review_assignments.user.groups.filter(name=\"\").exists():\r\nreturnrender(request_review_assignments,\"\",\"\")\r\nassignments=ReviewAssignment.objects.filter(\r\nuser=request_review_assignments.user,\r\nopted_out=False\r\n)\r\nreturnrender(request_review_assignments,\"\",{\r\n\"\":assignments,\r\n})\r\n\r\n\r\n@login_required\r\n@require_POST\r\ndefreview_assignment_opt_out(request_review_assignment_opt_out,pk):\r\nreview_assignment=get_object_or_404(\r\nReviewAssignment,pk=pk,user=request_review_assignment_opt_out.user)\r\nifnotreview_assignment.opted_out:\r\nreview_assignment.opted_out=True\r\nreview_assignment.save()\r\nReviewAssignment.create_assignments(\r\nreview_assignment.proposal,origin=ReviewAssignment.AUTO_ASSIGNED_LATER)\r\nreturnredirect(\"\")\r\n\r\n\r\n@login_required\r\ndefreview_bulk_accept(request_review_bulk_accept,section_slug):\r\nifnotrequest_review_bulk_accept.user.has_perm(\"\"%section_slug):\r\nreturnrender(request_review_bulk_accept,\"\",\"\")\r\nifrequest_review_bulk_accept.method==\"\":\r\nform=BulkPresentationForm(request_review_bulk_accept.POST)\r\nifform.is_valid():\r\ntalk_ids=form.cleaned_data[\"\"].split(\"\")\r\ntalks=ProposalBase.objects.filter(id__in=talk_ids).select_related(\"\")\r\nfortalkintalks:\r\ntalk.result.status=\"\"\r\ntalk.result.save()\r\nreturnredirect(\"\",section_slug=section_slug)\r\nelse:\r\nform=BulkPresentationForm()\r\n\r\nreturnrender(request_review_bulk_accept,\"\",{\r\n\"\":form,\r\n})\r\n\r\n\r\n@login_required\r\ndefresult_notification(request_result_notification,section_slug,status):\r\nifnotrequest_result_notification.user.has_perm(\"\"%section_slug):\r\nreturnrender(request_result_notification,\"\",\"\")\r\n\r\nproposals=ProposalBase.objects.filter(kind__section__slug=section_slug,result__status=status).select_related(\"\",\"\").select_subclasses()\r\nnotification_templates=NotificationTemplate.objects.all()\r\n\r\nctx={\r\n\"\":section_slug,\r\n\"\":status,\r\n\"\":proposals,\r\n\"\":notification_templates,\r\n}\r\nreturnrender(request_result_notification,\"\",ctx)\r\n\r\n\r\n@login_required\r\ndefresult_notification_prepare(request_result_notification_prepare,section_slug,status):\r\nifrequest_result_notification_prepare.method!=\"\":\r\nreturnHttpResponseNotAllowed([\"\"])\r\n\r\nifnotrequest_result_notification_prepare.user.has_perm(\"\"%section_slug):\r\nreturnrender(request_result_notification_prepare,\"\",\"\")\r\n\r\nproposal_pks=[]\r\ntry:\r\nforpkinrequest_result_notification_prepare.POST.getlist(\"\"):\r\nproposal_pks.append(int(pk))\r\nexceptValueError:\r\nreturnHttpResponseBadRequest()\r\nproposals=ProposalBase.objects.filter(\r\nkind__section__slug=section_slug,\r\nresult__status=status,\r\n)\r\nproposals=proposals.filter(pk__in=proposal_pks)\r\nproposals=proposals.select_related(\"\",\"\")\r\nproposals=proposals.select_subclasses()\r\n\r\nnotification_template_pk=request_result_notification_prepare.POST.get(\"\",\"\")\r\nifnotification_template_pk:\r\nnotification_template=NotificationTemplate.objects.get(pk=notification_template_pk)\r\nelse:\r\nnotification_template=None\r\n\r\nctx={\r\n\"\":section_slug,\r\n\"\":status,\r\n\"\":notification_template,\r\n\"\":proposals,\r\n\"\":\"\".join([str(pk)forpkinproposal_pks]),\r\n}\r\nreturnrender(request_result_notification_prepare,\"\",ctx)\r\n\r\ndefaccept_staff_suggestion(staffId):\r\nreturn\r\n\r\n@login_required\r\ndefresult_notification_send(request_result_notification_send,section_slug,status):\r\nifrequest_result_notification_send.method!=\"\":\r\nreturnHttpResponseNotAllowed([\"\"])\r\n\r\nifnotrequest_result_notification_send.user.has_perm(\"\"%section_slug):\r\nreturnrender(request_result_notification_send,\"\",\"\")\r\n\r\nifnotall([kinrequest_result_notification_send.POSTforkin[\"\",\"\",\"\",\"\"]]):\r\nreturnHttpResponseBadRequest()\r\n\r\ntry:\r\nproposal_pks=[int(pk)forpkinrequest_result_notification_send.POST[\"\"].split(\"\")]\r\nexceptValueError:\r\nreturnHttpResponseBadRequest()\r\n\r\nproposals=ProposalBase.objects.filter(\r\nkind__section__slug=section_slug,\r\nresult__status=status,\r\n)\r\nproposals=proposals.filter(pk__in=proposal_pks)\r\nproposals=proposals.select_related(\"\",\"\")\r\nproposals=proposals.select_subclasses()\r\n\r\nnotification_template_pk=request_result_notification_send.POST.get(\"\",\"\")\r\nifnotification_template_pk:\r\nnotification_template=NotificationTemplate.objects.get(pk=notification_template_pk)\r\nelse:\r\nnotification_template=None\r\n\r\nemails=[]\r\n\r\nforproposalinproposals:\r\nrn=ResultNotification()\r\nrn.proposal=proposal\r\nrn.template=notification_template\r\nrn.to_address=proposal.speaker_email\r\nrn.from_address=request_result_notification_send.POST[\"\"]\r\nrn.subject=request_result_notification_send.POST[\"\"]\r\nrn.body=Template(request_result_notification_send.POST[\"\"]).render(\r\nContext({\r\n\"\":proposal.notification_email_context()\r\n})\r\n)\r\nrn.save()\r\nemails.append(rn.email_args)\r\n\r\nsend_mass_mail(emails)\r\n\r\nreturnredirect(\"\",section_slug=section_slug,status=status)\r\n\r\n\r\n\r\n@login_required\r\ndefreview_staff_comment(request_review_staff_comment,section_slug):\r\nifnotrequest_review_staff_comment.user.has_perm(\"\"%section_slug):\r\nreturnrender(request_review_staff_comment,\"\",\"\")\r\nifrequest_review_staff_comment.method==\"\":\r\nform=StaffCommentForm(request_review_staff_comment.POST)\r\n#TODO:completeimplementationofstaffcommentform-splitandmarkaccepted\r\nifform.is_valid():": [    
  ],
  "fromdjango.core.mailimportsend_mass_mail\r\nfromdjango.db.modelsimportQ\r\nfromdjango.httpimportHttpResponseBadRequest,HttpResponseNotAllowed\r\nfromdjango.shortcutsimportrender,redirect,get_object_or_404\r\nfromdjango.templateimportContext,Template\r\nfromdjango.views.decorators.httpimportrequire_POST\r\n\r\nfromaccount.decoratorsimportlogin_required\r\n\r\n#@@@switchtopinax-teams\r\nfromsymposion.teams.modelsimportTeam\r\n\r\nfromsymposion.confimportsettings\r\nfromsymposion.proposals.modelsimportProposalBase,ProposalSection\r\nfromsymposion.utils.mailimportsend_email\r\n\r\nfromsymposion.reviews.formsimportReviewForm,SpeakerCommentForm\r\nfromsymposion.reviews.formsimportBulkPresentationForm\r\nfromsymposion.reviews.formsimportStaffCommentForm\r\nfromsymposion.reviews.modelsimport(\r\nReviewAssignment,Review,LatestVote,ProposalResult,NotificationTemplate,\r\nResultNotification\r\n)\r\n\r\n\r\ndefproposals_generator(request,queryset,user_pk=None,check_speaker=True):\r\n\r\nforobjinqueryset:\r\n#@@@thissucks;wecandobetter\r\nifcheck_speaker:\r\nifrequest.userin[s.userforsinobj.speakers()]:\r\ncontinue\r\n\r\ntry:\r\nobj.result\r\nexceptProposalResult.DoesNotExist:\r\nProposalResult.objects.get_or_create(proposal=obj)\r\n\r\nobj.comment_count=obj.result.comment_count\r\nobj.total_votes=obj.result.vote_count\r\nobj.plus_one=obj.result.plus_one\r\nobj.plus_zero=obj.result.plus_zero\r\nobj.minus_zero=obj.result.minus_zero\r\nobj.minus_one=obj.result.minus_one\r\nlookup_params=dict(proposal=obj)\r\n\r\nifuser_pk:\r\nlookup_params[\"\"]=user_pk\r\nelse:\r\nlookup_params[\"\"]=request.user\r\n\r\ntry:\r\nobj.user_vote=LatestVote.objects.get(**lookup_params).vote\r\nobj.user_vote_css=LatestVote.objects.get(**lookup_params).css_class()\r\nexceptLatestVote.DoesNotExist:\r\nobj.user_vote=None\r\nobj.user_vote_css=\"\"\r\n\r\nyieldobj\r\n\r\ndefaccess_not_permitted(request,error_message):\r\nreturnrender(request,\"\",error_message)\r\n\r\n\r\n#Returnsalistofallproposals,proposalsreviewedbytheuser,ortheproposalstheuserhas\r\n#yettoreviewdependingonthelinkuserclicksindashboard\r\n@login_required\r\ndefreview_section(request_review,section_slug,assigned=False,reviewed=\"\"):\r\n\r\nifnotrequest_review.user.has_perm(\"\"%section_slug):\r\nreturnrender(request_review,\"\",\"\")\r\n\r\nsection=get_object_or_404(ProposalSection,section__slug=section_slug)\r\nqueryset=ProposalBase.objects.filter(kind__section=section.section)\r\n\r\nifassigned:\r\nassignments=ReviewAssignment.objects.filter(user=request_review.user)\\\r\n.values_list(\"\")\r\nqueryset=queryset.filter(id__in=assignments)\r\n\r\n#passingreviewedinfromreviews.urlsandouttoreview_listfor\r\n#appropriatetemplateheaderrendering\r\nifreviewed==\"\":\r\nqueryset=queryset.select_related(\"\").select_subclasses()\r\nreviewed=\"\"\r\nelifreviewed==\"\":\r\nqueryset=queryset.filter(reviews__user=request_review.user)\r\nreviewed=\"\"\r\nelse:\r\nqueryset=queryset.exclude(reviews__user=request_review.user).exclude(\r\nspeaker__user=request_review.user)\r\nreviewed=\"\"\r\n\r\nproposals=proposals_generator(request_review,queryset)\r\n\r\nctx={\r\n\"\":proposals,\r\n\"\":section,\r\n\"\":reviewed,\r\n}\r\n\r\nreturnrender(request_review,\"\",ctx)\r\n\r\n\r\n@login_required\r\ndefreview_list(request_review_list,section_slug,user_pk):\r\n\r\n#ifthey''tthepersonwhose\r\n#reviewlistisbeingaskedfor,don'tletthemin\r\nifnotrequest_review_list.user.has_perm(\"\"%section_slug):\r\nifnotrequest_review_list.user.pk==user_pk:\r\nreturnrender(request_review_list,\"\",\"\")\r\n\r\nqueryset=ProposalBase.objects.select_related(\"\",\"\")\r\nreviewed=LatestVote.objects.filter(user__pk=user_pk).values_list(\"\",flat=True)\r\nqueryset=queryset.filter(pk__in=reviewed)\r\nproposals=queryset.order_by(\"\")\r\n\r\nadmin=request_review_list.user.has_perm(\"\"%section_slug)\r\n\r\nproposals=proposals_generator(request_review_list,proposals,user_pk=user_pk,check_speaker=notadmin)\r\n\r\nctx={\r\n\"\":proposals,\r\n}\r\nreturnrender(request_review_list,\"\",ctx)\r\n\r\n\r\n@login_required\r\ndefreview_admin(request_review_admin,section_slug):\r\n\r\nifnotrequest_review_admin.user.has_perm(\"\"%section_slug):\r\nreturnrender(request_review_admin,\"\",\"\")\r\n\r\ndefreviewers():\r\nalready_seen=set()\r\n\r\nforteaminTeam.objects.filter(permissions__codename=\"\"%section_slug):\r\nformembershipinteam.memberships.filter(Q(state=\"\")|Q(state=\"\")):\r\nuser=membership.user\r\nifuser.pkinalready_seen:\r\ncontinue\r\nalready_seen.add(user.pk)\r\n\r\nuser.comment_count=Review.objects.filter(user=user).count()\r\nuser.total_votes=LatestVote.objects.filter(user=user).count()\r\nuser.plus_one=LatestVote.objects.filter(\r\nuser=user,\r\nvote=LatestVote.VOTES.PLUS_ONE\r\n).count()\r\nuser.plus_zero=LatestVote.objects.filter(\r\nuser=user,\r\nvote=LatestVote.VOTES.PLUS_ZERO\r\n).count()\r\nuser.minus_zero=LatestVote.objects.filter(\r\nuser=user,\r\nvote=LatestVote.VOTES.MINUS_ZERO\r\n).count()\r\nuser.minus_one=LatestVote.objects.filter(\r\nuser=user,\r\nvote=LatestVote.VOTES.MINUS_ONE\r\n).count()\r\n\r\nyielduser\r\n\r\nctx={\r\n\"\":section_slug,\r\n\"\":reviewers(),\r\n}\r\nreturnrender(request_review_admin,\"\",ctx)\r\n\r\n@login_required\r\ndefreview_detail(request_review_detail,pk):\r\n\r\nproposals=ProposalBase.objects.select_related(\"\").select_subclasses()\r\nproposal=get_object_or_404(proposals,pk=pk)\r\n\r\nifnotrequest_review_detail.user.has_perm(\"\"%proposal.kind.section.slug):\r\nreturnrender(request_review_detail,\"\",\"\")\r\n\r\nspeakers=[s.userforsinproposal.speakers()]\r\n\r\nifnotrequest_review_detail.user.is_superuserandrequest_review_detail.userinspeakers:\r\nreturnrender(request_review_detail,\"\",\"\")\r\n\r\nadmin=request_review_detail.user.is_staff\r\n\r\ntry:\r\nlatest_vote=LatestVote.objects.get(proposal=proposal,user=request_review_detail.user)\r\nexceptLatestVote.DoesNotExist:\r\nlatest_vote=None\r\n\r\nifrequest_review_detail.method==\"\":\r\nifrequest_review_detail.userinspeakers:\r\nreturnrender(request_review_detail,\"\",\"\")\r\n\r\nif\"\"inrequest_review_detail.POST:\r\nreview_form=ReviewForm(request_review_detail.POST)\r\nifreview_form.is_valid():\r\n\r\nreview=review_form.save(commit=False)\r\nreview.user=request_review_detail.user\r\nreview.proposal=proposal\r\nreview.save()\r\n\r\nreturnredirect(request_review_detail.path)\r\nelse:\r\nmessage_form=SpeakerCommentForm()\r\nelif\"\"inrequest_review_detail.POST:\r\nmessage_form=SpeakerCommentForm(request_review_detail.POST)\r\nifmessage_form.is_valid():\r\n\r\nmessage=message_form.save(commit=False)\r\nmessage.user=request_review_detail.user\r\nmessage.proposal=proposal\r\nmessage.save()\r\n\r\nforspeakerinspeakers:\r\nifspeakerandspeaker.email:\r\nctx={\r\n\"\":proposal,\r\n\"\":message,\r\n\"\":False,\r\n}\r\nsend_email(\r\n[speaker.email],\"\",\r\ncontext=ctx\r\n)\r\n\r\nreturnredirect(request_review_detail.path)\r\nelse:\r\ninitial={}\r\niflatest_vote:\r\ninitial[\"\"]=latest_vote.vote\r\nifrequest_review_detail.userinspeakers:\r\nreview_form=None\r\nelse:\r\nreview_form=ReviewForm(initial=initial)\r\nelif\"\"inrequest_review_detail.POST:\r\nifadmin:\r\nresult=request_review_detail.POST[\"\"]\r\n\r\nifresult==\"\":\r\nproposal.result.status=\"\"\r\nproposal.result.save()\r\nelifresult==\"\":\r\nproposal.result.status=\"\"\r\nproposal.result.save()\r\nelifresult==\"\":\r\nproposal.result.status=\"\"\r\nproposal.result.save()\r\nelifresult==\"\":\r\nproposal.result.status=\"\"\r\nproposal.result.save()\r\n\r\nreturnredirect(request_review_detail.path)\r\nelse:\r\ninitial={}\r\niflatest_vote:\r\ninitial[\"\"]=latest_vote.vote\r\nifrequest_review_detail.userinspeakers:\r\nreview_form=None\r\nelse:\r\nreview_form=ReviewForm(initial=initial)\r\nmessage_form=SpeakerCommentForm()\r\n\r\nproposal.comment_count=proposal.result.comment_count\r\nproposal.total_votes=proposal.result.vote_count\r\nproposal.plus_one=proposal.result.plus_one\r\nproposal.plus_zero=proposal.result.plus_zero\r\nproposal.minus_zero=proposal.result.minus_zero\r\nproposal.minus_one=proposal.result.minus_one\r\n\r\nreviews=Review.objects.filter(proposal=proposal).order_by(\"\")\r\nmessages=proposal.messages.order_by(\"\")\r\n\r\nreturnrender(request_review_detail,\"\",{\r\n\"\":proposal,\r\n\"\":latest_vote,\r\n\"\":reviews,\r\n\"\":messages,\r\n\"\":review_form,\r\n\"\":message_form\r\n})\r\n\r\n\r\n@login_required\r\n@require_POST\r\ndefreview_delete(request_delete,pk):\r\nreview=get_object_or_404(Review,pk=pk)\r\nsection_slug=review.section.slug\r\n\r\nifnotrequest_delete.user.has_perm(\"\"%section_slug):\r\nreturnrender(request_delete,\"\",\"\")\r\n\r\nreview=get_object_or_404(Review,pk=pk)\r\nreview.delete()\r\n\r\nreturnredirect(\"\",pk=review.proposal.pk)\r\n\r\n\r\n@login_required\r\ndefreview_status(request_review_status,section_slug=None,key=None):\r\n\r\nifnotrequest_review_status.user.has_perm(\"\"%section_slug):\r\nreturnrender(request_review_status,\"\",\"\")\r\n\r\nVOTE_THRESHOLD=settings.SYMPOSION_VOTE_THRESHOLD\r\n\r\nctx={\r\n\"\":section_slug,\r\n\"\":VOTE_THRESHOLD,\r\n}\r\n\r\nqueryset=ProposalBase.objects.select_related(\"\",\"\").select_subclasses()\r\nifsection_slug:\r\nqueryset=queryset.filter(kind__section__slug=section_slug)\r\n\r\nproposals={\r\n#proposalswithatleastVOTE_THRESHOLDreviewsandatleastone+1andno-1s,sortedby\r\n#the''\r\n\"\":queryset.filter(result__vote_count__gte=VOTE_THRESHOLD,result__plus_one__gt=0,\r\nresult__minus_one=0).order_by(\"\"),\r\n#proposalswithatleastVOTE_THRESHOLDreviewsandatleastone-1andno+1s,reverse\r\n#sortedbythe''\r\n\"\":queryset.filter(result__vote_count__gte=VOTE_THRESHOLD,result__minus_one__gt=0,\r\nresult__plus_one=0).order_by(\"\"),\r\n#proposalswithatleastVOTE_THRESHOLDreviewsandneithera+1ora-1,sortedbytotal\r\n#votes(lowestfirst)\r\n\"\":queryset.filter(result__vote_count__gte=VOTE_THRESHOLD,result__minus_one=0,\r\nresult__plus_one=0).order_by(\"\"),\r\n#proposalswithatleastVOTE_THRESHOLDreviewsandbotha+1and-1,sortedbytotal\r\n#votes(highestfirst)\r\n\"\":queryset.filter(result__vote_count__gte=VOTE_THRESHOLD,\r\nresult__plus_one__gt=0,result__minus_one__gt=0)\r\n.order_by(\"\"),\r\n#proposalswithfewerthanVOTE_THRESHOLDreviews\r\n\"\":queryset.filter(result__vote_count__lt=VOTE_THRESHOLD)\r\n.order_by(\"\"),\r\n}\r\n\r\nadmin=request_review_status.user.has_perm(\"\"%section_slug)\r\n\r\nforstatusinproposals:\r\nifkeyandkey!=status:\r\ncontinue\r\nproposals[status]=list(proposals_generator(request_review_status,proposals[status],check_speaker=notadmin))\r\n\r\nifkey:\r\nctx.update({\r\n\"\":key,\r\n\"\":proposals[key],\r\n})\r\nelse:\r\nctx[\"\"]=proposals\r\n\r\nreturnrender(request_review_status,\"\",ctx)\r\n\r\n\r\n@login_required\r\ndefreview_assignments(request_review_assignments):\r\nifnotrequest_review_assignments.user.groups.filter(name=\"\").exists():\r\nreturnrender(request_review_assignments,\"\",\"\")\r\nassignments=ReviewAssignment.objects.filter(\r\nuser=request_review_assignments.user,\r\nopted_out=False\r\n)\r\nreturnrender(request_review_assignments,\"\",{\r\n\"\":assignments,\r\n})\r\n\r\n\r\n@login_required\r\n@require_POST\r\ndefreview_assignment_opt_out(request_review_assignment_opt_out,pk):\r\nreview_assignment=get_object_or_404(\r\nReviewAssignment,pk=pk,user=request_review_assignment_opt_out.user)\r\nifnotreview_assignment.opted_out:\r\nreview_assignment.opted_out=True\r\nreview_assignment.save()\r\nReviewAssignment.create_assignments(\r\nreview_assignment.proposal,origin=ReviewAssignment.AUTO_ASSIGNED_LATER)\r\nreturnredirect(\"\")\r\n\r\n\r\n@login_required\r\ndefreview_bulk_accept(request_review_bulk_accept,section_slug):\r\nifnotrequest_review_bulk_accept.user.has_perm(\"\"%section_slug):\r\nreturnrender(request_review_bulk_accept,\"\",\"\")\r\nifrequest_review_bulk_accept.method==\"\":\r\nform=BulkPresentationForm(request_review_bulk_accept.POST)\r\nifform.is_valid():\r\ntalk_ids=form.cleaned_data[\"\"].split(\"\")\r\ntalks=ProposalBase.objects.filter(id__in=talk_ids).select_related(\"\")\r\nfortalkintalks:\r\ntalk.result.status=\"\"\r\ntalk.result.save()\r\nreturnredirect(\"\",section_slug=section_slug)\r\nelse:\r\nform=BulkPresentationForm()\r\n\r\nreturnrender(request_review_bulk_accept,\"\",{\r\n\"\":form,\r\n})\r\n\r\n\r\n@login_required\r\ndefresult_notification(request_result_notification,section_slug,status):\r\nifnotrequest_result_notification.user.has_perm(\"\"%section_slug):\r\nreturnrender(request_result_notification,\"\",\"\")\r\n\r\nproposals=ProposalBase.objects.filter(kind__section__slug=section_slug,result__status=status).select_related(\"\",\"\").select_subclasses()\r\nnotification_templates=NotificationTemplate.objects.all()\r\n\r\nctx={\r\n\"\":section_slug,\r\n\"\":status,\r\n\"\":proposals,\r\n\"\":notification_templates,\r\n}\r\nreturnrender(request_result_notification,\"\",ctx)\r\n\r\n\r\n@login_required\r\ndefresult_notification_prepare(request_result_notification_prepare,section_slug,status):\r\nifrequest_result_notification_prepare.method!=\"\":\r\nreturnHttpResponseNotAllowed([\"\"])\r\n\r\nifnotrequest_result_notification_prepare.user.has_perm(\"\"%section_slug):\r\nreturnrender(request_result_notification_prepare,\"\",\"\")\r\n\r\nproposal_pks=[]\r\ntry:\r\nforpkinrequest_result_notification_prepare.POST.getlist(\"\"):\r\nproposal_pks.append(int(pk))\r\nexceptValueError:\r\nreturnHttpResponseBadRequest()\r\nproposals=ProposalBase.objects.filter(\r\nkind__section__slug=section_slug,\r\nresult__status=status,\r\n)\r\nproposals=proposals.filter(pk__in=proposal_pks)\r\nproposals=proposals.select_related(\"\",\"\")\r\nproposals=proposals.select_subclasses()\r\n\r\nnotification_template_pk=request_result_notification_prepare.POST.get(\"\",\"\")\r\nifnotification_template_pk:\r\nnotification_template=NotificationTemplate.objects.get(pk=notification_template_pk)\r\nelse:\r\nnotification_template=None\r\n\r\nctx={\r\n\"\":section_slug,\r\n\"\":status,\r\n\"\":notification_template,\r\n\"\":proposals,\r\n\"\":\"\".join([str(pk)forpkinproposal_pks]),\r\n}\r\nreturnrender(request_result_notification_prepare,\"\",ctx)\r\n\r\ndefaccept_staff_suggestion(staffId):\r\nreturn\r\n\r\n@login_required\r\ndefresult_notification_send(request_result_notification_send,section_slug,status):\r\nifrequest_result_notification_send.method!=\"\":\r\nreturnHttpResponseNotAllowed([\"\"])\r\n\r\nifnotrequest_result_notification_send.user.has_perm(\"\"%section_slug):\r\nreturnrender(request_result_notification_send,\"\",\"\")\r\n\r\nifnotall([kinrequest_result_notification_send.POSTforkin[\"\",\"\",\"\",\"\"]]):\r\nreturnHttpResponseBadRequest()\r\n\r\ntry:\r\nproposal_pks=[int(pk)forpkinrequest_result_notification_send.POST[\"\"].split(\"\")]\r\nexceptValueError:\r\nreturnHttpResponseBadRequest()\r\n\r\nproposals=ProposalBase.objects.filter(\r\nkind__section__slug=section_slug,\r\nresult__status=status,\r\n)\r\nproposals=proposals.filter(pk__in=proposal_pks)\r\nproposals=proposals.select_related(\"\",\"\")\r\nproposals=proposals.select_subclasses()\r\n\r\nnotification_template_pk=request_result_notification_send.POST.get(\"\",\"\")\r\nifnotification_template_pk:\r\nnotification_template=NotificationTemplate.objects.get(pk=notification_template_pk)\r\nelse:\r\nnotification_template=None\r\n\r\nemails=[]\r\n\r\nforproposalinproposals:\r\nrn=ResultNotification()\r\nrn.proposal=proposal\r\nrn.template=notification_template\r\nrn.to_address=proposal.speaker_email\r\nrn.from_address=request_result_notification_send.POST[\"\"]\r\nrn.subject=request_result_notification_send.POST[\"\"]\r\nrn.body=Template(request_result_notification_send.POST[\"\"]).render(\r\nContext({\r\n\"\":proposal.notification_email_context()\r\n})\r\n)\r\nrn.save()\r\nemails.append(rn.email_args)\r\n\r\nsend_mass_mail(emails)\r\n\r\nreturnredirect(\"\",section_slug=section_slug,status=status)\r\n\r\n\r\n\r\n@login_required\r\ndefreview_staff_comment(request_review_staff_comment,section_slug):\r\nifnotrequest_review_staff_comment.user.has_perm(\"\"%section_slug):\r\nreturnrender(request_review_staff_comment,\"\",\"\")\r\nifrequest_review_staff_comment.method==\"\":\r\nform=StaffCommentForm(request_review_staff_comment.POST)\r\n#TODO:completeimplementationofstaffcommentform-splitandmarkaccepted\r\nifform.is_valid():\r\nstaff_ids=": [
    [
      -0.0000017745726985489038,
      [
        "form",
        ".",
        "cleaned",
        "_",
        "data",
        ".",
        "get",
        "(",
        "<STR_LIT>",
        ")",
        ".",
        "split",
        "(",
        "\",\"",
        ")",
        "<endofline>"
      ]
    ]
  ],
  "from__future__importunicode_literals\r\nfromdjangoimportforms\r\nfromdjango.utils.translationimportugettext_lazyas_\r\n\r\nfromsymposion.reviews.modelsimportReview,Comment,ProposalMessage,VOTES\r\n\r\nclassReviewCommentForm(forms.ModelForm):\r\nclassMeta:\r\nmodel=Comment\r\nfields=[\"\"]\r\nclassBulkPresentationForm(forms.Form):\r\ntalk_ids=forms.CharField(\r\nlabel=_(\"\"),\r\nmax_length=500,\r\nhelp_text=_(\"\")\r\n)\r\nclassFeedbackForm(forms.Form):\r\nfeedback_id=forms.CharField(\r\nlabel=_(\"\"),\r\nmax_length=500,\r\nhelp_text=_(\"\")\r\n)\r\nclassSpeakerFeedbackForm(forms.Form):\r\nfeedback_id=forms.CharField(\r\nlabel=_(\"\"),\r\nmax_length=500,\r\nhelp_text=_(\"\")\r\n)\r\nclassContingentFeedbackForm(forms.Form):\r\nfeedback_id=forms.CharField(\r\nlabel=_(\"\"),\r\nmax_length=500,\r\nhelp_text=_(\"\")\r\n)\r\n\r\nclassReviewForm(forms.ModelForm):\r\nclassMeta:\r\nmodel=Review\r\nfields=[\"\",\"\"]\r\n\r\ndef__init__(self,*args,**kwargs):\r\nsuper(ReviewForm,self).__init__(*args,**kwargs)\r\nself.fields[\"\"]=forms.ChoiceField(\r\nwidget=forms.RadioSelect(),\r\nchoices=VOTES.CHOICES\r\n)\r\n\r\nclassSpeakerCommentForm(forms.ModelForm):\r\nclassMeta:\r\nmodel=ProposalMessage\r\nfields=[\"\"]\r\n\r\n#TODO:Addstaffreviewform\r\nclassStaffFeedbackForm(": [
    [
      -0.0009016260181828407,
      [
        "forms",
        ".",
        "Form",
        "):",
        "<endofline>"
      ]
    ]
  ],
  "from__future__importunicode_literals\r\nfromdjangoimportforms\r\nfromdjango.utils.translationimportugettext_lazyas_\r\n\r\nfromsymposion.reviews.modelsimportReview,Comment,ProposalMessage,VOTES\r\n\r\nclassReviewCommentForm(forms.ModelForm):\r\nclassMeta:\r\nmodel=Comment\r\nfields=[\"\"]\r\nclassBulkPresentationForm(forms.Form):\r\ntalk_ids=forms.CharField(\r\nlabel=_(\"\"),\r\nmax_length=500,\r\nhelp_text=_(\"\")\r\n)\r\nclassFeedbackForm(forms.Form):\r\nfeedback_id=forms.CharField(\r\nlabel=_(\"\"),\r\nmax_length=500,\r\nhelp_text=_(\"\")\r\n)\r\nclassSpeakerFeedbackForm(forms.Form):\r\nfeedback_id=forms.CharField(\r\nlabel=_(\"\"),\r\nmax_length=500,\r\nhelp_text=_(\"\")\r\n)\r\nclassContingentFeedbackForm(forms.Form):\r\nfeedback_id=forms.CharField(\r\nlabel=_(\"\"),\r\nmax_length=500,\r\nhelp_text=_(\"\")\r\n)\r\n\r\nclassReviewForm(forms.ModelForm):\r\nclassMeta:\r\nmodel=Review\r\nfields=[\"\",\"\"]\r\n\r\ndef__init__(self,*args,**kwargs):\r\nsuper(ReviewForm,self).__init__(*args,**kwargs)\r\nself.fields[\"\"]=forms.ChoiceField(\r\nwidget=forms.RadioSelect(),\r\nchoices=VOTES.CHOICES\r\n)\r\n\r\nclassSpeakerCommentForm(forms.ModelForm):\r\nclassMeta:\r\nmodel=ProposalMessage\r\nfields=[\"\"]\r\n\r\n#TODO:Addstaffreviewform\r\nclassStaffFeedbackForm(forms.Form):\r\nstaff_ids=": [
    [
      -0.0005515353610531199,
      [
        "forms",
        ".",
        "CharField",
        "(",
        "label",
        "=",
        "_",
        "(",
        "<STR_LIT>",
        "),",
        " max",
        "_",
        "length",
        "=",
        "<NUM_LIT>",
        ",",
        " help",
        "_",
        "text",
        "=",
        "_",
        "(",
        "<STR_LIT>"
      ]
    ],
    [
      -0.0006249833733999485,
      [
        "forms",
        ".",
        "CharField",
        "(",
        "label",
        "=",
        "_",
        "(",
        "<STR_LIT>",
        "),",
        " max",
        "_",
        "length",
        "=",
        "<NUM_LIT>",
        ",",
        " help",
        "_",
        "text",
        "=",
        "_",
        "(",
        "<STR_LIT>"
      ]
    ],
    [
      -0.0008117515899071376,
      [
        "forms",
        ".",
        "IntegerField",
        "(",
        "label",
        "=",
        "_",
        "(",
        "<STR_LIT>",
        "),",
        " max",
        "_",
        "length",
        "=",
        "<NUM_LIT>",
        ",",
        " help",
        "_",
        "text",
        "=",
        "_",
        "(",
        "<STR_LIT>"
      ]
    ],
    [
      -0.0008331388295293896,
      [
        "Set",
        "(",
        "[",
        "<STR_LIT>",
        ",",
        "<STR_LIT>",
        ",",
        "<STR_LIT>",
        ",",
        "<STR_LIT>",
        ",",
        "<STR_LIT>",
        ",",
        "<STR_LIT>",
        ",",
        "<STR_LIT>"
      ]
    ],
    [
      -0.0013115421544333617,
      [
        "fields",
        ".",
        "IntegerField",
        "(",
        "label",
        "=",
        "_",
        "(",
        "<STR_LIT>",
        "),",
        " max",
        "_",
        "length",
        "=",
        "<NUM_LIT>",
        ",",
        " help",
        "_",
        "text",
        "=",
        "_",
        "(",
        "<STR_LIT>",
        "))"
      ]
    ],
    [
      -0.0014714434851197872,
      [
        "forms",
        ".",
        "IntegerField",
        "(",
        "label",
        "=",
        "_",
        "(",
        "<STR_LIT>",
        "),",
        " max",
        "_",
        "length",
        "=",
        "<NUM_LIT>",
        ",",
        " help",
        "_",
        "text",
        "=",
        "_",
        "(",
        "<STR_LIT>",
        "))"
      ]
    ],
    [
      -0.0015356805543237182,
      [
        "Set",
        "(",
        "[",
        "<STR_LIT>",
        ",",
        "<STR_LIT>",
        ",",
        "<STR_LIT>",
        "]",
        ")",
        "<endofline>"
      ]
    ],
    [
      -0.00155416369440135,
      [
        "Set",
        "(",
        "[",
        "<STR_LIT>",
        ",",
        "<STR_LIT>",
        "]",
        ")",
        "<endofline>"
      ]
    ],
    [
      -0.0016485427578737254,
      [
        "Set",
        "(",
        "[",
        "<STR_LIT>",
        ",",
        "<STR_LIT>",
        ",",
        "<STR_LIT>",
        ",",
        "<STR_LIT>",
        ",",
        "<STR_LIT>",
        "]",
        ")",
        "<endofline>"
      ]
    ],
    [
      -0.0001650591472342681,
      [
        "forms",
        ".",
        "CharField",
        "(",
        "label",
        "=",
        "_",
        "(",
        "<STR_LIT>",
        "),",
        " max",
        "_",
        "length",
        "=",
        "<NUM_LIT>",
        ",",
        " help",
        "_",
        "text",
        "=",
        "_",
        "(",
        "<STR_LIT>",
        "))"
      ]
    ],
    [
      -0.0016508701231201747,
      [
        "Set",
        "(",
        "[",
        "<STR_LIT>",
        ",",
        "<STR_LIT>",
        ",",
        "<STR_LIT>",
        ",",
        "<STR_LIT>",
        "]",
        ")",
        "<endofline>"
      ]
    ],
    [
      -0.0019762186339084492,
      [
        "forms",
        ".",
        "CharField",
        "(",
        "label",
        "=",
        "_",
        "(",
        "<STR_LIT>",
        "),",
        " max",
        "_",
        "length",
        "=",
        "<NUM_LIT>",
        ",",
        " help",
        "_",
        "text",
        "=",
        "_",
        "(",
        "<STR_LIT>",
        "))"
      ]
    ],
    [
      -0.0023005535210783175,
      [
        "fields",
        ".",
        "IntegerField",
        "(",
        "label",
        "=",
        "_",
        "(",
        "<STR_LIT>",
        "),",
        " max",
        "_",
        "length",
        "=",
        "<NUM_LIT>",
        ")",
        "<endofline>"
      ]
    ],
    [
      -0.002523928508252494,
      [
        "forms",
        ".",
        "CharField",
        "(",
        "label",
        "=",
        "_",
        "(",
        "<STR_LIT>",
        "),",
        " max",
        "_",
        "length",
        "=",
        "<NUM_LIT>",
        ")",
        "<endofline>"
      ]
    ],
    [
      -0.0031024800413565804,
      [
        "forms",
        ".",
        "CharField",
        "(",
        "label",
        "=",
        "<STR_LIT>",
        ")",
        "<endofline>"
      ]
    ]
  ],
  "from__future__importunicode_literals\r\nfromdjangoimportforms\r\nfromdjango.utils.translationimportugettext_lazyas_\r\n\r\nfromsymposion.reviews.modelsimportReview,Comment,ProposalMessage,VOTES\r\n\r\nclassReviewCommentForm(forms.ModelForm):\r\nclassMeta:\r\nmodel=Comment\r\nfields=[\"\"]\r\nclassBulkPresentationForm(forms.Form):\r\ntalk_ids=forms.CharField(\r\nlabel=_(\"\"),\r\nmax_length=500,\r\nhelp_text=_(\"\")\r\n)\r\nclassFeedbackForm(forms.Form):\r\nfeedback_id=forms.CharField(\r\nlabel=_(\"\"),\r\nmax_length=500,\r\nhelp_text=_(\"\")\r\n)\r\nclassSpeakerFeedbackForm(forms.Form):\r\nfeedback_id=forms.CharField(\r\nlabel=_(\"\"),\r\nmax_length=500,\r\nhelp_text=_(\"\")\r\n)\r\nclassContingentFeedbackForm(forms.Form):\r\nfeedback_id=forms.CharField(\r\nlabel=_(\"\"),\r\nmax_length=500,\r\nhelp_text=_(\"\")\r\n)\r\n\r\nclassReviewForm(forms.ModelForm):\r\nclassMeta:\r\nmodel=Review\r\nfields=[\"\",\"\"]\r\n\r\ndef__init__(self,*args,**kwargs):\r\nsuper(ReviewForm,self).__init__(*args,**kwargs)\r\nself.fields[\"\"]=forms.ChoiceField(\r\nwidget=forms.RadioSelect(),\r\nchoices=VOTES.CHOICES\r\n)\r\n\r\nclassSpeakerCommentForm(forms.ModelForm):\r\nclassMeta:\r\nmodel=ProposalMessage\r\nfields=[\"\"]\r\n\r\n#TODO:Addstaffreviewform\r\nclassStaffFeedbackForm(forms.Form):": [
    
  ],
  "fromdjango.core.mailimportsend_mass_mail\r\nfromdjango.db.modelsimportQ\r\nfromdjango.httpimportHttpResponseBadRequest,HttpResponseNotAllowed\r\nfromdjango.shortcutsimportrender,redirect,get_object_or_404\r\nfromdjango.templateimportContext,Template\r\nfromdjango.views.decorators.httpimportrequire_POST\r\n\r\nfromaccount.decoratorsimportlogin_required\r\n\r\n#@@@switchtopinax-teams\r\nfromsymposion.teams.modelsimportTeam\r\n\r\nfromsymposion.confimportsettings\r\nfromsymposion.proposals.modelsimportProposalBase,ProposalSection\r\nfromsymposion.utils.mailimportsend_email\r\n\r\nfromsymposion.reviews.formsimportReviewForm,SpeakerCommentForm\r\nfromsymposion.reviews.formsimportBulkPresentationForm\r\nfromsymposion.reviews.formsimportStaffCommentForm\r\nfromsymposion.reviews.modelsimport(\r\nReviewAssignment,Review,LatestVote,ProposalResult,NotificationTemplate,\r\nResultNotification\r\n)\r\n\r\n\r\ndefproposals_generator(request,queryset,user_pk=None,check_speaker=True):\r\n\r\nforobjinqueryset:\r\n#@@@thissucks;wecandobetter\r\nifcheck_speaker:\r\nifrequest.userin[s.userforsinobj.speakers()]:\r\ncontinue\r\n\r\ntry:\r\nobj.result\r\nexceptProposalResult.DoesNotExist:\r\nProposalResult.objects.get_or_create(proposal=obj)\r\n\r\nobj.comment_count=obj.result.comment_count\r\nobj.total_votes=obj.result.vote_count\r\nobj.plus_one=obj.result.plus_one\r\nobj.plus_zero=obj.result.plus_zero\r\nobj.minus_zero=obj.result.minus_zero\r\nobj.minus_one=obj.result.minus_one\r\nlookup_params=dict(proposal=obj)\r\n\r\nifuser_pk:\r\nlookup_params[\"\"]=user_pk\r\nelse:\r\nlookup_params[\"\"]=request.user\r\n\r\ntry:\r\nobj.user_vote=LatestVote.objects.get(**lookup_params).vote\r\nobj.user_vote_css=LatestVote.objects.get(**lookup_params).css_class()\r\nexceptLatestVote.DoesNotExist:\r\nobj.user_vote=None\r\nobj.user_vote_css=\"\"\r\n\r\nyieldobj\r\n\r\ndefaccess_not_permitted(request,error_message):\r\nreturnrender(request,\"\",error_message)\r\n\r\n\r\n#Returnsalistofallproposals,proposalsreviewedbytheuser,ortheproposalstheuserhas\r\n#yettoreviewdependingonthelinkuserclicksindashboard\r\n@login_required\r\ndefreview_section(request_review,section_slug,assigned=False,reviewed=\"\"):\r\n\r\nifnotrequest_review.user.has_perm(\"\"%section_slug):\r\nreturnrender(request_review,\"\",\"\")\r\n\r\nsection=get_object_or_404(ProposalSection,section__slug=section_slug)\r\nqueryset=ProposalBase.objects.filter(kind__section=section.section)\r\n\r\nifassigned:\r\nassignments=ReviewAssignment.objects.filter(user=request_review.user)\\\r\n.values_list(\"\")\r\nqueryset=queryset.filter(id__in=assignments)\r\n\r\n#passingreviewedinfromreviews.urlsandouttoreview_listfor\r\n#appropriatetemplateheaderrendering\r\nifreviewed==\"\":\r\nqueryset=queryset.select_related(\"\").select_subclasses()\r\nreviewed=\"\"\r\nelifreviewed==\"\":\r\nqueryset=queryset.filter(reviews__user=request_review.user)\r\nreviewed=\"\"\r\nelse:\r\nqueryset=queryset.exclude(reviews__user=request_review.user).exclude(\r\nspeaker__user=request_review.user)\r\nreviewed=\"\"\r\n\r\nproposals=proposals_generator(request_review,queryset)\r\n\r\nctx={\r\n\"\":proposals,\r\n\"\":section,\r\n\"\":reviewed,\r\n}\r\n\r\nreturnrender(request_review,\"\",ctx)\r\n\r\n\r\n@login_required\r\ndefreview_list(request_review_list,section_slug,user_pk):\r\n\r\n#ifthey''tthepersonwhose\r\n#reviewlistisbeingaskedfor,don'tletthemin\r\nifnotrequest_review_list.user.has_perm(\"\"%section_slug):\r\nifnotrequest_review_list.user.pk==user_pk:\r\nreturnrender(request_review_list,\"\",\"\")\r\n\r\nqueryset=ProposalBase.objects.select_related(\"\",\"\")\r\nreviewed=LatestVote.objects.filter(user__pk=user_pk).values_list(\"\",flat=True)\r\nqueryset=queryset.filter(pk__in=reviewed)\r\nproposals=queryset.order_by(\"\")\r\n\r\nadmin=request_review_list.user.has_perm(\"\"%section_slug)\r\n\r\nproposals=proposals_generator(request_review_list,proposals,user_pk=user_pk,check_speaker=notadmin)\r\n\r\nctx={\r\n\"\":proposals,\r\n}\r\nreturnrender(request_review_list,\"\",ctx)\r\n\r\n\r\n@login_required\r\ndefreview_admin(request_review_admin,section_slug):\r\n\r\nifnotrequest_review_admin.user.has_perm(\"\"%section_slug):\r\nreturnrender(request_review_admin,\"\",\"\")\r\n\r\ndefreviewers():\r\nalready_seen=set()\r\n\r\nforteaminTeam.objects.filter(permissions__codename=\"\"%section_slug):\r\nformembershipinteam.memberships.filter(Q(state=\"\")|Q(state=\"\")):\r\nuser=membership.user\r\nifuser.pkinalready_seen:\r\ncontinue\r\nalready_seen.add(user.pk)\r\n\r\nuser.comment_count=Review.objects.filter(user=user).count()\r\nuser.total_votes=LatestVote.objects.filter(user=user).count()\r\nuser.plus_one=LatestVote.objects.filter(\r\nuser=user,\r\nvote=LatestVote.VOTES.PLUS_ONE\r\n).count()\r\nuser.plus_zero=LatestVote.objects.filter(\r\nuser=user,\r\nvote=LatestVote.VOTES.PLUS_ZERO\r\n).count()\r\nuser.minus_zero=LatestVote.objects.filter(\r\nuser=user,\r\nvote=LatestVote.VOTES.MINUS_ZERO\r\n).count()\r\nuser.minus_one=LatestVote.objects.filter(\r\nuser=user,\r\nvote=LatestVote.VOTES.MINUS_ONE\r\n).count()\r\n\r\nyielduser\r\n\r\nctx={\r\n\"\":section_slug,\r\n\"\":reviewers(),\r\n}\r\nreturnrender(request_review_admin,\"\",ctx)\r\n\r\n@login_required\r\ndefreview_detail(request_review_detail,pk):\r\n\r\nproposals=ProposalBase.objects.select_related(\"\").select_subclasses()\r\nproposal=get_object_or_404(proposals,pk=pk)\r\n\r\nifnotrequest_review_detail.user.has_perm(\"\"%proposal.kind.section.slug):\r\nreturnrender(request_review_detail,\"\",\"\")\r\n\r\nspeakers=[s.userforsinproposal.speakers()]\r\n\r\nifnotrequest_review_detail.user.is_superuserandrequest_review_detail.userinspeakers:\r\nreturnrender(request_review_detail,\"\",\"\")\r\n\r\nadmin=request_review_detail.user.is_staff\r\n\r\ntry:\r\nlatest_vote=LatestVote.objects.get(proposal=proposal,user=request_review_detail.user)\r\nexceptLatestVote.DoesNotExist:\r\nlatest_vote=None\r\n\r\nifrequest_review_detail.method==\"\":\r\nifrequest_review_detail.userinspeakers:\r\nreturnrender(request_review_detail,\"\",\"\")\r\n\r\nif\"\"inrequest_review_detail.POST:\r\nreview_form=ReviewForm(request_review_detail.POST)\r\nifreview_form.is_valid():\r\n\r\nreview=review_form.save(commit=False)\r\nreview.user=request_review_detail.user\r\nreview.proposal=proposal\r\nreview.save()\r\n\r\nreturnredirect(request_review_detail.path)\r\nelse:\r\nmessage_form=SpeakerCommentForm()\r\nelif\"\"inrequest_review_detail.POST:\r\nmessage_form=SpeakerCommentForm(request_review_detail.POST)\r\nifmessage_form.is_valid():\r\n\r\nmessage=message_form.save(commit=False)\r\nmessage.user=request_review_detail.user\r\nmessage.proposal=proposal\r\nmessage.save()\r\n\r\nforspeakerinspeakers:\r\nifspeakerandspeaker.email:\r\nctx={\r\n\"\":proposal,\r\n\"\":message,\r\n\"\":False,\r\n}\r\nsend_email(\r\n[speaker.email],\"\",\r\ncontext=ctx\r\n)\r\n\r\nreturnredirect(request_review_detail.path)\r\nelse:\r\ninitial={}\r\niflatest_vote:\r\ninitial[\"\"]=latest_vote.vote\r\nifrequest_review_detail.userinspeakers:\r\nreview_form=None\r\nelse:\r\nreview_form=ReviewForm(initial=initial)\r\nelif\"\"inrequest_review_detail.POST:\r\nifadmin:\r\nresult=request_review_detail.POST[\"\"]\r\n\r\nifresult==\"\":\r\nproposal.result.status=\"\"\r\nproposal.result.save()\r\nelifresult==\"\":\r\nproposal.result.status=\"\"\r\nproposal.result.save()\r\nelifresult==\"\":\r\nproposal.result.status=\"\"\r\nproposal.result.save()\r\nelifresult==\"\":\r\nproposal.result.status=\"\"\r\nproposal.result.save()\r\n\r\nreturnredirect(request_review_detail.path)\r\nelse:\r\ninitial={}\r\niflatest_vote:\r\ninitial[\"\"]=latest_vote.vote\r\nifrequest_review_detail.userinspeakers:\r\nreview_form=None\r\nelse:\r\nreview_form=ReviewForm(initial=initial)\r\nmessage_form=SpeakerCommentForm()\r\n\r\nproposal.comment_count=proposal.result.comment_count\r\nproposal.total_votes=proposal.result.vote_count\r\nproposal.plus_one=proposal.result.plus_one\r\nproposal.plus_zero=proposal.result.plus_zero\r\nproposal.minus_zero=proposal.result.minus_zero\r\nproposal.minus_one=proposal.result.minus_one\r\n\r\nreviews=Review.objects.filter(proposal=proposal).order_by(\"\")\r\nmessages=proposal.messages.order_by(\"\")\r\n\r\nreturnrender(request_review_detail,\"\",{\r\n\"\":proposal,\r\n\"\":latest_vote,\r\n\"\":reviews,\r\n\"\":messages,\r\n\"\":review_form,\r\n\"\":message_form\r\n})\r\n\r\n\r\n@login_required\r\n@require_POST\r\ndefreview_delete(request_delete,pk):\r\nreview=get_object_or_404(Review,pk=pk)\r\nsection_slug=review.section.slug\r\n\r\nifnotrequest_delete.user.has_perm(\"\"%section_slug):\r\nreturnrender(request_delete,\"\",\"\")\r\n\r\nreview=get_object_or_404(Review,pk=pk)\r\nreview.delete()\r\n\r\nreturnredirect(\"\",pk=review.proposal.pk)\r\n\r\n\r\n@login_required\r\ndefreview_status(request_review_status,section_slug=None,key=None):\r\n\r\nifnotrequest_review_status.user.has_perm(\"\"%section_slug):\r\nreturnrender(request_review_status,\"\",\"\")\r\n\r\nVOTE_THRESHOLD=settings.SYMPOSION_VOTE_THRESHOLD\r\n\r\nctx={\r\n\"\":section_slug,\r\n\"\":VOTE_THRESHOLD,\r\n}\r\n\r\nqueryset=ProposalBase.objects.select_related(\"\",\"\").select_subclasses()\r\nifsection_slug:\r\nqueryset=queryset.filter(kind__section__slug=section_slug)\r\n\r\nproposals={\r\n#proposalswithatleastVOTE_THRESHOLDreviewsandatleastone+1andno-1s,sortedby\r\n#the''\r\n\"\":queryset.filter(result__vote_count__gte=VOTE_THRESHOLD,result__plus_one__gt=0,\r\nresult__minus_one=0).order_by(\"\"),\r\n#proposalswithatleastVOTE_THRESHOLDreviewsandatleastone-1andno+1s,reverse\r\n#sortedbythe''\r\n\"\":queryset.filter(result__vote_count__gte=VOTE_THRESHOLD,result__minus_one__gt=0,\r\nresult__plus_one=0).order_by(\"\"),\r\n#proposalswithatleastVOTE_THRESHOLDreviewsandneithera+1ora-1,sortedbytotal\r\n#votes(lowestfirst)\r\n\"\":queryset.filter(result__vote_count__gte=VOTE_THRESHOLD,result__minus_one=0,\r\nresult__plus_one=0).order_by(\"\"),\r\n#proposalswithatleastVOTE_THRESHOLDreviewsandbotha+1and-1,sortedbytotal\r\n#votes(highestfirst)\r\n\"\":queryset.filter(result__vote_count__gte=VOTE_THRESHOLD,\r\nresult__plus_one__gt=0,result__minus_one__gt=0)\r\n.order_by(\"\"),\r\n#proposalswithfewerthanVOTE_THRESHOLDreviews\r\n\"\":queryset.filter(result__vote_count__lt=VOTE_THRESHOLD)\r\n.order_by(\"\"),\r\n}\r\n\r\nadmin=request_review_status.user.has_perm(\"\"%section_slug)\r\n\r\nforstatusinproposals:\r\nifkeyandkey!=status:\r\ncontinue\r\nproposals[status]=list(proposals_generator(request_review_status,proposals[status],check_speaker=notadmin))\r\n\r\nifkey:\r\nctx.update({\r\n\"\":key,\r\n\"\":proposals[key],\r\n})\r\nelse:\r\nctx[\"\"]=proposals\r\n\r\nreturnrender(request_review_status,\"\",ctx)\r\n\r\n\r\n@login_required\r\ndefreview_assignments(request_review_assignments):\r\nifnotrequest_review_assignments.user.groups.filter(name=\"\").exists():\r\nreturnrender(request_review_assignments,\"\",\"\")\r\nassignments=ReviewAssignment.objects.filter(\r\nuser=request_review_assignments.user,\r\nopted_out=False\r\n)\r\nreturnrender(request_review_assignments,\"\",{\r\n\"\":assignments,\r\n})\r\n\r\n\r\n@login_required\r\n@require_POST\r\ndefreview_assignment_opt_out(request_review_assignment_opt_out,pk):\r\nreview_assignment=get_object_or_404(\r\nReviewAssignment,pk=pk,user=request_review_assignment_opt_out.user)\r\nifnotreview_assignment.opted_out:\r\nreview_assignment.opted_out=True\r\nreview_assignment.save()\r\nReviewAssignment.create_assignments(\r\nreview_assignment.proposal,origin=ReviewAssignment.AUTO_ASSIGNED_LATER)\r\nreturnredirect(\"\")\r\n\r\n\r\n@login_required\r\ndefreview_bulk_accept(request_review_bulk_accept,section_slug):\r\nifnotrequest_review_bulk_accept.user.has_perm(\"\"%section_slug):\r\nreturnrender(request_review_bulk_accept,\"\",\"\")\r\nifrequest_review_bulk_accept.method==\"\":\r\nform=BulkPresentationForm(request_review_bulk_accept.POST)\r\nifform.is_valid():\r\ntalk_ids=form.cleaned_data[\"\"].split(\"\")\r\ntalks=ProposalBase.objects.filter(id__in=talk_ids).select_related(\"\")\r\nfortalkintalks:\r\ntalk.result.status=\"\"\r\ntalk.result.save()\r\nreturnredirect(\"\",section_slug=section_slug)\r\nelse:\r\nform=BulkPresentationForm()\r\n\r\nreturnrender(request_review_bulk_accept,\"\",{\r\n\"\":form,\r\n})\r\n\r\n\r\n@login_required\r\ndefresult_notification(request_result_notification,section_slug,status):\r\nifnotrequest_result_notification.user.has_perm(\"\"%section_slug):\r\nreturnrender(request_result_notification,\"\",\"\")\r\n\r\nproposals=ProposalBase.objects.filter(kind__section__slug=section_slug,result__status=status).select_related(\"\",\"\").select_subclasses()\r\nnotification_templates=NotificationTemplate.objects.all()\r\n\r\nctx={\r\n\"\":section_slug,\r\n\"\":status,\r\n\"\":proposals,\r\n\"\":notification_templates,\r\n}\r\nreturnrender(request_result_notification,\"\",ctx)\r\n\r\n\r\n@login_required\r\ndefresult_notification_prepare(request_result_notification_prepare,section_slug,status):\r\nifrequest_result_notification_prepare.method!=\"\":\r\nreturnHttpResponseNotAllowed([\"\"])\r\n\r\nifnotrequest_result_notification_prepare.user.has_perm(\"\"%section_slug):\r\nreturnrender(request_result_notification_prepare,\"\",\"\")\r\n\r\nproposal_pks=[]\r\ntry:\r\nforpkinrequest_result_notification_prepare.POST.getlist(\"\"):\r\nproposal_pks.append(int(pk))\r\nexceptValueError:\r\nreturnHttpResponseBadRequest()\r\nproposals=ProposalBase.objects.filter(\r\nkind__section__slug=section_slug,\r\nresult__status=status,\r\n)\r\nproposals=proposals.filter(pk__in=proposal_pks)\r\nproposals=proposals.select_related(\"\",\"\")\r\nproposals=proposals.select_subclasses()\r\n\r\nnotification_template_pk=request_result_notification_prepare.POST.get(\"\",\"\")\r\nifnotification_template_pk:\r\nnotification_template=NotificationTemplate.objects.get(pk=notification_template_pk)\r\nelse:\r\nnotification_template=None\r\n\r\nctx={\r\n\"\":section_slug,\r\n\"\":status,\r\n\"\":notification_template,\r\n\"\":proposals,\r\n\"\":\"\".join([str(pk)forpkinproposal_pks]),\r\n}\r\nreturnrender(request_result_notification_prepare,\"\",ctx)\r\n\r\ndefaccept_staff_suggestion(staffId):\r\nreturn\r\n\r\n@login_required\r\ndefresult_notification_send(request_result_notification_send,section_slug,status):\r\nifrequest_result_notification_send.method!=\"\":\r\nreturnHttpResponseNotAllowed([\"\"])\r\n\r\nifnotrequest_result_notification_send.user.has_perm(\"\"%section_slug):\r\nreturnrender(request_result_notification_send,\"\",\"\")\r\n\r\nifnotall([kinrequest_result_notification_send.POSTforkin[\"\",\"\",\"\",\"\"]]):\r\nreturnHttpResponseBadRequest()\r\n\r\ntry:\r\nproposal_pks=[int(pk)forpkinrequest_result_notification_send.POST[\"\"].split(\"\")]\r\nexceptValueError:\r\nreturnHttpResponseBadRequest()\r\n\r\nproposals=ProposalBase.objects.filter(\r\nkind__section__slug=section_slug,\r\nresult__status=status,\r\n)\r\nproposals=proposals.filter(pk__in=proposal_pks)\r\nproposals=proposals.select_related(\"\",\"\")\r\nproposals=proposals.select_subclasses()\r\n\r\nnotification_template_pk=request_result_notification_send.POST.get(\"\",\"\")\r\nifnotification_template_pk:\r\nnotification_template=NotificationTemplate.objects.get(pk=notification_template_pk)\r\nelse:\r\nnotification_template=None\r\n\r\nemails=[]\r\n\r\nforproposalinproposals:\r\nrn=ResultNotification()\r\nrn.proposal=proposal\r\nrn.template=notification_template\r\nrn.to_address=proposal.speaker_email\r\nrn.from_address=request_result_notification_send.POST[\"\"]\r\nrn.subject=request_result_notification_send.POST[\"\"]\r\nrn.body=Template(request_result_notification_send.POST[\"\"]).render(\r\nContext({\r\n\"\":proposal.notification_email_context()\r\n})\r\n)\r\nrn.save()\r\nemails.append(rn.email_args)\r\n\r\nsend_mass_mail(emails)\r\n\r\nreturnredirect(\"\",section_slug=section_slug,status=status)\r\n\r\n\r\n\r\n@login_required\r\ndefreview_staff_comment(request_review_staff_comment,section_slug):\r\nifnotrequest_review_staff_comment.user.has_perm(\"\"%section_slug):\r\nreturnrender(request_review_staff_comment,\"\",\"\")\r\nifrequest_review_staff_comment.method==\"\":\r\nform=StaffCommentForm(request_review_staff_comment.POST)\r\n#TODO:completeimplementationofstaffcommentform-splitandmarkaccepted\r\nif ": [
    [
      -0.0016172344798127875,
      [
        "form",
        ".",
        "is",
        "_",
        "valid",
        "(",
        "):"
      ]
    ]
  ],
  "fromdjango.core.mailimportsend_mass_mail\r\nfromdjango.db.modelsimportQ\r\nfromdjango.httpimportHttpResponseBadRequest,HttpResponseNotAllowed\r\nfromdjango.shortcutsimportrender,redirect,get_object_or_404\r\nfromdjango.templateimportContext,Template\r\nfromdjango.views.decorators.httpimportrequire_POST\r\n\r\nfromaccount.decoratorsimportlogin_required\r\n\r\n#@@@switchtopinax-teams\r\nfromsymposion.teams.modelsimportTeam\r\n\r\nfromsymposion.confimportsettings\r\nfromsymposion.proposals.modelsimportProposalBase,ProposalSection\r\nfromsymposion.utils.mailimportsend_email\r\n\r\nfromsymposion.reviews.formsimportReviewForm,SpeakerCommentForm\r\nfromsymposion.reviews.formsimportBulkPresentationForm\r\nfromsymposion.reviews.formsimportStaffCommentForm\r\nfromsymposion.reviews.modelsimport(\r\nReviewAssignment,Review,LatestVote,ProposalResult,NotificationTemplate,\r\nResultNotification\r\n)\r\n\r\n\r\ndefproposals_generator(request,queryset,user_pk=None,check_speaker=True):\r\n\r\nforobjinqueryset:\r\n#@@@thissucks;wecandobetter\r\nifcheck_speaker:\r\nifrequest.userin[s.userforsinobj.speakers()]:\r\ncontinue\r\n\r\ntry:\r\nobj.result\r\nexceptProposalResult.DoesNotExist:\r\nProposalResult.objects.get_or_create(proposal=obj)\r\n\r\nobj.comment_count=obj.result.comment_count\r\nobj.total_votes=obj.result.vote_count\r\nobj.plus_one=obj.result.plus_one\r\nobj.plus_zero=obj.result.plus_zero\r\nobj.minus_zero=obj.result.minus_zero\r\nobj.minus_one=obj.result.minus_one\r\nlookup_params=dict(proposal=obj)\r\n\r\nifuser_pk:\r\nlookup_params[\"\"]=user_pk\r\nelse:\r\nlookup_params[\"\"]=request.user\r\n\r\ntry:\r\nobj.user_vote=LatestVote.objects.get(**lookup_params).vote\r\nobj.user_vote_css=LatestVote.objects.get(**lookup_params).css_class()\r\nexceptLatestVote.DoesNotExist:\r\nobj.user_vote=None\r\nobj.user_vote_css=\"\"\r\n\r\nyieldobj\r\n\r\ndefaccess_not_permitted(request,error_message):\r\nreturnrender(request,\"\",error_message)\r\n\r\n\r\n#Returnsalistofallproposals,proposalsreviewedbytheuser,ortheproposalstheuserhas\r\n#yettoreviewdependingonthelinkuserclicksindashboard\r\n@login_required\r\ndefreview_section(request_review,section_slug,assigned=False,reviewed=\"\"):\r\n\r\nifnotrequest_review.user.has_perm(\"\"%section_slug):\r\nreturnrender(request_review,\"\",\"\")\r\n\r\nsection=get_object_or_404(ProposalSection,section__slug=section_slug)\r\nqueryset=ProposalBase.objects.filter(kind__section=section.section)\r\n\r\nifassigned:\r\nassignments=ReviewAssignment.objects.filter(user=request_review.user)\\\r\n.values_list(\"\")\r\nqueryset=queryset.filter(id__in=assignments)\r\n\r\n#passingreviewedinfromreviews.urlsandouttoreview_listfor\r\n#appropriatetemplateheaderrendering\r\nifreviewed==\"\":\r\nqueryset=queryset.select_related(\"\").select_subclasses()\r\nreviewed=\"\"\r\nelifreviewed==\"\":\r\nqueryset=queryset.filter(reviews__user=request_review.user)\r\nreviewed=\"\"\r\nelse:\r\nqueryset=queryset.exclude(reviews__user=request_review.user).exclude(\r\nspeaker__user=request_review.user)\r\nreviewed=\"\"\r\n\r\nproposals=proposals_generator(request_review,queryset)\r\n\r\nctx={\r\n\"\":proposals,\r\n\"\":section,\r\n\"\":reviewed,\r\n}\r\n\r\nreturnrender(request_review,\"\",ctx)\r\n\r\n\r\n@login_required\r\ndefreview_list(request_review_list,section_slug,user_pk):\r\n\r\n#ifthey''tthepersonwhose\r\n#reviewlistisbeingaskedfor,don'tletthemin\r\nifnotrequest_review_list.user.has_perm(\"\"%section_slug):\r\nifnotrequest_review_list.user.pk==user_pk:\r\nreturnrender(request_review_list,\"\",\"\")\r\n\r\nqueryset=ProposalBase.objects.select_related(\"\",\"\")\r\nreviewed=LatestVote.objects.filter(user__pk=user_pk).values_list(\"\",flat=True)\r\nqueryset=queryset.filter(pk__in=reviewed)\r\nproposals=queryset.order_by(\"\")\r\n\r\nadmin=request_review_list.user.has_perm(\"\"%section_slug)\r\n\r\nproposals=proposals_generator(request_review_list,proposals,user_pk=user_pk,check_speaker=notadmin)\r\n\r\nctx={\r\n\"\":proposals,\r\n}\r\nreturnrender(request_review_list,\"\",ctx)\r\n\r\n\r\n@login_required\r\ndefreview_admin(request_review_admin,section_slug):\r\n\r\nifnotrequest_review_admin.user.has_perm(\"\"%section_slug):\r\nreturnrender(request_review_admin,\"\",\"\")\r\n\r\ndefreviewers():\r\nalready_seen=set()\r\n\r\nforteaminTeam.objects.filter(permissions__codename=\"\"%section_slug):\r\nformembershipinteam.memberships.filter(Q(state=\"\")|Q(state=\"\")):\r\nuser=membership.user\r\nifuser.pkinalready_seen:\r\ncontinue\r\nalready_seen.add(user.pk)\r\n\r\nuser.comment_count=Review.objects.filter(user=user).count()\r\nuser.total_votes=LatestVote.objects.filter(user=user).count()\r\nuser.plus_one=LatestVote.objects.filter(\r\nuser=user,\r\nvote=LatestVote.VOTES.PLUS_ONE\r\n).count()\r\nuser.plus_zero=LatestVote.objects.filter(\r\nuser=user,\r\nvote=LatestVote.VOTES.PLUS_ZERO\r\n).count()\r\nuser.minus_zero=LatestVote.objects.filter(\r\nuser=user,\r\nvote=LatestVote.VOTES.MINUS_ZERO\r\n).count()\r\nuser.minus_one=LatestVote.objects.filter(\r\nuser=user,\r\nvote=LatestVote.VOTES.MINUS_ONE\r\n).count()\r\n\r\nyielduser\r\n\r\nctx={\r\n\"\":section_slug,\r\n\"\":reviewers(),\r\n}\r\nreturnrender(request_review_admin,\"\",ctx)\r\n\r\n@login_required\r\ndefreview_detail(request_review_detail,pk):\r\n\r\nproposals=ProposalBase.objects.select_related(\"\").select_subclasses()\r\nproposal=get_object_or_404(proposals,pk=pk)\r\n\r\nifnotrequest_review_detail.user.has_perm(\"\"%proposal.kind.section.slug):\r\nreturnrender(request_review_detail,\"\",\"\")\r\n\r\nspeakers=[s.userforsinproposal.speakers()]\r\n\r\nifnotrequest_review_detail.user.is_superuserandrequest_review_detail.userinspeakers:\r\nreturnrender(request_review_detail,\"\",\"\")\r\n\r\nadmin=request_review_detail.user.is_staff\r\n\r\ntry:\r\nlatest_vote=LatestVote.objects.get(proposal=proposal,user=request_review_detail.user)\r\nexceptLatestVote.DoesNotExist:\r\nlatest_vote=None\r\n\r\nifrequest_review_detail.method==\"\":\r\nifrequest_review_detail.userinspeakers:\r\nreturnrender(request_review_detail,\"\",\"\")\r\n\r\nif\"\"inrequest_review_detail.POST:\r\nreview_form=ReviewForm(request_review_detail.POST)\r\nifreview_form.is_valid():\r\n\r\nreview=review_form.save(commit=False)\r\nreview.user=request_review_detail.user\r\nreview.proposal=proposal\r\nreview.save()\r\n\r\nreturnredirect(request_review_detail.path)\r\nelse:\r\nmessage_form=SpeakerCommentForm()\r\nelif\"\"inrequest_review_detail.POST:\r\nmessage_form=SpeakerCommentForm(request_review_detail.POST)\r\nifmessage_form.is_valid():\r\n\r\nmessage=message_form.save(commit=False)\r\nmessage.user=request_review_detail.user\r\nmessage.proposal=proposal\r\nmessage.save()\r\n\r\nforspeakerinspeakers:\r\nifspeakerandspeaker.email:\r\nctx={\r\n\"\":proposal,\r\n\"\":message,\r\n\"\":False,\r\n}\r\nsend_email(\r\n[speaker.email],\"\",\r\ncontext=ctx\r\n)\r\n\r\nreturnredirect(request_review_detail.path)\r\nelse:\r\ninitial={}\r\niflatest_vote:\r\ninitial[\"\"]=latest_vote.vote\r\nifrequest_review_detail.userinspeakers:\r\nreview_form=None\r\nelse:\r\nreview_form=ReviewForm(initial=initial)\r\nelif\"\"inrequest_review_detail.POST:\r\nifadmin:\r\nresult=request_review_detail.POST[\"\"]\r\n\r\nifresult==\"\":\r\nproposal.result.status=\"\"\r\nproposal.result.save()\r\nelifresult==\"\":\r\nproposal.result.status=\"\"\r\nproposal.result.save()\r\nelifresult==\"\":\r\nproposal.result.status=\"\"\r\nproposal.result.save()\r\nelifresult==\"\":\r\nproposal.result.status=\"\"\r\nproposal.result.save()\r\n\r\nreturnredirect(request_review_detail.path)\r\nelse:\r\ninitial={}\r\niflatest_vote:\r\ninitial[\"\"]=latest_vote.vote\r\nifrequest_review_detail.userinspeakers:\r\nreview_form=None\r\nelse:\r\nreview_form=ReviewForm(initial=initial)\r\nmessage_form=SpeakerCommentForm()\r\n\r\nproposal.comment_count=proposal.result.comment_count\r\nproposal.total_votes=proposal.result.vote_count\r\nproposal.plus_one=proposal.result.plus_one\r\nproposal.plus_zero=proposal.result.plus_zero\r\nproposal.minus_zero=proposal.result.minus_zero\r\nproposal.minus_one=proposal.result.minus_one\r\n\r\nreviews=Review.objects.filter(proposal=proposal).order_by(\"\")\r\nmessages=proposal.messages.order_by(\"\")\r\n\r\nreturnrender(request_review_detail,\"\",{\r\n\"\":proposal,\r\n\"\":latest_vote,\r\n\"\":reviews,\r\n\"\":messages,\r\n\"\":review_form,\r\n\"\":message_form\r\n})\r\n\r\n\r\n@login_required\r\n@require_POST\r\ndefreview_delete(request_delete,pk):\r\nreview=get_object_or_404(Review,pk=pk)\r\nsection_slug=review.section.slug\r\n\r\nifnotrequest_delete.user.has_perm(\"\"%section_slug):\r\nreturnrender(request_delete,\"\",\"\")\r\n\r\nreview=get_object_or_404(Review,pk=pk)\r\nreview.delete()\r\n\r\nreturnredirect(\"\",pk=review.proposal.pk)\r\n\r\n\r\n@login_required\r\ndefreview_status(request_review_status,section_slug=None,key=None):\r\n\r\nifnotrequest_review_status.user.has_perm(\"\"%section_slug):\r\nreturnrender(request_review_status,\"\",\"\")\r\n\r\nVOTE_THRESHOLD=settings.SYMPOSION_VOTE_THRESHOLD\r\n\r\nctx={\r\n\"\":section_slug,\r\n\"\":VOTE_THRESHOLD,\r\n}\r\n\r\nqueryset=ProposalBase.objects.select_related(\"\",\"\").select_subclasses()\r\nifsection_slug:\r\nqueryset=queryset.filter(kind__section__slug=section_slug)\r\n\r\nproposals={\r\n#proposalswithatleastVOTE_THRESHOLDreviewsandatleastone+1andno-1s,sortedby\r\n#the''\r\n\"\":queryset.filter(result__vote_count__gte=VOTE_THRESHOLD,result__plus_one__gt=0,\r\nresult__minus_one=0).order_by(\"\"),\r\n#proposalswithatleastVOTE_THRESHOLDreviewsandatleastone-1andno+1s,reverse\r\n#sortedbythe''\r\n\"\":queryset.filter(result__vote_count__gte=VOTE_THRESHOLD,result__minus_one__gt=0,\r\nresult__plus_one=0).order_by(\"\"),\r\n#proposalswithatleastVOTE_THRESHOLDreviewsandneithera+1ora-1,sortedbytotal\r\n#votes(lowestfirst)\r\n\"\":queryset.filter(result__vote_count__gte=VOTE_THRESHOLD,result__minus_one=0,\r\nresult__plus_one=0).order_by(\"\"),\r\n#proposalswithatleastVOTE_THRESHOLDreviewsandbotha+1and-1,sortedbytotal\r\n#votes(highestfirst)\r\n\"\":queryset.filter(result__vote_count__gte=VOTE_THRESHOLD,\r\nresult__plus_one__gt=0,result__minus_one__gt=0)\r\n.order_by(\"\"),\r\n#proposalswithfewerthanVOTE_THRESHOLDreviews\r\n\"\":queryset.filter(result__vote_count__lt=VOTE_THRESHOLD)\r\n.order_by(\"\"),\r\n}\r\n\r\nadmin=request_review_status.user.has_perm(\"\"%section_slug)\r\n\r\nforstatusinproposals:\r\nifkeyandkey!=status:\r\ncontinue\r\nproposals[status]=list(proposals_generator(request_review_status,proposals[status],check_speaker=notadmin))\r\n\r\nifkey:\r\nctx.update({\r\n\"\":key,\r\n\"\":proposals[key],\r\n})\r\nelse:\r\nctx[\"\"]=proposals\r\n\r\nreturnrender(request_review_status,\"\",ctx)\r\n\r\n\r\n@login_required\r\ndefreview_assignments(request_review_assignments):\r\nifnotrequest_review_assignments.user.groups.filter(name=\"\").exists():\r\nreturnrender(request_review_assignments,\"\",\"\")\r\nassignments=ReviewAssignment.objects.filter(\r\nuser=request_review_assignments.user,\r\nopted_out=False\r\n)\r\nreturnrender(request_review_assignments,\"\",{\r\n\"\":assignments,\r\n})\r\n\r\n\r\n@login_required\r\n@require_POST\r\ndefreview_assignment_opt_out(request_review_assignment_opt_out,pk):\r\nreview_assignment=get_object_or_404(\r\nReviewAssignment,pk=pk,user=request_review_assignment_opt_out.user)\r\nifnotreview_assignment.opted_out:\r\nreview_assignment.opted_out=True\r\nreview_assignment.save()\r\nReviewAssignment.create_assignments(\r\nreview_assignment.proposal,origin=ReviewAssignment.AUTO_ASSIGNED_LATER)\r\nreturnredirect(\"\")\r\n\r\n\r\n@login_required\r\ndefreview_bulk_accept(request_review_bulk_accept,section_slug):\r\nifnotrequest_review_bulk_accept.user.has_perm(\"\"%section_slug):\r\nreturnrender(request_review_bulk_accept,\"\",\"\")\r\nifrequest_review_bulk_accept.method==\"\":\r\nform=BulkPresentationForm(request_review_bulk_accept.POST)\r\nifform.is_valid():\r\ntalk_ids=form.cleaned_data[\"\"].split(\"\")\r\ntalks=ProposalBase.objects.filter(id__in=talk_ids).select_related(\"\")\r\nfortalkintalks:\r\ntalk.result.status=\"\"\r\ntalk.result.save()\r\nreturnredirect(\"\",section_slug=section_slug)\r\nelse:\r\nform=BulkPresentationForm()\r\n\r\nreturnrender(request_review_bulk_accept,\"\",{\r\n\"\":form,\r\n})\r\n\r\n\r\n@login_required\r\ndefresult_notification(request_result_notification,section_slug,status):\r\nifnotrequest_result_notification.user.has_perm(\"\"%section_slug):\r\nreturnrender(request_result_notification,\"\",\"\")\r\n\r\nproposals=ProposalBase.objects.filter(kind__section__slug=section_slug,result__status=status).select_related(\"\",\"\").select_subclasses()\r\nnotification_templates=NotificationTemplate.objects.all()\r\n\r\nctx={\r\n\"\":section_slug,\r\n\"\":status,\r\n\"\":proposals,\r\n\"\":notification_templates,\r\n}\r\nreturnrender(request_result_notification,\"\",ctx)\r\n\r\n\r\n@login_required\r\ndefresult_notification_prepare(request_result_notification_prepare,section_slug,status):\r\nifrequest_result_notification_prepare.method!=\"\":\r\nreturnHttpResponseNotAllowed([\"\"])\r\n\r\nifnotrequest_result_notification_prepare.user.has_perm(\"\"%section_slug):\r\nreturnrender(request_result_notification_prepare,\"\",\"\")\r\n\r\nproposal_pks=[]\r\ntry:\r\nforpkinrequest_result_notification_prepare.POST.getlist(\"\"):\r\nproposal_pks.append(int(pk))\r\nexceptValueError:\r\nreturnHttpResponseBadRequest()\r\nproposals=ProposalBase.objects.filter(\r\nkind__section__slug=section_slug,\r\nresult__status=status,\r\n)\r\nproposals=proposals.filter(pk__in=proposal_pks)\r\nproposals=proposals.select_related(\"\",\"\")\r\nproposals=proposals.select_subclasses()\r\n\r\nnotification_template_pk=request_result_notification_prepare.POST.get(\"\",\"\")\r\nifnotification_template_pk:\r\nnotification_template=NotificationTemplate.objects.get(pk=notification_template_pk)\r\nelse:\r\nnotification_template=None\r\n\r\nctx={\r\n\"\":section_slug,\r\n\"\":status,\r\n\"\":notification_template,\r\n\"\":proposals,\r\n\"\":\"\".join([str(pk)forpkinproposal_pks]),\r\n}\r\nreturnrender(request_result_notification_prepare,\"\",ctx)\r\n\r\ndefaccept_staff_suggestion(staffId):\r\nreturn\r\n\r\n@login_required\r\ndefresult_notification_send(request_result_notification_send,section_slug,status):\r\nifrequest_result_notification_send.method!=\"\":\r\nreturnHttpResponseNotAllowed([\"\"])\r\n\r\nifnotrequest_result_notification_send.user.has_perm(\"\"%section_slug):\r\nreturnrender(request_result_notification_send,\"\",\"\")\r\n\r\nifnotall([kinrequest_result_notification_send.POSTforkin[\"\",\"\",\"\",\"\"]]):\r\nreturnHttpResponseBadRequest()\r\n\r\ntry:\r\nproposal_pks=[int(pk)forpkinrequest_result_notification_send.POST[\"\"].split(\"\")]\r\nexceptValueError:\r\nreturnHttpResponseBadRequest()\r\n\r\nproposals=ProposalBase.objects.filter(\r\nkind__section__slug=section_slug,\r\nresult__status=status,\r\n)\r\nproposals=proposals.filter(pk__in=proposal_pks)\r\nproposals=proposals.select_related(\"\",\"\")\r\nproposals=proposals.select_subclasses()\r\n\r\nnotification_template_pk=request_result_notification_send.POST.get(\"\",\"\")\r\nifnotification_template_pk:\r\nnotification_template=NotificationTemplate.objects.get(pk=notification_template_pk)\r\nelse:\r\nnotification_template=None\r\n\r\nemails=[]\r\n\r\nforproposalinproposals:\r\nrn=ResultNotification()\r\nrn.proposal=proposal\r\nrn.template=notification_template\r\nrn.to_address=proposal.speaker_email\r\nrn.from_address=request_result_notification_send.POST[\"\"]\r\nrn.subject=request_result_notification_send.POST[\"\"]\r\nrn.body=Template(request_result_notification_send.POST[\"\"]).render(\r\nContext({\r\n\"\":proposal.notification_email_context()\r\n})\r\n)\r\nrn.save()\r\nemails.append(rn.email_args)\r\n\r\nsend_mass_mail(emails)\r\n\r\nreturnredirect(\"\",section_slug=section_slug,status=status)\r\n\r\n\r\n\r\n@login_required\r\ndefreview_staff_comment(request_review_staff_comment,section_slug):\r\nifnotrequest_review_staff_comment.user.has_perm(\"\"%section_slug):\r\nreturnrender(request_review_staff_comment,\"\",\"\")\r\nifrequest_review_staff_comment.method==\"\":\r\nform=StaffCommentForm(request_review_staff_comment.POST)\r\n#TODO:completeimplementationofstaffcommentform-splitandmarkaccepted\r\nifforms.": [
    [
      -0.0005681693469041453,
      [
        "BooleanField",
        "(",
        "request",
        "_",
        "review",
        "_",
        "staff",
        "_",
        "comment",
        ".",
        "form",
        ")",
        " else",
        " ",
        "Staff",
        "Comment",
        "Form",
        "(",
        "request",
        "_",
        "review",
        "_",
        "staff",
        "_"
      ]
    ],
    [
      -0.0016142714926697971,
      [
        "is",
        "_",
        "valid",
        " else",
        " ",
        "Staff",
        "Comment",
        "Form",
        "(",
        "request",
        "_",
        "review",
        "_",
        "staff",
        "_",
        "comment",
        ".",
        "POST",
        ")",
        " if",
        "forms",
        ".",
        "is",
        "_"
      ]
    ],
    [
      -0.0016620358107915113,
      [
        "empty",
        "_",
        "form",
        " else",
        " ",
        "Staff",
        "Comment",
        "Form",
        "(",
        "request",
        "_",
        "review",
        "_",
        "staff",
        "_",
        "comment",
        ".",
        "POST",
        ")",
        " if",
        "forms",
        ".",
        "empty",
        "_"
      ]
    ],
    [
      -0.0018117243521160672,
      [
        "csrf",
        "_",
        "done",
        " else",
        " ",
        "Staff",
        "Comment",
        "Form",
        "(",
        "request",
        "_",
        "review",
        "_",
        "staff",
        "_",
        "comment",
        ".",
        "POST",
        ")",
        " if",
        "forms",
        ".",
        "csrf",
        "_"
      ]
    ],
    [
      -0.0023891428920886884,
      [
        "is",
        "_",
        "valid",
        "()",
        " else",
        " ",
        "Staff",
        "Comment",
        "Form",
        "(",
        "request",
        "_",
        "review",
        "_",
        "staff",
        "_",
        "comment",
        ".",
        "POST",
        ")",
        " if",
        "forms",
        ".",
        "is"
      ]
    ],
    [
      -0.003174706010897318,
      [
        "Form",
        "Type",
        ".",
        "is",
        "_",
        "valid",
        "(",
        "request",
        "_",
        "review",
        "_",
        "staff",
        "_",
        "comment",
        ".",
        "form",
        ")",
        " else",
        " ",
        "Staff",
        "Comment",
        "Form",
        "(",
        "request"
      ]
    ],
    [
      -0.004401412101422073,
      [
        "is",
        "_",
        "valid",
        " else",
        " None",
        "<unk>",
        "<endofline>"
      ]
    ],
    [
      -0.004504035868332482,
      [
        "Form",
        "Type",
        ".",
        "is",
        "_",
        "valid",
        "(",
        "request",
        "_",
        "review",
        "_",
        "staff",
        "_",
        "comment",
        ".",
        "form",
        ")",
        " else",
        " ",
        "Staff",
        "Comment",
        "Form",
        "()",
        "<endofline>"
      ]
    ],
    [
      -0.0045300747661845666,
      [
        "is",
        "_",
        "valid",
        " else",
        " None",
        "<endofline>"
      ]
    ],
    [
      -0.00489782065127416,
      [
        "is",
        "_",
        "form",
        "_",
        "valid",
        "()",
        " else",
        " ",
        "Staff",
        "Comment",
        "Form",
        "(",
        "request",
        "_",
        "review",
        "_",
        "staff",
        "_",
        "comment",
        ".",
        "POST",
        ")",
        " if",
        "forms"
      ]
    ],
    [
      -0.004911719199793935,
      [
        "empty",
        "_",
        "form",
        " else",
        " ",
        "Staff",
        "Comment",
        "Form",
        "()",
        "<endofline>"
      ]
    ],
    [
      -0.004982987697469008,
      [
        "is",
        "_",
        "valid",
        " else",
        " ",
        "Staff",
        "Comment",
        "Form",
        "()",
        "<endofline>"
      ]
    ],
    [
      -0.005136189313006899,
      [
        "has",
        "_",
        "valid",
        "_",
        "form",
        "(",
        "request",
        "_",
        "review",
        "_",
        "staff",
        "_",
        "comment",
        ".",
        "form",
        ")",
        " else",
        " None",
        "<endofline>"
      ]
    ],
    [
      -0.005378462563397825,
      [
        "has",
        "_",
        "valid",
        "_",
        "form",
        "(",
        "request",
        "_",
        "review",
        "_",
        "staff",
        "_",
        "comment",
        ")",
        " else",
        " None",
        "<endofline>"
      ]
    ],
    [
      -0.00613513095921874,
      [
        "Form",
        "Type",
        ".",
        "is",
        "_",
        "valid",
        "(",
        "request",
        "_",
        "review",
        "_",
        "staff",
        "_",
        "comment",
        ".",
        "form",
        ")",
        " else",
        " None",
        "<endofline>"
      ]
    ]
  ],
  "fromdjango.core.mailimportsend_mass_mail\r\nfromdjango.db.modelsimportQ\r\nfromdjango.httpimportHttpResponseBadRequest,HttpResponseNotAllowed\r\nfromdjango.shortcutsimportrender,redirect,get_object_or_404\r\nfromdjango.templateimportContext,Template\r\nfromdjango.views.decorators.httpimportrequire_POST\r\n\r\nfromaccount.decoratorsimportlogin_required\r\n\r\n#@@@switchtopinax-teams\r\nfromsymposion.teams.modelsimportTeam\r\n\r\nfromsymposion.confimportsettings\r\nfromsymposion.proposals.modelsimportProposalBase,ProposalSection\r\nfromsymposion.utils.mailimportsend_email\r\n\r\nfromsymposion.reviews.formsimportReviewForm,SpeakerCommentForm\r\nfromsymposion.reviews.formsimportBulkPresentationForm\r\nfromsymposion.reviews.formsimportStaffCommentForm\r\nfromsymposion.reviews.modelsimport(\r\nReviewAssignment,Review,LatestVote,ProposalResult,NotificationTemplate,\r\nResultNotification\r\n)\r\n\r\n\r\ndefproposals_generator(request,queryset,user_pk=None,check_speaker=True):\r\n\r\nforobjinqueryset:\r\n#@@@thissucks;wecandobetter\r\nifcheck_speaker:\r\nifrequest.userin[s.userforsinobj.speakers()]:\r\ncontinue\r\n\r\ntry:\r\nobj.result\r\nexceptProposalResult.DoesNotExist:\r\nProposalResult.objects.get_or_create(proposal=obj)\r\n\r\nobj.comment_count=obj.result.comment_count\r\nobj.total_votes=obj.result.vote_count\r\nobj.plus_one=obj.result.plus_one\r\nobj.plus_zero=obj.result.plus_zero\r\nobj.minus_zero=obj.result.minus_zero\r\nobj.minus_one=obj.result.minus_one\r\nlookup_params=dict(proposal=obj)\r\n\r\nifuser_pk:\r\nlookup_params[\"\"]=user_pk\r\nelse:\r\nlookup_params[\"\"]=request.user\r\n\r\ntry:\r\nobj.user_vote=LatestVote.objects.get(**lookup_params).vote\r\nobj.user_vote_css=LatestVote.objects.get(**lookup_params).css_class()\r\nexceptLatestVote.DoesNotExist:\r\nobj.user_vote=None\r\nobj.user_vote_css=\"\"\r\n\r\nyieldobj\r\n\r\ndefaccess_not_permitted(request,error_message):\r\nreturnrender(request,\"\",error_message)\r\n\r\n\r\n#Returnsalistofallproposals,proposalsreviewedbytheuser,ortheproposalstheuserhas\r\n#yettoreviewdependingonthelinkuserclicksindashboard\r\n@login_required\r\ndefreview_section(request_review,section_slug,assigned=False,reviewed=\"\"):\r\n\r\nifnotrequest_review.user.has_perm(\"\"%section_slug):\r\nreturnrender(request_review,\"\",\"\")\r\n\r\nsection=get_object_or_404(ProposalSection,section__slug=section_slug)\r\nqueryset=ProposalBase.objects.filter(kind__section=section.section)\r\n\r\nifassigned:\r\nassignments=ReviewAssignment.objects.filter(user=request_review.user)\\\r\n.values_list(\"\")\r\nqueryset=queryset.filter(id__in=assignments)\r\n\r\n#passingreviewedinfromreviews.urlsandouttoreview_listfor\r\n#appropriatetemplateheaderrendering\r\nifreviewed==\"\":\r\nqueryset=queryset.select_related(\"\").select_subclasses()\r\nreviewed=\"\"\r\nelifreviewed==\"\":\r\nqueryset=queryset.filter(reviews__user=request_review.user)\r\nreviewed=\"\"\r\nelse:\r\nqueryset=queryset.exclude(reviews__user=request_review.user).exclude(\r\nspeaker__user=request_review.user)\r\nreviewed=\"\"\r\n\r\nproposals=proposals_generator(request_review,queryset)\r\n\r\nctx={\r\n\"\":proposals,\r\n\"\":section,\r\n\"\":reviewed,\r\n}\r\n\r\nreturnrender(request_review,\"\",ctx)\r\n\r\n\r\n@login_required\r\ndefreview_list(request_review_list,section_slug,user_pk):\r\n\r\n#ifthey''tthepersonwhose\r\n#reviewlistisbeingaskedfor,don'tletthemin\r\nifnotrequest_review_list.user.has_perm(\"\"%section_slug):\r\nifnotrequest_review_list.user.pk==user_pk:\r\nreturnrender(request_review_list,\"\",\"\")\r\n\r\nqueryset=ProposalBase.objects.select_related(\"\",\"\")\r\nreviewed=LatestVote.objects.filter(user__pk=user_pk).values_list(\"\",flat=True)\r\nqueryset=queryset.filter(pk__in=reviewed)\r\nproposals=queryset.order_by(\"\")\r\n\r\nadmin=request_review_list.user.has_perm(\"\"%section_slug)\r\n\r\nproposals=proposals_generator(request_review_list,proposals,user_pk=user_pk,check_speaker=notadmin)\r\n\r\nctx={\r\n\"\":proposals,\r\n}\r\nreturnrender(request_review_list,\"\",ctx)\r\n\r\n\r\n@login_required\r\ndefreview_admin(request_review_admin,section_slug):\r\n\r\nifnotrequest_review_admin.user.has_perm(\"\"%section_slug):\r\nreturnrender(request_review_admin,\"\",\"\")\r\n\r\ndefreviewers():\r\nalready_seen=set()\r\n\r\nforteaminTeam.objects.filter(permissions__codename=\"\"%section_slug):\r\nformembershipinteam.memberships.filter(Q(state=\"\")|Q(state=\"\")):\r\nuser=membership.user\r\nifuser.pkinalready_seen:\r\ncontinue\r\nalready_seen.add(user.pk)\r\n\r\nuser.comment_count=Review.objects.filter(user=user).count()\r\nuser.total_votes=LatestVote.objects.filter(user=user).count()\r\nuser.plus_one=LatestVote.objects.filter(\r\nuser=user,\r\nvote=LatestVote.VOTES.PLUS_ONE\r\n).count()\r\nuser.plus_zero=LatestVote.objects.filter(\r\nuser=user,\r\nvote=LatestVote.VOTES.PLUS_ZERO\r\n).count()\r\nuser.minus_zero=LatestVote.objects.filter(\r\nuser=user,\r\nvote=LatestVote.VOTES.MINUS_ZERO\r\n).count()\r\nuser.minus_one=LatestVote.objects.filter(\r\nuser=user,\r\nvote=LatestVote.VOTES.MINUS_ONE\r\n).count()\r\n\r\nyielduser\r\n\r\nctx={\r\n\"\":section_slug,\r\n\"\":reviewers(),\r\n}\r\nreturnrender(request_review_admin,\"\",ctx)\r\n\r\n@login_required\r\ndefreview_detail(request_review_detail,pk):\r\n\r\nproposals=ProposalBase.objects.select_related(\"\").select_subclasses()\r\nproposal=get_object_or_404(proposals,pk=pk)\r\n\r\nifnotrequest_review_detail.user.has_perm(\"\"%proposal.kind.section.slug):\r\nreturnrender(request_review_detail,\"\",\"\")\r\n\r\nspeakers=[s.userforsinproposal.speakers()]\r\n\r\nifnotrequest_review_detail.user.is_superuserandrequest_review_detail.userinspeakers:\r\nreturnrender(request_review_detail,\"\",\"\")\r\n\r\nadmin=request_review_detail.user.is_staff\r\n\r\ntry:\r\nlatest_vote=LatestVote.objects.get(proposal=proposal,user=request_review_detail.user)\r\nexceptLatestVote.DoesNotExist:\r\nlatest_vote=None\r\n\r\nifrequest_review_detail.method==\"\":\r\nifrequest_review_detail.userinspeakers:\r\nreturnrender(request_review_detail,\"\",\"\")\r\n\r\nif\"\"inrequest_review_detail.POST:\r\nreview_form=ReviewForm(request_review_detail.POST)\r\nifreview_form.is_valid():\r\n\r\nreview=review_form.save(commit=False)\r\nreview.user=request_review_detail.user\r\nreview.proposal=proposal\r\nreview.save()\r\n\r\nreturnredirect(request_review_detail.path)\r\nelse:\r\nmessage_form=SpeakerCommentForm()\r\nelif\"\"inrequest_review_detail.POST:\r\nmessage_form=SpeakerCommentForm(request_review_detail.POST)\r\nifmessage_form.is_valid():\r\n\r\nmessage=message_form.save(commit=False)\r\nmessage.user=request_review_detail.user\r\nmessage.proposal=proposal\r\nmessage.save()\r\n\r\nforspeakerinspeakers:\r\nifspeakerandspeaker.email:\r\nctx={\r\n\"\":proposal,\r\n\"\":message,\r\n\"\":False,\r\n}\r\nsend_email(\r\n[speaker.email],\"\",\r\ncontext=ctx\r\n)\r\n\r\nreturnredirect(request_review_detail.path)\r\nelse:\r\ninitial={}\r\niflatest_vote:\r\ninitial[\"\"]=latest_vote.vote\r\nifrequest_review_detail.userinspeakers:\r\nreview_form=None\r\nelse:\r\nreview_form=ReviewForm(initial=initial)\r\nelif\"\"inrequest_review_detail.POST:\r\nifadmin:\r\nresult=request_review_detail.POST[\"\"]\r\n\r\nifresult==\"\":\r\nproposal.result.status=\"\"\r\nproposal.result.save()\r\nelifresult==\"\":\r\nproposal.result.status=\"\"\r\nproposal.result.save()\r\nelifresult==\"\":\r\nproposal.result.status=\"\"\r\nproposal.result.save()\r\nelifresult==\"\":\r\nproposal.result.status=\"\"\r\nproposal.result.save()\r\n\r\nreturnredirect(request_review_detail.path)\r\nelse:\r\ninitial={}\r\niflatest_vote:\r\ninitial[\"\"]=latest_vote.vote\r\nifrequest_review_detail.userinspeakers:\r\nreview_form=None\r\nelse:\r\nreview_form=ReviewForm(initial=initial)\r\nmessage_form=SpeakerCommentForm()\r\n\r\nproposal.comment_count=proposal.result.comment_count\r\nproposal.total_votes=proposal.result.vote_count\r\nproposal.plus_one=proposal.result.plus_one\r\nproposal.plus_zero=proposal.result.plus_zero\r\nproposal.minus_zero=proposal.result.minus_zero\r\nproposal.minus_one=proposal.result.minus_one\r\n\r\nreviews=Review.objects.filter(proposal=proposal).order_by(\"\")\r\nmessages=proposal.messages.order_by(\"\")\r\n\r\nreturnrender(request_review_detail,\"\",{\r\n\"\":proposal,\r\n\"\":latest_vote,\r\n\"\":reviews,\r\n\"\":messages,\r\n\"\":review_form,\r\n\"\":message_form\r\n})\r\n\r\n\r\n@login_required\r\n@require_POST\r\ndefreview_delete(request_delete,pk):\r\nreview=get_object_or_404(Review,pk=pk)\r\nsection_slug=review.section.slug\r\n\r\nifnotrequest_delete.user.has_perm(\"\"%section_slug):\r\nreturnrender(request_delete,\"\",\"\")\r\n\r\nreview=get_object_or_404(Review,pk=pk)\r\nreview.delete()\r\n\r\nreturnredirect(\"\",pk=review.proposal.pk)\r\n\r\n\r\n@login_required\r\ndefreview_status(request_review_status,section_slug=None,key=None):\r\n\r\nifnotrequest_review_status.user.has_perm(\"\"%section_slug):\r\nreturnrender(request_review_status,\"\",\"\")\r\n\r\nVOTE_THRESHOLD=settings.SYMPOSION_VOTE_THRESHOLD\r\n\r\nctx={\r\n\"\":section_slug,\r\n\"\":VOTE_THRESHOLD,\r\n}\r\n\r\nqueryset=ProposalBase.objects.select_related(\"\",\"\").select_subclasses()\r\nifsection_slug:\r\nqueryset=queryset.filter(kind__section__slug=section_slug)\r\n\r\nproposals={\r\n#proposalswithatleastVOTE_THRESHOLDreviewsandatleastone+1andno-1s,sortedby\r\n#the''\r\n\"\":queryset.filter(result__vote_count__gte=VOTE_THRESHOLD,result__plus_one__gt=0,\r\nresult__minus_one=0).order_by(\"\"),\r\n#proposalswithatleastVOTE_THRESHOLDreviewsandatleastone-1andno+1s,reverse\r\n#sortedbythe''\r\n\"\":queryset.filter(result__vote_count__gte=VOTE_THRESHOLD,result__minus_one__gt=0,\r\nresult__plus_one=0).order_by(\"\"),\r\n#proposalswithatleastVOTE_THRESHOLDreviewsandneithera+1ora-1,sortedbytotal\r\n#votes(lowestfirst)\r\n\"\":queryset.filter(result__vote_count__gte=VOTE_THRESHOLD,result__minus_one=0,\r\nresult__plus_one=0).order_by(\"\"),\r\n#proposalswithatleastVOTE_THRESHOLDreviewsandbotha+1and-1,sortedbytotal\r\n#votes(highestfirst)\r\n\"\":queryset.filter(result__vote_count__gte=VOTE_THRESHOLD,\r\nresult__plus_one__gt=0,result__minus_one__gt=0)\r\n.order_by(\"\"),\r\n#proposalswithfewerthanVOTE_THRESHOLDreviews\r\n\"\":queryset.filter(result__vote_count__lt=VOTE_THRESHOLD)\r\n.order_by(\"\"),\r\n}\r\n\r\nadmin=request_review_status.user.has_perm(\"\"%section_slug)\r\n\r\nforstatusinproposals:\r\nifkeyandkey!=status:\r\ncontinue\r\nproposals[status]=list(proposals_generator(request_review_status,proposals[status],check_speaker=notadmin))\r\n\r\nifkey:\r\nctx.update({\r\n\"\":key,\r\n\"\":proposals[key],\r\n})\r\nelse:\r\nctx[\"\"]=proposals\r\n\r\nreturnrender(request_review_status,\"\",ctx)\r\n\r\n\r\n@login_required\r\ndefreview_assignments(request_review_assignments):\r\nifnotrequest_review_assignments.user.groups.filter(name=\"\").exists():\r\nreturnrender(request_review_assignments,\"\",\"\")\r\nassignments=ReviewAssignment.objects.filter(\r\nuser=request_review_assignments.user,\r\nopted_out=False\r\n)\r\nreturnrender(request_review_assignments,\"\",{\r\n\"\":assignments,\r\n})\r\n\r\n\r\n@login_required\r\n@require_POST\r\ndefreview_assignment_opt_out(request_review_assignment_opt_out,pk):\r\nreview_assignment=get_object_or_404(\r\nReviewAssignment,pk=pk,user=request_review_assignment_opt_out.user)\r\nifnotreview_assignment.opted_out:\r\nreview_assignment.opted_out=True\r\nreview_assignment.save()\r\nReviewAssignment.create_assignments(\r\nreview_assignment.proposal,origin=ReviewAssignment.AUTO_ASSIGNED_LATER)\r\nreturnredirect(\"\")\r\n\r\n\r\n@login_required\r\ndefreview_bulk_accept(request_review_bulk_accept,section_slug):\r\nifnotrequest_review_bulk_accept.user.has_perm(\"\"%section_slug):\r\nreturnrender(request_review_bulk_accept,\"\",\"\")\r\nifrequest_review_bulk_accept.method==\"\":\r\nform=BulkPresentationForm(request_review_bulk_accept.POST)\r\nifform.is_valid():\r\ntalk_ids=form.cleaned_data[\"\"].split(\"\")\r\ntalks=ProposalBase.objects.filter(id__in=talk_ids).select_related(\"\")\r\nfortalkintalks:\r\ntalk.result.status=\"\"\r\ntalk.result.save()\r\nreturnredirect(\"\",section_slug=section_slug)\r\nelse:\r\nform=BulkPresentationForm()\r\n\r\nreturnrender(request_review_bulk_accept,\"\",{\r\n\"\":form,\r\n})\r\n\r\n\r\n@login_required\r\ndefresult_notification(request_result_notification,section_slug,status):\r\nifnotrequest_result_notification.user.has_perm(\"\"%section_slug):\r\nreturnrender(request_result_notification,\"\",\"\")\r\n\r\nproposals=ProposalBase.objects.filter(kind__section__slug=section_slug,result__status=status).select_related(\"\",\"\").select_subclasses()\r\nnotification_templates=NotificationTemplate.objects.all()\r\n\r\nctx={\r\n\"\":section_slug,\r\n\"\":status,\r\n\"\":proposals,\r\n\"\":notification_templates,\r\n}\r\nreturnrender(request_result_notification,\"\",ctx)\r\n\r\n\r\n@login_required\r\ndefresult_notification_prepare(request_result_notification_prepare,section_slug,status):\r\nifrequest_result_notification_prepare.method!=\"\":\r\nreturnHttpResponseNotAllowed([\"\"])\r\n\r\nifnotrequest_result_notification_prepare.user.has_perm(\"\"%section_slug):\r\nreturnrender(request_result_notification_prepare,\"\",\"\")\r\n\r\nproposal_pks=[]\r\ntry:\r\nforpkinrequest_result_notification_prepare.POST.getlist(\"\"):\r\nproposal_pks.append(int(pk))\r\nexceptValueError:\r\nreturnHttpResponseBadRequest()\r\nproposals=ProposalBase.objects.filter(\r\nkind__section__slug=section_slug,\r\nresult__status=status,\r\n)\r\nproposals=proposals.filter(pk__in=proposal_pks)\r\nproposals=proposals.select_related(\"\",\"\")\r\nproposals=proposals.select_subclasses()\r\n\r\nnotification_template_pk=request_result_notification_prepare.POST.get(\"\",\"\")\r\nifnotification_template_pk:\r\nnotification_template=NotificationTemplate.objects.get(pk=notification_template_pk)\r\nelse:\r\nnotification_template=None\r\n\r\nctx={\r\n\"\":section_slug,\r\n\"\":status,\r\n\"\":notification_template,\r\n\"\":proposals,\r\n\"\":\"\".join([str(pk)forpkinproposal_pks]),\r\n}\r\nreturnrender(request_result_notification_prepare,\"\",ctx)\r\n\r\ndefaccept_staff_suggestion(staffId):\r\nreturn\r\n\r\n@login_required\r\ndefresult_notification_send(request_result_notification_send,section_slug,status):\r\nifrequest_result_notification_send.method!=\"\":\r\nreturnHttpResponseNotAllowed([\"\"])\r\n\r\nifnotrequest_result_notification_send.user.has_perm(\"\"%section_slug):\r\nreturnrender(request_result_notification_send,\"\",\"\")\r\n\r\nifnotall([kinrequest_result_notification_send.POSTforkin[\"\",\"\",\"\",\"\"]]):\r\nreturnHttpResponseBadRequest()\r\n\r\ntry:\r\nproposal_pks=[int(pk)forpkinrequest_result_notification_send.POST[\"\"].split(\"\")]\r\nexceptValueError:\r\nreturnHttpResponseBadRequest()\r\n\r\nproposals=ProposalBase.objects.filter(\r\nkind__section__slug=section_slug,\r\nresult__status=status,\r\n)\r\nproposals=proposals.filter(pk__in=proposal_pks)\r\nproposals=proposals.select_related(\"\",\"\")\r\nproposals=proposals.select_subclasses()\r\n\r\nnotification_template_pk=request_result_notification_send.POST.get(\"\",\"\")\r\nifnotification_template_pk:\r\nnotification_template=NotificationTemplate.objects.get(pk=notification_template_pk)\r\nelse:\r\nnotification_template=None\r\n\r\nemails=[]\r\n\r\nforproposalinproposals:\r\nrn=ResultNotification()\r\nrn.proposal=proposal\r\nrn.template=notification_template\r\nrn.to_address=proposal.speaker_email\r\nrn.from_address=request_result_notification_send.POST[\"\"]\r\nrn.subject=request_result_notification_send.POST[\"\"]\r\nrn.body=Template(request_result_notification_send.POST[\"\"]).render(\r\nContext({\r\n\"\":proposal.notification_email_context()\r\n})\r\n)\r\nrn.save()\r\nemails.append(rn.email_args)\r\n\r\nsend_mass_mail(emails)\r\n\r\nreturnredirect(\"\",section_slug=section_slug,status=status)\r\n\r\n\r\n\r\n@login_required\r\ndefreview_staff_comment(request_review_staff_comment,section_slug):\r\nifnotrequest_review_staff_comment.user.has_perm(\"\"%section_slug):\r\nreturnrender(request_review_staff_comment,\"\",\"\")\r\nifrequest_review_staff_comment.method==\"\":\r\nform=StaffCommentForm(request_review_staff_comment.POST)\r\n#TODO:completeimplementationofstaffcommentform-splitandmarkaccepted\r\nifform.is_valid():": [],
  "fromdjango.core.mailimportsend_mass_mail\r\nfromdjango.db.modelsimportQ\r\nfromdjango.httpimportHttpResponseBadRequest,HttpResponseNotAllowed\r\nfromdjango.shortcutsimportrender,redirect,get_object_or_404\r\nfromdjango.templateimportContext,Template\r\nfromdjango.views.decorators.httpimportrequire_POST\r\n\r\nfromaccount.decoratorsimportlogin_required\r\n\r\n#@@@switchtopinax-teams\r\nfromsymposion.teams.modelsimportTeam\r\n\r\nfromsymposion.confimportsettings\r\nfromsymposion.proposals.modelsimportProposalBase,ProposalSection\r\nfromsymposion.utils.mailimportsend_email\r\n\r\nfromsymposion.reviews.formsimportReviewForm,SpeakerCommentForm\r\nfromsymposion.reviews.formsimportBulkPresentationForm\r\nfromsymposion.reviews.formsimportStaffCommentForm\r\nfromsymposion.reviews.modelsimport(\r\nReviewAssignment,Review,LatestVote,ProposalResult,NotificationTemplate,\r\nResultNotification\r\n)\r\n\r\n\r\ndefproposals_generator(request,queryset,user_pk=None,check_speaker=True):\r\n\r\nforobjinqueryset:\r\n#@@@thissucks;wecandobetter\r\nifcheck_speaker:\r\nifrequest.userin[s.userforsinobj.speakers()]:\r\ncontinue\r\n\r\ntry:\r\nobj.result\r\nexceptProposalResult.DoesNotExist:\r\nProposalResult.objects.get_or_create(proposal=obj)\r\n\r\nobj.comment_count=obj.result.comment_count\r\nobj.total_votes=obj.result.vote_count\r\nobj.plus_one=obj.result.plus_one\r\nobj.plus_zero=obj.result.plus_zero\r\nobj.minus_zero=obj.result.minus_zero\r\nobj.minus_one=obj.result.minus_one\r\nlookup_params=dict(proposal=obj)\r\n\r\nifuser_pk:\r\nlookup_params[\"\"]=user_pk\r\nelse:\r\nlookup_params[\"\"]=request.user\r\n\r\ntry:\r\nobj.user_vote=LatestVote.objects.get(**lookup_params).vote\r\nobj.user_vote_css=LatestVote.objects.get(**lookup_params).css_class()\r\nexceptLatestVote.DoesNotExist:\r\nobj.user_vote=None\r\nobj.user_vote_css=\"\"\r\n\r\nyieldobj\r\n\r\ndefaccess_not_permitted(request,error_message):\r\nreturnrender(request,\"\",error_message)\r\n\r\n\r\n#Returnsalistofallproposals,proposalsreviewedbytheuser,ortheproposalstheuserhas\r\n#yettoreviewdependingonthelinkuserclicksindashboard\r\n@login_required\r\ndefreview_section(request_review,section_slug,assigned=False,reviewed=\"\"):\r\n\r\nifnotrequest_review.user.has_perm(\"\"%section_slug):\r\nreturnrender(request_review,\"\",\"\")\r\n\r\nsection=get_object_or_404(ProposalSection,section__slug=section_slug)\r\nqueryset=ProposalBase.objects.filter(kind__section=section.section)\r\n\r\nifassigned:\r\nassignments=ReviewAssignment.objects.filter(user=request_review.user)\\\r\n.values_list(\"\")\r\nqueryset=queryset.filter(id__in=assignments)\r\n\r\n#passingreviewedinfromreviews.urlsandouttoreview_listfor\r\n#appropriatetemplateheaderrendering\r\nifreviewed==\"\":\r\nqueryset=queryset.select_related(\"\").select_subclasses()\r\nreviewed=\"\"\r\nelifreviewed==\"\":\r\nqueryset=queryset.filter(reviews__user=request_review.user)\r\nreviewed=\"\"\r\nelse:\r\nqueryset=queryset.exclude(reviews__user=request_review.user).exclude(\r\nspeaker__user=request_review.user)\r\nreviewed=\"\"\r\n\r\nproposals=proposals_generator(request_review,queryset)\r\n\r\nctx={\r\n\"\":proposals,\r\n\"\":section,\r\n\"\":reviewed,\r\n}\r\n\r\nreturnrender(request_review,\"\",ctx)\r\n\r\n\r\n@login_required\r\ndefreview_list(request_review_list,section_slug,user_pk):\r\n\r\n#ifthey''tthepersonwhose\r\n#reviewlistisbeingaskedfor,don'tletthemin\r\nifnotrequest_review_list.user.has_perm(\"\"%section_slug):\r\nifnotrequest_review_list.user.pk==user_pk:\r\nreturnrender(request_review_list,\"\",\"\")\r\n\r\nqueryset=ProposalBase.objects.select_related(\"\",\"\")\r\nreviewed=LatestVote.objects.filter(user__pk=user_pk).values_list(\"\",flat=True)\r\nqueryset=queryset.filter(pk__in=reviewed)\r\nproposals=queryset.order_by(\"\")\r\n\r\nadmin=request_review_list.user.has_perm(\"\"%section_slug)\r\n\r\nproposals=proposals_generator(request_review_list,proposals,user_pk=user_pk,check_speaker=notadmin)\r\n\r\nctx={\r\n\"\":proposals,\r\n}\r\nreturnrender(request_review_list,\"\",ctx)\r\n\r\n\r\n@login_required\r\ndefreview_admin(request_review_admin,section_slug):\r\n\r\nifnotrequest_review_admin.user.has_perm(\"\"%section_slug):\r\nreturnrender(request_review_admin,\"\",\"\")\r\n\r\ndefreviewers():\r\nalready_seen=set()\r\n\r\nforteaminTeam.objects.filter(permissions__codename=\"\"%section_slug):\r\nformembershipinteam.memberships.filter(Q(state=\"\")|Q(state=\"\")):\r\nuser=membership.user\r\nifuser.pkinalready_seen:\r\ncontinue\r\nalready_seen.add(user.pk)\r\n\r\nuser.comment_count=Review.objects.filter(user=user).count()\r\nuser.total_votes=LatestVote.objects.filter(user=user).count()\r\nuser.plus_one=LatestVote.objects.filter(\r\nuser=user,\r\nvote=LatestVote.VOTES.PLUS_ONE\r\n).count()\r\nuser.plus_zero=LatestVote.objects.filter(\r\nuser=user,\r\nvote=LatestVote.VOTES.PLUS_ZERO\r\n).count()\r\nuser.minus_zero=LatestVote.objects.filter(\r\nuser=user,\r\nvote=LatestVote.VOTES.MINUS_ZERO\r\n).count()\r\nuser.minus_one=LatestVote.objects.filter(\r\nuser=user,\r\nvote=LatestVote.VOTES.MINUS_ONE\r\n).count()\r\n\r\nyielduser\r\n\r\nctx={\r\n\"\":section_slug,\r\n\"\":reviewers(),\r\n}\r\nreturnrender(request_review_admin,\"\",ctx)\r\n\r\n@login_required\r\ndefreview_detail(request_review_detail,pk):\r\n\r\nproposals=ProposalBase.objects.select_related(\"\").select_subclasses()\r\nproposal=get_object_or_404(proposals,pk=pk)\r\n\r\nifnotrequest_review_detail.user.has_perm(\"\"%proposal.kind.section.slug):\r\nreturnrender(request_review_detail,\"\",\"\")\r\n\r\nspeakers=[s.userforsinproposal.speakers()]\r\n\r\nifnotrequest_review_detail.user.is_superuserandrequest_review_detail.userinspeakers:\r\nreturnrender(request_review_detail,\"\",\"\")\r\n\r\nadmin=request_review_detail.user.is_staff\r\n\r\ntry:\r\nlatest_vote=LatestVote.objects.get(proposal=proposal,user=request_review_detail.user)\r\nexceptLatestVote.DoesNotExist:\r\nlatest_vote=None\r\n\r\nifrequest_review_detail.method==\"\":\r\nifrequest_review_detail.userinspeakers:\r\nreturnrender(request_review_detail,\"\",\"\")\r\n\r\nif\"\"inrequest_review_detail.POST:\r\nreview_form=ReviewForm(request_review_detail.POST)\r\nifreview_form.is_valid():\r\n\r\nreview=review_form.save(commit=False)\r\nreview.user=request_review_detail.user\r\nreview.proposal=proposal\r\nreview.save()\r\n\r\nreturnredirect(request_review_detail.path)\r\nelse:\r\nmessage_form=SpeakerCommentForm()\r\nelif\"\"inrequest_review_detail.POST:\r\nmessage_form=SpeakerCommentForm(request_review_detail.POST)\r\nifmessage_form.is_valid():\r\n\r\nmessage=message_form.save(commit=False)\r\nmessage.user=request_review_detail.user\r\nmessage.proposal=proposal\r\nmessage.save()\r\n\r\nforspeakerinspeakers:\r\nifspeakerandspeaker.email:\r\nctx={\r\n\"\":proposal,\r\n\"\":message,\r\n\"\":False,\r\n}\r\nsend_email(\r\n[speaker.email],\"\",\r\ncontext=ctx\r\n)\r\n\r\nreturnredirect(request_review_detail.path)\r\nelse:\r\ninitial={}\r\niflatest_vote:\r\ninitial[\"\"]=latest_vote.vote\r\nifrequest_review_detail.userinspeakers:\r\nreview_form=None\r\nelse:\r\nreview_form=ReviewForm(initial=initial)\r\nelif\"\"inrequest_review_detail.POST:\r\nifadmin:\r\nresult=request_review_detail.POST[\"\"]\r\n\r\nifresult==\"\":\r\nproposal.result.status=\"\"\r\nproposal.result.save()\r\nelifresult==\"\":\r\nproposal.result.status=\"\"\r\nproposal.result.save()\r\nelifresult==\"\":\r\nproposal.result.status=\"\"\r\nproposal.result.save()\r\nelifresult==\"\":\r\nproposal.result.status=\"\"\r\nproposal.result.save()\r\n\r\nreturnredirect(request_review_detail.path)\r\nelse:\r\ninitial={}\r\niflatest_vote:\r\ninitial[\"\"]=latest_vote.vote\r\nifrequest_review_detail.userinspeakers:\r\nreview_form=None\r\nelse:\r\nreview_form=ReviewForm(initial=initial)\r\nmessage_form=SpeakerCommentForm()\r\n\r\nproposal.comment_count=proposal.result.comment_count\r\nproposal.total_votes=proposal.result.vote_count\r\nproposal.plus_one=proposal.result.plus_one\r\nproposal.plus_zero=proposal.result.plus_zero\r\nproposal.minus_zero=proposal.result.minus_zero\r\nproposal.minus_one=proposal.result.minus_one\r\n\r\nreviews=Review.objects.filter(proposal=proposal).order_by(\"\")\r\nmessages=proposal.messages.order_by(\"\")\r\n\r\nreturnrender(request_review_detail,\"\",{\r\n\"\":proposal,\r\n\"\":latest_vote,\r\n\"\":reviews,\r\n\"\":messages,\r\n\"\":review_form,\r\n\"\":message_form\r\n})\r\n\r\n\r\n@login_required\r\n@require_POST\r\ndefreview_delete(request_delete,pk):\r\nreview=get_object_or_404(Review,pk=pk)\r\nsection_slug=review.section.slug\r\n\r\nifnotrequest_delete.user.has_perm(\"\"%section_slug):\r\nreturnrender(request_delete,\"\",\"\")\r\n\r\nreview=get_object_or_404(Review,pk=pk)\r\nreview.delete()\r\n\r\nreturnredirect(\"\",pk=review.proposal.pk)\r\n\r\n\r\n@login_required\r\ndefreview_status(request_review_status,section_slug=None,key=None):\r\n\r\nifnotrequest_review_status.user.has_perm(\"\"%section_slug):\r\nreturnrender(request_review_status,\"\",\"\")\r\n\r\nVOTE_THRESHOLD=settings.SYMPOSION_VOTE_THRESHOLD\r\n\r\nctx={\r\n\"\":section_slug,\r\n\"\":VOTE_THRESHOLD,\r\n}\r\n\r\nqueryset=ProposalBase.objects.select_related(\"\",\"\").select_subclasses()\r\nifsection_slug:\r\nqueryset=queryset.filter(kind__section__slug=section_slug)\r\n\r\nproposals={\r\n#proposalswithatleastVOTE_THRESHOLDreviewsandatleastone+1andno-1s,sortedby\r\n#the''\r\n\"\":queryset.filter(result__vote_count__gte=VOTE_THRESHOLD,result__plus_one__gt=0,\r\nresult__minus_one=0).order_by(\"\"),\r\n#proposalswithatleastVOTE_THRESHOLDreviewsandatleastone-1andno+1s,reverse\r\n#sortedbythe''\r\n\"\":queryset.filter(result__vote_count__gte=VOTE_THRESHOLD,result__minus_one__gt=0,\r\nresult__plus_one=0).order_by(\"\"),\r\n#proposalswithatleastVOTE_THRESHOLDreviewsandneithera+1ora-1,sortedbytotal\r\n#votes(lowestfirst)\r\n\"\":queryset.filter(result__vote_count__gte=VOTE_THRESHOLD,result__minus_one=0,\r\nresult__plus_one=0).order_by(\"\"),\r\n#proposalswithatleastVOTE_THRESHOLDreviewsandbotha+1and-1,sortedbytotal\r\n#votes(highestfirst)\r\n\"\":queryset.filter(result__vote_count__gte=VOTE_THRESHOLD,\r\nresult__plus_one__gt=0,result__minus_one__gt=0)\r\n.order_by(\"\"),\r\n#proposalswithfewerthanVOTE_THRESHOLDreviews\r\n\"\":queryset.filter(result__vote_count__lt=VOTE_THRESHOLD)\r\n.order_by(\"\"),\r\n}\r\n\r\nadmin=request_review_status.user.has_perm(\"\"%section_slug)\r\n\r\nforstatusinproposals:\r\nifkeyandkey!=status:\r\ncontinue\r\nproposals[status]=list(proposals_generator(request_review_status,proposals[status],check_speaker=notadmin))\r\n\r\nifkey:\r\nctx.update({\r\n\"\":key,\r\n\"\":proposals[key],\r\n})\r\nelse:\r\nctx[\"\"]=proposals\r\n\r\nreturnrender(request_review_status,\"\",ctx)\r\n\r\n\r\n@login_required\r\ndefreview_assignments(request_review_assignments):\r\nifnotrequest_review_assignments.user.groups.filter(name=\"\").exists():\r\nreturnrender(request_review_assignments,\"\",\"\")\r\nassignments=ReviewAssignment.objects.filter(\r\nuser=request_review_assignments.user,\r\nopted_out=False\r\n)\r\nreturnrender(request_review_assignments,\"\",{\r\n\"\":assignments,\r\n})\r\n\r\n\r\n@login_required\r\n@require_POST\r\ndefreview_assignment_opt_out(request_review_assignment_opt_out,pk):\r\nreview_assignment=get_object_or_404(\r\nReviewAssignment,pk=pk,user=request_review_assignment_opt_out.user)\r\nifnotreview_assignment.opted_out:\r\nreview_assignment.opted_out=True\r\nreview_assignment.save()\r\nReviewAssignment.create_assignments(\r\nreview_assignment.proposal,origin=ReviewAssignment.AUTO_ASSIGNED_LATER)\r\nreturnredirect(\"\")\r\n\r\n\r\n@login_required\r\ndefreview_bulk_accept(request_review_bulk_accept,section_slug):\r\nifnotrequest_review_bulk_accept.user.has_perm(\"\"%section_slug):\r\nreturnrender(request_review_bulk_accept,\"\",\"\")\r\nifrequest_review_bulk_accept.method==\"\":\r\nform=BulkPresentationForm(request_review_bulk_accept.POST)\r\nifform.is_valid():\r\ntalk_ids=form.cleaned_data[\"\"].split(\"\")\r\ntalks=ProposalBase.objects.filter(id__in=talk_ids).select_related(\"\")\r\nfortalkintalks:\r\ntalk.result.status=\"\"\r\ntalk.result.save()\r\nreturnredirect(\"\",section_slug=section_slug)\r\nelse:\r\nform=BulkPresentationForm()\r\n\r\nreturnrender(request_review_bulk_accept,\"\",{\r\n\"\":form,\r\n})\r\n\r\n\r\n@login_required\r\ndefresult_notification(request_result_notification,section_slug,status):\r\nifnotrequest_result_notification.user.has_perm(\"\"%section_slug):\r\nreturnrender(request_result_notification,\"\",\"\")\r\n\r\nproposals=ProposalBase.objects.filter(kind__section__slug=section_slug,result__status=status).select_related(\"\",\"\").select_subclasses()\r\nnotification_templates=NotificationTemplate.objects.all()\r\n\r\nctx={\r\n\"\":section_slug,\r\n\"\":status,\r\n\"\":proposals,\r\n\"\":notification_templates,\r\n}\r\nreturnrender(request_result_notification,\"\",ctx)\r\n\r\n\r\n@login_required\r\ndefresult_notification_prepare(request_result_notification_prepare,section_slug,status):\r\nifrequest_result_notification_prepare.method!=\"\":\r\nreturnHttpResponseNotAllowed([\"\"])\r\n\r\nifnotrequest_result_notification_prepare.user.has_perm(\"\"%section_slug):\r\nreturnrender(request_result_notification_prepare,\"\",\"\")\r\n\r\nproposal_pks=[]\r\ntry:\r\nforpkinrequest_result_notification_prepare.POST.getlist(\"\"):\r\nproposal_pks.append(int(pk))\r\nexceptValueError:\r\nreturnHttpResponseBadRequest()\r\nproposals=ProposalBase.objects.filter(\r\nkind__section__slug=section_slug,\r\nresult__status=status,\r\n)\r\nproposals=proposals.filter(pk__in=proposal_pks)\r\nproposals=proposals.select_related(\"\",\"\")\r\nproposals=proposals.select_subclasses()\r\n\r\nnotification_template_pk=request_result_notification_prepare.POST.get(\"\",\"\")\r\nifnotification_template_pk:\r\nnotification_template=NotificationTemplate.objects.get(pk=notification_template_pk)\r\nelse:\r\nnotification_template=None\r\n\r\nctx={\r\n\"\":section_slug,\r\n\"\":status,\r\n\"\":notification_template,\r\n\"\":proposals,\r\n\"\":\"\".join([str(pk)forpkinproposal_pks]),\r\n}\r\nreturnrender(request_result_notification_prepare,\"\",ctx)\r\n\r\ndefaccept_staff_suggestion(staffId):\r\nreturn\r\n\r\n@login_required\r\ndefresult_notification_send(request_result_notification_send,section_slug,status):\r\nifrequest_result_notification_send.method!=\"\":\r\nreturnHttpResponseNotAllowed([\"\"])\r\n\r\nifnotrequest_result_notification_send.user.has_perm(\"\"%section_slug):\r\nreturnrender(request_result_notification_send,\"\",\"\")\r\n\r\nifnotall([kinrequest_result_notification_send.POSTforkin[\"\",\"\",\"\",\"\"]]):\r\nreturnHttpResponseBadRequest()\r\n\r\ntry:\r\nproposal_pks=[int(pk)forpkinrequest_result_notification_send.POST[\"\"].split(\"\")]\r\nexceptValueError:\r\nreturnHttpResponseBadRequest()\r\n\r\nproposals=ProposalBase.objects.filter(\r\nkind__section__slug=section_slug,\r\nresult__status=status,\r\n)\r\nproposals=proposals.filter(pk__in=proposal_pks)\r\nproposals=proposals.select_related(\"\",\"\")\r\nproposals=proposals.select_subclasses()\r\n\r\nnotification_template_pk=request_result_notification_send.POST.get(\"\",\"\")\r\nifnotification_template_pk:\r\nnotification_template=NotificationTemplate.objects.get(pk=notification_template_pk)\r\nelse:\r\nnotification_template=None\r\n\r\nemails=[]\r\n\r\nforproposalinproposals:\r\nrn=ResultNotification()\r\nrn.proposal=proposal\r\nrn.template=notification_template\r\nrn.to_address=proposal.speaker_email\r\nrn.from_address=request_result_notification_send.POST[\"\"]\r\nrn.subject=request_result_notification_send.POST[\"\"]\r\nrn.body=Template(request_result_notification_send.POST[\"\"]).render(\r\nContext({\r\n\"\":proposal.notification_email_context()\r\n})\r\n)\r\nrn.save()\r\nemails.append(rn.email_args)\r\n\r\nsend_mass_mail(emails)\r\n\r\nreturnredirect(\"\",section_slug=section_slug,status=status)\r\n\r\n\r\n\r\n@login_required\r\ndefreview_staff_comment(request_review_staff_comment,section_slug):\r\nifnotrequest_review_staff_comment.user.has_perm(\"\"%section_slug):\r\nreturnrender(request_review_staff_comment,\"\",\"\")\r\nifrequest_review_staff_comment.method==\"\":\r\nform=StaffCommentForm(request_review_staff_comment.POST)\r\n#TODO:completeimplementationofstaffcommentform-splitandmarkaccepted\r\nifform.is_valid():\r\nstaff_ids=": [
    [
      -0.0017745699194863594,
      [
        "form",
        ".",
        "cleaned",
        "_",
        "data",
        ".",
        "get",
        "(",
        "<STR_LIT>",
        ")",
        ".",
        "split",
        "(",
        "\",\"",
        ")",
        "<endofline>"
      ]
    ],
    [
      -0.0020574114770694715,
      [
        "form",
        ".",
        "cleaned",
        "_",
        "data",
        ".",
        "get",
        "list",
        "(",
        "<STR_LIT>",
        ")",
        ".",
        "split",
        "(",
        "\",\"",
        ")",
        "<endofline>"
      ]
    ],
    [
      -0.0021227708538650585,
      [
        "form",
        ".",
        "cleaned",
        "_",
        "data",
        "[",
        "<STR_LIT>",
        "]",
        "<endofline>"
      ]
    ],
    [
      -0.0023508087684951506,
      [
        "json",
        ".",
        "loads",
        "(",
        "form",
        ".",
        "cleaned",
        "_",
        "data",
        ")",
        "[",
        "<STR_LIT>",
        "]",
        "<endofline>"
      ]
    ],
    [
      -0.0026592241477176558,
      [
        "QueryDict",
        "(",
        "request",
        "_",
        "review",
        "_",
        "staff",
        "_",
        "comment",
        ".",
        "get",
        "_",
        "fields",
        "()",
        ",",
        "mutable",
        "=",
        "True",
        ")",
        ".",
        "values",
        "_",
        "list",
        "("
      ]
    ],
    [
      -0.0030011976477142023,
      [
        "request",
        "_",
        "review",
        "_",
        "staff",
        "_",
        "comment",
        ".",
        "get",
        "_",
        "staff",
        "_",
        "ids",
        "()",
        "<endofline>"
      ]
    ],
    [
      -0.003581097126154647,
      [
        "QueryDict",
        "(",
        "request",
        "_",
        "review",
        "_",
        "staff",
        "_",
        "comment",
        ".",
        "get",
        "_",
        "fields",
        "()",
        ",",
        "mutable",
        "=",
        "True",
        ")",
        ".",
        "values",
        "(",
        "<STR_LIT>",
        ")"
      ]
    ],
    [
      -0.003639467385947811,
      [
        "Staff",
        ".",
        "objects",
        ".",
        "filter",
        "(",
        "pk",
        "_",
        "_",
        "in",
        "=",
        "request",
        "_",
        "review",
        "_",
        "staff",
        "_",
        "comment",
        ".",
        "user",
        ".",
        "pk",
        ")",
        "."
      ]
    ],
    [
      -0.0036770999353835216,
      [
        " form",
        ".",
        "cleaned",
        "_",
        "data",
        "[",
        "<STR_LIT>",
        "]",
        "<endofline>"
      ]
    ],
    [
      -0.003771658061630473,
      [
        "list",
        "(",
        "form",
        ".",
        "cleaned",
        "_",
        "data",
        "[",
        "<STR_LIT>",
        "])",
        "<endofline>"
      ]
    ],
    [
      -0.004698189077616344,
      [
        "list",
        "<unk>",
        "staff",
        "_",
        "ids",
        "<endofline>"
      ]
    ],
    [
      -0.0048598197845077665,
      [
        "get",
        "_",
        "staff",
        "_",
        "ids",
        "()",
        "<endofline>"
      ]
    ],
    [
      -0.004991104084244179,
      [
        "form",
        ".",
        "cleaned",
        "_",
        "data",
        ".",
        "get",
        "list",
        "(",
        "<STR_LIT>",
        ")",
        "<endofline>"
      ]
    ],
    [
      -0.0051836193045015294,
      [
        "form",
        ".",
        "cleaned",
        "_",
        "data",
        "[",
        "<STR_LIT>",
        "]",
        "<endofline>"
      ]
    ],
    [
      -0.005912721416895136,
      [
        "Staff",
        ".",
        "objects",
        ".",
        "filter",
        "(",
        "pk",
        "_",
        "_",
        "in",
        "=",
        "request",
        "_",
        "review",
        "_",
        "staff",
        "_",
        "comment",
        ".",
        "pk",
        ")",
        ".",
        "values",
        "("
      ]
    ]
  ]
}